# Sumaidia チャットボット開発記録
**作成日**: 2025年1月23日
**プロジェクト**: スマイディア AIチャットボット（スマイちゃん）

## 開発概要
株式会社スマイディアのAIチャットボット「スマイちゃん」の改善開発。OpenAI API（ChatGPT）と連携し、印刷・Web制作・採用支援などの相談に対応するチャットボットシステム。

## 主な改善実施内容

### 1. アバター表情システム（30パターン）
- **実装ファイル**: `/src/utils/emotion-mapper.mjs`, `/src/utils/expression-diversifier.mjs`
- **機能**: 30種類の表情パターンを文脈に応じて自動選択
- **問題解決**: アバターが表示されない問題を修正、表情の多様性を向上

### 2. 応答速度の最適化
- **実装ファイル**: `/src/utils/enhanced-quick-response.mjs`, `/src/utils/response-optimizer.mjs`
- **機能**: 
  - 単純な質問には即座に応答（0-50ms）
  - キャッシュ機能（5分間保持）
  - トークン数最適化（60-200トークン）
- **問題解決**: 504 Gateway Timeoutエラーの削減

### 3. 会話フロー管理
- **実装ファイル**: 
  - `/src/utils/printing-flow.mjs` - 印刷サービス専用フロー
  - `/src/utils/ec-site-flow.mjs` - ECサイト相談専用フロー
  - `/src/utils/conversation-memory.mjs` - 会話記憶管理
- **機能**: サービスごとの専用会話フロー、文脈維持、セッション管理
- **問題解決**: 名刺の話なのにWebサイトの話になる問題を解決

### 4. クイックアクションボタン
- **実装ファイル**: `/src/utils/quick-actions.mjs`
- **機能**: 文脈に応じた選択肢ボタンの自動生成
- **選択肢例**:
  - 初回挨拶後：[印刷・製造加工][Web・デジタル制作][採用支援][広告・ブランディング]
  - 名刺相談時：[100枚][500枚][1000枚][相談したい]
  - 納期確認：[1週間以内][2週間くらい][1ヶ月以内][急ぎじゃない]

### 5. 質問制限機能
- **実装ファイル**: `/src/utils/question-limiter.mjs`
- **機能**: 複数質問を自動検出して単一質問に修正
- **問題解決**: 「何枚？いつまで？デザインは？」→「何枚必要？」に自動変換

### 6. システムプロンプト改善
- **実装ファイル**: `/src/prompt/build-system-prompt.mjs`
- **スマイちゃんの人格設定**:
  - 18歳のギャル系AIアシスタント
  - 明るく元気でフレンドリー
  - 「はろー！」は初回挨拶のみ
  - 質問は必ず1つずつ
  - 「詳しくは直接お問い合わせして」は絶対禁止

## 技術スタック
- **Backend**: Netlify Functions (Node.js)
- **Frontend**: HTML, JavaScript, Three.js
- **API**: OpenAI Responses API (gpt-4)
- **モジュール**: ESM (ECMAScript Modules)

## 主要ファイル構成
```
/sumaidia/
├── netlify/
│   └── functions/
│       └── chat.js                 # メインAPIエンドポイント
├── src/
│   ├── utils/
│   │   ├── emotion-mapper.mjs      # 感情マッピング
│   │   ├── expression-diversifier.mjs # 表情多様化
│   │   ├── enhanced-quick-response.mjs # 高速応答
│   │   ├── response-optimizer.mjs  # 応答最適化
│   │   ├── conversation-memory.mjs # 会話記憶
│   │   ├── printing-flow.mjs       # 印刷フロー
│   │   ├── ec-site-flow.mjs        # ECサイトフロー
│   │   ├── quick-actions.mjs       # クイックアクション
│   │   ├── question-limiter.mjs    # 質問制限
│   │   └── response-validator.mjs  # 応答検証
│   ├── prompt/
│   │   └── build-system-prompt.mjs # システムプロンプト
│   └── knowledge/
│       └── ec-site-pricing.mjs     # ECサイト価格情報
└── index.html                      # フロントエンド

```

## 残存する課題と今後の改善案

### 1. 504エラーの完全解決
- 現状：8秒タイムアウト設定で軽減
- 改善案：エッジファンクションへの移行、ストリーミング応答の実装

### 2. 会話の文脈維持
- 現状：セッション管理で基本的な文脈は維持
- 改善案：より高度な文脈理解、長期記憶の実装

### 3. クイックアクションの拡充
- 現状：基本的な選択肢を提供
- 改善案：動的な選択肢生成、学習による最適化

### 4. 表情パターンの活用
- 現状：30種類準備済みだが使用頻度に偏り
- 改善案：感情分析の精度向上、表情遷移のスムーズ化

## 価格設定情報

### 印刷サービス
- **名刺**: 100枚3,000円〜、500枚8,000円〜、1000枚12,000円〜
- **デザイン料**: テンプレート無料、セミオーダー+5,000円〜、フルオーダー+15,000円〜
- **チラシ**: A4/1000枚5,000円〜、5000枚15,000円〜
- **ポスター**: A2/10枚15,000円〜

### ECサイト制作
- **ベーシック**: 50-100万円（商品50点まで、1-2ヶ月）
- **スタンダード**: 100-200万円（商品500点、会員機能、2-3ヶ月）
- **プロフェッショナル**: 300-500万円（無制限、AI推奨、3-6ヶ月）
- **エンタープライズ**: 500万円〜（フルカスタマイズ、6ヶ月〜）

## 環境変数
```
OPENAI_API_KEY=（設定済み）
ENABLE_SMAICHAN=true
```

## テスト環境
- **URL**: https://cute-frangipane-efe657.netlify.app/
- **ローカル開発**: netlify dev

## 今回の開発で解決した主な問題

1. ✅ アバターが表示されない問題
2. ✅ 単純な質問でも応答が遅い（3秒→50ms）
3. ✅ 会話が成立しない（文脈喪失）
4. ✅ 同じ情報を何度も聞く
5. ✅ 複数質問を一度にする
6. ✅ 「詳しくは直接お問い合わせして」という無責任な返答
7. ✅ 毎回「はろー」と言う不自然さ
8. ✅ 504 Gateway Timeoutエラー
9. ✅ 名刺の話なのにWebサイトの価格を返答
10. ✅ 選択肢ボタンが表示されない

## 次回開発再開時の注意点

1. **chat.js**のデバッグログが有効になっているので、本番環境では削除推奨
2. **question-limiter.mjs**は強制的に質問を1つに制限するので、必要に応じて調整
3. **印刷フローとECサイトフロー**は独立して動作するため、他のサービス追加時は同様の実装が必要
4. **クイックアクション**の選択肢は固定値なので、動的生成への移行を検討

## コンタクト
- プロジェクト: 株式会社スマイディア
- 開発期間: 2025年1月22日〜23日
- 主要改善: チャットボット応答品質向上、UI/UX改善