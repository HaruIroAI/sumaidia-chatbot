<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマイディア チャットボット - Smaichan (ハイブリッド版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .smaichan-avatar {
            transition: all 0.3s ease;
        }
        /* アバター表情のクラス */
        .smaichan-avatar-happy { filter: brightness(1.1); }
        .smaichan-avatar-thinking { filter: hue-rotate(15deg) brightness(0.95); transform: rotate(-5deg); }
        .smaichan-avatar-excited { filter: brightness(1.2) saturate(1.2); animation: excitedBounce 0.5s; }
        .smaichan-avatar-confused { filter: hue-rotate(-10deg) brightness(0.9); }
        .smaichan-avatar-wink { filter: hue-rotate(10deg); animation: wink 0.5s; }
        
        @keyframes excitedBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes wink {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }
        
        .mode-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .mode-switch {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }
        
        .mode-switch:hover {
            transform: scale(1.05);
        }
        
        .api-key-input {
            transition: all 0.3s;
            max-height: 0;
            overflow: hidden;
        }
        
        .api-key-input.show {
            max-height: 100px;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-pink-500 via-pink-400 to-pink-300 p-6 text-white relative">
                <h1 class="text-3xl font-bold">スマイディア AIアシスタント</h1>
                <p class="mt-2">スマイちゃんが印刷のご相談をお手伝いします！💕</p>
                <div class="mode-indicator" id="modeIndicator">
                    <span id="modeText">オフラインモード</span>
                </div>
            </div>
            
            <!-- モード切り替えセクション -->
            <div class="p-4 bg-gray-100 border-b">
                <div class="flex items-center justify-between">
                    <div class="flex gap-4">
                        <button id="offlineMode" class="mode-switch bg-pink-500 text-white">
                            🔌 オフラインモード
                        </button>
                        <button id="onlineMode" class="mode-switch bg-gray-300 text-gray-700">
                            🌐 ChatGPT モード
                        </button>
                    </div>
                    <button id="settingsBtn" class="text-gray-600 hover:text-gray-800">
                        ⚙️ 設定
                    </button>
                </div>
                
                <!-- API設定エリア -->
                <div id="apiKeyInput" class="api-key-input">
                    <div class="mt-4 p-4 bg-white rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ChatGPT API Key:
                        </label>
                        <input 
                            type="password" 
                            id="apiKey" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400"
                            placeholder="sk-..."
                        >
                        <p class="mt-2 text-xs text-gray-500">
                            APIキーは暗号化してローカルストレージに保存されます
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="h-96 overflow-y-auto mb-4 border rounded-lg p-4" id="messagesContainer">
                    <div class="flex justify-start message-slide-in">
                        <div class="flex items-start space-x-2">
                            <div class="w-8 h-8 rounded-full overflow-hidden bg-pink-400 flex-shrink-0">
                                <img src="./logo/smaichan.png" alt="スマイちゃん" class="smaichan-avatar" id="avatarImg">
                            </div>
                            <div class="max-w-xs px-4 py-2 rounded-lg bg-white border border-gray-200">
                                はろー！スマイちゃんだよ〜✨ 印刷のこと何でも聞いて！
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="chatForm" class="flex gap-2">
                    <input 
                        type="text" 
                        id="userInput" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400"
                        placeholder="メッセージを入力..."
                        autocomplete="off"
                    >
                    <button 
                        type="submit" 
                        class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors"
                    >
                        送信
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 外部JavaScript読み込み -->
    <script src="conversation-patterns.js"></script>
    <script src="company-knowledge-base.js"></script>
    
    <script>
        // モード管理
        let currentMode = 'offline';
        let apiKey = localStorage.getItem('smaichan_api_key') || '';
        
        // DOM要素
        const modeIndicator = document.getElementById('modeIndicator');
        const modeText = document.getElementById('modeText');
        const offlineBtn = document.getElementById('offlineMode');
        const onlineBtn = document.getElementById('onlineMode');
        const settingsBtn = document.getElementById('settingsBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeyField = document.getElementById('apiKey');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const avatarImg = document.getElementById('avatarImg');
        
        // APIキーがあれば復元
        if (apiKey) {
            apiKeyField.value = apiKey;
        }
        
        // モード切り替え
        offlineBtn.addEventListener('click', () => {
            currentMode = 'offline';
            updateModeUI();
        });
        
        onlineBtn.addEventListener('click', () => {
            if (!apiKey) {
                alert('ChatGPT モードを使用するにはAPIキーの設定が必要です');
                apiKeyInput.classList.add('show');
                return;
            }
            currentMode = 'online';
            updateModeUI();
        });
        
        // 設定ボタン
        settingsBtn.addEventListener('click', () => {
            apiKeyInput.classList.toggle('show');
        });
        
        // APIキー保存
        apiKeyField.addEventListener('change', (e) => {
            apiKey = e.target.value;
            localStorage.setItem('smaichan_api_key', apiKey);
        });
        
        // UI更新
        function updateModeUI() {
            if (currentMode === 'offline') {
                offlineBtn.className = 'mode-switch bg-pink-500 text-white';
                onlineBtn.className = 'mode-switch bg-gray-300 text-gray-700';
                modeText.textContent = 'オフラインモード';
                modeIndicator.style.background = 'rgba(236, 72, 153, 0.8)';
            } else {
                offlineBtn.className = 'mode-switch bg-gray-300 text-gray-700';
                onlineBtn.className = 'mode-switch bg-green-500 text-white';
                modeText.textContent = 'ChatGPT モード';
                modeIndicator.style.background = 'rgba(34, 197, 94, 0.8)';
            }
        }
        
        // メッセージ追加
        function addMessage(content, isUser = false, expression = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-slide-in`;
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="max-w-xs px-4 py-2 rounded-lg bg-pink-500 text-white">
                        ${content}
                    </div>
                `;
            } else {
                // 表情変更
                changeAvatar(expression);
                
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden bg-pink-400 flex-shrink-0">
                            <img src="./logo/smaichan_${expression}.png" alt="スマイちゃん" class="smaichan-avatar smaichan-avatar-${expression}">
                        </div>
                        <div class="max-w-xs px-4 py-2 rounded-lg bg-white border border-gray-200">
                            ${content}
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // アバター表情変更
        function changeAvatar(expression) {
            const validExpressions = ['normal', 'happy', 'thinking', 'confused', 'wink', 'excited'];
            if (!validExpressions.includes(expression)) {
                expression = 'normal';
            }
            
            avatarImg.src = `./logo/smaichan${expression === 'normal' ? '' : '_' + expression}.png`;
            avatarImg.className = `smaichan-avatar smaichan-avatar-${expression}`;
        }
        
        // 感情検出
        function detectEmotion(response) {
            if (response.includes('嬉しい') || response.includes('✨') || response.includes('オッケー')) {
                return 'happy';
            } else if (response.includes('考え') || response.includes('うーん')) {
                return 'thinking';
            } else if (response.includes('困った') || response.includes('ごめん')) {
                return 'confused';
            } else if (response.includes('💕') || response.includes('かわいい')) {
                return 'wink';
            } else if (response.includes('すごい') || response.includes('！！')) {
                return 'excited';
            }
            return 'normal';
        }
        
        // オフライン応答生成（既存のロジック）
        function generateOfflineResponse(message) {
            // conversation-patterns.js のロジックを使用
            if (typeof window.generateResponse === 'function') {
                return window.generateResponse(message);
            }
            
            // フォールバック
            return 'ごめんね〜！ちょっとよくわからなかった💦';
        }
        
        // ChatGPT API応答生成
        async function generateOnlineResponse(message) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `あなたは「スマイちゃん」という18歳のギャル系AIアシスタントです。
スマイディア（SUMAIDIA）という印刷会社で働いています。
特徴：
- 明るくフレンドリーな性格
- 語尾に「〜」「✨」「💕」をよく使う
- 「はろー」「オッケー」などカジュアルな言葉遣い
- 印刷サービスの相談に親身に対応
- 名刺は100枚3,000円〜、チラシは1,000枚5,000円〜など具体的な価格を提示

会社情報：
${JSON.stringify(window.companyKnowledge || {}, null, 2)}`
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('ChatGPT API Error:', error);
                // エラー時はオフラインモードにフォールバック
                return generateOfflineResponse(message);
            }
        }
        
        // メッセージ送信処理
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;
            
            addMessage(message, true);
            userInput.value = '';
            
            // タイピング表示
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full overflow-hidden bg-pink-400 flex-shrink-0">
                        <img src="./logo/smaichan_thinking.png" alt="スマイちゃん" class="smaichan-avatar smaichan-avatar-thinking">
                    </div>
                    <div class="max-w-xs px-4 py-2 rounded-lg bg-gray-100">
                        <span class="typing-indicator">入力中...</span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            
            let response;
            if (currentMode === 'offline') {
                // オフラインモード
                await new Promise(resolve => setTimeout(resolve, 1000));
                response = generateOfflineResponse(message);
            } else {
                // オンラインモード（ChatGPT API）
                response = await generateOnlineResponse(message);
            }
            
            typingDiv.remove();
            const emotion = detectEmotion(response);
            addMessage(response, false, emotion);
        });
    </script>
</body>
</html>