<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ - Smaichan (ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .smaichan-avatar {
            transition: all 0.3s ease;
        }
        /* ã‚¢ãƒã‚¿ãƒ¼è¡¨æƒ…ã®ã‚¯ãƒ©ã‚¹ */
        .smaichan-avatar-happy { filter: brightness(1.1); }
        .smaichan-avatar-thinking { filter: hue-rotate(15deg) brightness(0.95); transform: rotate(-5deg); }
        .smaichan-avatar-excited { filter: brightness(1.2) saturate(1.2); animation: excitedBounce 0.5s; }
        .smaichan-avatar-confused { filter: hue-rotate(-10deg) brightness(0.9); }
        .smaichan-avatar-wink { filter: hue-rotate(10deg); animation: wink 0.5s; }
        
        @keyframes excitedBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes wink {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }
        
        .mode-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .mode-switch {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }
        
        .mode-switch:hover {
            transform: scale(1.05);
        }
        
        .api-key-input {
            transition: all 0.3s;
            max-height: 0;
            overflow: hidden;
        }
        
        .api-key-input.show {
            max-height: 100px;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-pink-500 via-pink-400 to-pink-300 p-6 text-white relative">
                <h1 class="text-3xl font-bold">ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
                <p class="mt-2">ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ãŒå°åˆ·ã®ã”ç›¸è«‡ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ï¼ğŸ’•</p>
                <div class="mode-indicator" id="modeIndicator">
                    <span id="modeText">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰</span>
                </div>
            </div>
            
            <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="p-4 bg-gray-100 border-b">
                <div class="flex items-center justify-between">
                    <div class="flex gap-4">
                        <button id="offlineMode" class="mode-switch bg-pink-500 text-white">
                            ğŸ”Œ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰
                        </button>
                        <button id="onlineMode" class="mode-switch bg-gray-300 text-gray-700">
                            ğŸŒ ChatGPT ãƒ¢ãƒ¼ãƒ‰
                        </button>
                    </div>
                    <button id="settingsBtn" class="text-gray-600 hover:text-gray-800">
                        âš™ï¸ è¨­å®š
                    </button>
                </div>
                
                <!-- APIè¨­å®šã‚¨ãƒªã‚¢ -->
                <div id="apiKeyInput" class="api-key-input">
                    <div class="mt-4 p-4 bg-white rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ChatGPT API Key:
                        </label>
                        <input 
                            type="password" 
                            id="apiKey" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400"
                            placeholder="sk-..."
                        >
                        <p class="mt-2 text-xs text-gray-500">
                            APIã‚­ãƒ¼ã¯æš—å·åŒ–ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="h-96 overflow-y-auto mb-4 border rounded-lg p-4" id="messagesContainer">
                    <div class="flex justify-start message-slide-in">
                        <div class="flex items-start space-x-2">
                            <div class="w-8 h-8 rounded-full overflow-hidden bg-pink-400 flex-shrink-0">
                                <img src="./logo/smaichan.png" alt="ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“" class="smaichan-avatar" id="avatarImg">
                            </div>
                            <div class="max-w-xs px-4 py-2 rounded-lg bg-white border border-gray-200">
                                ã¯ã‚ãƒ¼ï¼ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ã ã‚ˆã€œâœ¨ å°åˆ·ã®ã“ã¨ä½•ã§ã‚‚èã„ã¦ï¼
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="chatForm" class="flex gap-2">
                    <input 
                        type="text" 
                        id="userInput" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400"
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                        autocomplete="off"
                    >
                    <button 
                        type="submit" 
                        class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors"
                    >
                        é€ä¿¡
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- å¤–éƒ¨JavaScriptèª­ã¿è¾¼ã¿ -->
    <script src="conversation-patterns.js"></script>
    <script src="company-knowledge-base.js"></script>
    
    <script>
        // ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        let currentMode = 'offline';
        let apiKey = localStorage.getItem('smaichan_api_key') || '';
        
        // DOMè¦ç´ 
        const modeIndicator = document.getElementById('modeIndicator');
        const modeText = document.getElementById('modeText');
        const offlineBtn = document.getElementById('offlineMode');
        const onlineBtn = document.getElementById('onlineMode');
        const settingsBtn = document.getElementById('settingsBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeyField = document.getElementById('apiKey');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const avatarImg = document.getElementById('avatarImg');
        
        // APIã‚­ãƒ¼ãŒã‚ã‚Œã°å¾©å…ƒ
        if (apiKey) {
            apiKeyField.value = apiKey;
        }
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        offlineBtn.addEventListener('click', () => {
            currentMode = 'offline';
            updateModeUI();
        });
        
        onlineBtn.addEventListener('click', () => {
            if (!apiKey) {
                alert('ChatGPT ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™');
                apiKeyInput.classList.add('show');
                return;
            }
            currentMode = 'online';
            updateModeUI();
        });
        
        // è¨­å®šãƒœã‚¿ãƒ³
        settingsBtn.addEventListener('click', () => {
            apiKeyInput.classList.toggle('show');
        });
        
        // APIã‚­ãƒ¼ä¿å­˜
        apiKeyField.addEventListener('change', (e) => {
            apiKey = e.target.value;
            localStorage.setItem('smaichan_api_key', apiKey);
        });
        
        // UIæ›´æ–°
        function updateModeUI() {
            if (currentMode === 'offline') {
                offlineBtn.className = 'mode-switch bg-pink-500 text-white';
                onlineBtn.className = 'mode-switch bg-gray-300 text-gray-700';
                modeText.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰';
                modeIndicator.style.background = 'rgba(236, 72, 153, 0.8)';
            } else {
                offlineBtn.className = 'mode-switch bg-gray-300 text-gray-700';
                onlineBtn.className = 'mode-switch bg-green-500 text-white';
                modeText.textContent = 'ChatGPT ãƒ¢ãƒ¼ãƒ‰';
                modeIndicator.style.background = 'rgba(34, 197, 94, 0.8)';
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addMessage(content, isUser = false, expression = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-slide-in`;
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="max-w-xs px-4 py-2 rounded-lg bg-pink-500 text-white">
                        ${content}
                    </div>
                `;
            } else {
                // è¡¨æƒ…å¤‰æ›´
                changeAvatar(expression);
                
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden bg-pink-400 flex-shrink-0">
                            <img src="./logo/smaichan_${expression}.png" alt="ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“" class="smaichan-avatar smaichan-avatar-${expression}">
                        </div>
                        <div class="max-w-xs px-4 py-2 rounded-lg bg-white border border-gray-200">
                            ${content}
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ã‚¢ãƒã‚¿ãƒ¼è¡¨æƒ…å¤‰æ›´
        function changeAvatar(expression) {
            const validExpressions = ['normal', 'happy', 'thinking', 'confused', 'wink', 'excited'];
            if (!validExpressions.includes(expression)) {
                expression = 'normal';
            }
            
            avatarImg.src = `./logo/smaichan${expression === 'normal' ? '' : '_' + expression}.png`;
            avatarImg.className = `smaichan-avatar smaichan-avatar-${expression}`;
        }
        
        // æ„Ÿæƒ…æ¤œå‡º
        function detectEmotion(response) {
            if (response.includes('å¬‰ã—ã„') || response.includes('âœ¨') || response.includes('ã‚ªãƒƒã‚±ãƒ¼')) {
                return 'happy';
            } else if (response.includes('è€ƒãˆ') || response.includes('ã†ãƒ¼ã‚“')) {
                return 'thinking';
            } else if (response.includes('å›°ã£ãŸ') || response.includes('ã”ã‚ã‚“')) {
                return 'confused';
            } else if (response.includes('ğŸ’•') || response.includes('ã‹ã‚ã„ã„')) {
                return 'wink';
            } else if (response.includes('ã™ã”ã„') || response.includes('ï¼ï¼')) {
                return 'excited';
            }
            return 'normal';
        }
        
        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¿œç­”ç”Ÿæˆï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        function generateOfflineResponse(message) {
            // conversation-patterns.js ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
            if (typeof window.generateResponse === 'function') {
                return window.generateResponse(message);
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            return 'ã”ã‚ã‚“ã­ã€œï¼ã¡ã‚‡ã£ã¨ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸğŸ’¦';
        }
        
        // ChatGPT APIå¿œç­”ç”Ÿæˆ
        async function generateOnlineResponse(message) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `ã‚ãªãŸã¯ã€Œã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ã€ã¨ã„ã†18æ­³ã®ã‚®ãƒ£ãƒ«ç³»AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ï¼ˆSUMAIDIAï¼‰ã¨ã„ã†å°åˆ·ä¼šç¤¾ã§åƒã„ã¦ã„ã¾ã™ã€‚
ç‰¹å¾´ï¼š
- æ˜ã‚‹ããƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ€§æ ¼
- èªå°¾ã«ã€Œã€œã€ã€Œâœ¨ã€ã€ŒğŸ’•ã€ã‚’ã‚ˆãä½¿ã†
- ã€Œã¯ã‚ãƒ¼ã€ã€Œã‚ªãƒƒã‚±ãƒ¼ã€ãªã©ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªè¨€è‘‰é£ã„
- å°åˆ·ã‚µãƒ¼ãƒ“ã‚¹ã®ç›¸è«‡ã«è¦ªèº«ã«å¯¾å¿œ
- ååˆºã¯100æš3,000å††ã€œã€ãƒãƒ©ã‚·ã¯1,000æš5,000å††ã€œãªã©å…·ä½“çš„ãªä¾¡æ ¼ã‚’æç¤º

ä¼šç¤¾æƒ…å ±ï¼š
${JSON.stringify(window.companyKnowledge || {}, null, 2)}`
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('ChatGPT API Error:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                return generateOfflineResponse(message);
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;
            
            addMessage(message, true);
            userInput.value = '';
            
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°è¡¨ç¤º
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full overflow-hidden bg-pink-400 flex-shrink-0">
                        <img src="./logo/smaichan_thinking.png" alt="ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“" class="smaichan-avatar smaichan-avatar-thinking">
                    </div>
                    <div class="max-w-xs px-4 py-2 rounded-lg bg-gray-100">
                        <span class="typing-indicator">å…¥åŠ›ä¸­...</span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            
            let response;
            if (currentMode === 'offline') {
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰
                await new Promise(resolve => setTimeout(resolve, 1000));
                response = generateOfflineResponse(message);
            } else {
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼ˆChatGPT APIï¼‰
                response = await generateOnlineResponse(message);
            }
            
            typingDiv.remove();
            const emotion = detectEmotion(response);
            addMessage(response, false, emotion);
        });
    </script>
</body>
</html>