name: Codex Review (Self-hosted)

# Trigger: repository_dispatch event from codex-auto-trigger.yml or manual
on:
  repository_dispatch:
    types: [codex-review-requested]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to review'
        required: false
        default: '49'

permissions:
  issues: write
  contents: read

jobs:
  run-codex-review:
    # Runs on self-hosted runner (kamiko's Mac)
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Set issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "url=https://github.com/${{ github.repository }}/issues/${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.client_payload.issue_number }}" >> $GITHUB_OUTPUT
            echo "url=${{ github.event.client_payload.issue_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Display review request info
        run: |
          echo "=== Codex Review Request ==="
          echo "Issue: #${{ steps.issue.outputs.number }}"
          echo "Task ID: ${{ github.event.client_payload.task_id }}"
          echo "Repo: ${{ github.repository }}"
          echo "URL: ${{ steps.issue.outputs.url }}"
          echo "=========================="

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          # Ensure we're using the correct environment
          export PATH="$HOME/.local/bin:$PATH"

          # Check Codex availability
          if command -v codex &> /dev/null; then
            echo "âœ… Codex CLI is available"
            codex --version || true
          else
            echo "âŒ Codex CLI not found"
            echo "Please install Codex: npm install -g @openai/codex-cli"
            exit 1
          fi

      - name: Run Codex review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
          ISSUE_URL: ${{ steps.issue.outputs.url }}
          REPO: ${{ github.repository }}
        run: |
          echo "Starting Codex review for Issue #$ISSUE_NUMBER..."
          PROJECT_DIR="$HOME/kamiko-independence"

          if [[ -f "$PROJECT_DIR/.auto-dev/scripts/codex-start.sh" ]]; then
            cd "$PROJECT_DIR"
            bash .auto-dev/scripts/codex-start.sh --review-only
          else
            echo "Using fallback: direct Codex invocation"
            cd "$PROJECT_DIR"
            PROMPT="Review GitHub Issue at ${ISSUE_URL}. Focus on code quality, security, and performance."
            codex exec --full-auto "$PROMPT" || echo "Codex execution completed"
          fi

      - name: Post completion notification
        if: always()
        uses: actions/github-script@v7
        env:
          TASK_ID: ${{ github.event.client_payload.task_id }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const status = '${{ job.status }}';
            const taskId = process.env.TASK_ID;
            const workflowUrl = process.env.WORKFLOW_URL;

            let body;
            if (status === 'success') {
              body = [
                "## âœ… Codex Review Completed",
                "",
                "The automated review has been completed by the self-hosted runner.",
                "",
                "**Details**:",
                "- Task ID: " + taskId,
                "- Runner: Self-hosted",
                "- Status: Success",
                "",
                "Please check the review comments above.",
                "",
                "---",
                "_Powered by Auto-Dev System_"
              ].join("\n");
            } else {
              body = [
                "## âš ï¸ Codex Review Status",
                "",
                "The automated review job has finished with status: **" + status + "**",
                "",
                "**Details**:",
                "- Task ID: " + taskId,
                "- Runner: Self-hosted",
                "- Status: " + status,
                "",
                "Please check the [workflow run](" + workflowUrl + ") for details.",
                "",
                "---",
                "_Powered by Auto-Dev System_"
              ].join("\n");
            }

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
            } catch (error) {
              console.log('Could not post comment:', error.message);
            }

      - name: Summary
        run: |
          echo "## ðŸ¤– Codex Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue**: #${{ steps.issue.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Task ID**: ${{ github.event.client_payload.task_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
