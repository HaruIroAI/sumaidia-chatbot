# Expression Tuning Guide (表情調整ガイド)

このガイドは、エンジニアでない方でも表情システムを調整できるよう、わかりやすく解説したものです。

## 📊 パラメータの影響

### 1. when（キーワード配列）
**何を増やすと**: その表情が選ばれやすくなります
- 1キーワードマッチごとに **+10点**
- 例: `"when": ["嬉しい", "やった", "最高"]`
- 💡 **ヒント**: 類義語や口語表現を追加すると認識率UP

### 2. patterns（正規表現配列）
**何を増やすと**: より柔軟なマッチングが可能に
- 1パターンマッチごとに **+15点**
- 例: `"patterns": ["ありがと(う|ー|!)+"]` → 「ありがとう」「ありがとー！」にマッチ
- ⚠️ **注意**: 正規表現は強力ですが、広すぎると誤検知の原因に

### 3. priority（優先度）
**何を増やすと**: 同点時に優先的に選ばれます
- デフォルト: 50
- 高優先: 80-90
- 低優先: 30-40
- 💡 **使い方**: 「grateful」と「happy」が同点なら、priorityが高い方を採用

### 4. threshold（閾値）
**何を増やすと**: その表情が選ばれにくくなります
- デフォルト: 12点
- 厳しい判定: 15-20点（確信度が高い時のみ）
- 緩い判定: 8-10点（頻繁に出現）
- 💡 **調整例**: 「angry」は誤検知を避けるため高めに設定

### 5. cooldown（クールダウン）
**何を増やすと**: 表情が長く維持されます
- デフォルト: 1800ms（1.8秒）
- 長め: 2000-3000ms（落ち着いた変化）
- 短め: 1000-1500ms（活発な変化）
- 💡 **効果**: 表情がパカパカ切り替わるのを防ぐ

### 6. group（グループ）
**設定すると**: 同じグループ内での切り替えがスムーズに
- `"positive"`: 喜び系（happy, excited, grateful）
- `"negative"`: ネガティブ系（sad, angry, confused）
- `"neutral"`: 中立系（thinking, focused）
- 💡 **効果**: グループ内は15点差、グループ間は8点差で切り替え

## 🎯 スコアリングの仕組み

### 基本スコア計算
```
総スコア = 
  + キーワード数 × 10
  + パターンマッチ数 × 15
  + 感嘆符の数 × 3（最大9）
  + 疑問符の数 × 3（最大9）
  + 絵文字・顔文字 × 8
  + コンテキスト一致 × 6
  + 感情語彙 × 6
  + 前回と同グループ × 4
  - 否定語ペナルティ × 8
```

### 特別ボーナス（エッジケース）
- 「わからない」「どゆこと」→ confused +12
- 「ありがとう」「助かる」→ grateful/happy +12

## 🔄 競合解決の考え方

### 1. ヒステリシス（履歴効果）
現在の表情は「慣性」を持ちます：
- **クールダウン期間中**: 現在の表情を維持しやすい
- **同グループ内**: 15点以上の差がないと切り替わらない
- **異グループ間**: 8点以上の差で切り替え可能

### 例：happy（スコア20）→ excited（スコア25）
- 同じpositiveグループ → 差は5点 → **維持**（15点差が必要）

### 2. 大差判定
```javascript
if (新候補スコア - 現在スコア >= 8) {
  // 異なるグループなら切り替え
} else if (新候補スコア - 現在スコア >= 15) {
  // 同じグループでも切り替え
}
```

## 🐛 よくある誤検知と対策

### 1. 否定語の処理
**問題**: 「嬉しくない」→ happy が選ばれる
**対策**: 否定語検出で-8点ペナルティ
```json
{
  "id": "happy",
  "group": "positive"  // 否定語があるとペナルティ
}
```

### 2. 連続記号の処理
**問題**: 「！！！！！」で異常に高スコア
**対策**: 上限設定（最大+9点）
```javascript
Math.min(感嘆符の数 * 3, 9)  // 最大3個分まで
```

### 3. 汎用キーワードの扱い
**問題**: 「です」「ます」で誤検知
**対策**: 
- 一般的すぎる語は避ける
- より具体的なパターンを使用

## 🧪 QA手順

### 1. Expression Testerを開く
```bash
open tools/expression-tester.html
# または
https://[your-domain]/tools/expression-tester.html
```

### 2. 基本テストケース
以下のテキストで期待される表情を確認：

| テキスト | 期待表情 | 理由 |
|---------|---------|------|
| ありがとうございます！ | grateful/happy | 感謝表現 |
| よくわからないです... | confused | 混乱表現 |
| すごい！最高！！！ | excited | 興奮+感嘆符 |
| 申し訳ございません | sad/sorry | 謝罪 |
| ちょっと考えます... | thinking | 思考中 |
| おやすみなさい〜😴 | sleepy | 睡眠+絵文字 |

### 3. 回帰テスト
変更後は必ず以下を確認：
1. プリセットボタンをすべて試す
2. スコアが異常に高い/低いものがないか
3. 連続して同じ文を入力→ヒステリシスが効いているか

### 4. デバッグモード
```javascript
// コンソールで実行
window.__debugExpressions = true;

// しばらく使った後
window.dumpExpressions();
// → 表情選択の履歴と統計を表示
```

## 🚀 今後の拡張ポイント

### 1. 外部API連携
```javascript
// 将来的な実装イメージ
async function getEmotionFromAPI(text) {
  const response = await fetch('/api/emotion', {
    method: 'POST',
    body: JSON.stringify({ text })
  });
  return response.json(); // { emotion: 'happy', confidence: 0.8 }
}
```

### 2. LLM分類器への置き換え
```javascript
// GPT/Claude等を使った感情分析
const emotion = await llm.classify(text, {
  categories: ['happy', 'sad', 'confused', ...],
  context: conversationHistory
});
```

### 3. 機械学習モデル
- TensorFlow.jsを使用したブラウザ内推論
- 事前学習済みモデルの活用
- ユーザーフィードバックによる継続学習

### 4. コンテキスト強化
```javascript
// 会話履歴を考慮した表情選択
select({
  text: currentMessage,
  history: last5Messages,
  userProfile: { age, preferences },
  timeOfDay: new Date().getHours()
});
```

## 📝 チューニングのベストプラクティス

### DO ✅
1. **小さな変更から始める** - 一度に1-2個のパラメータを調整
2. **テストを重視** - 変更のたびにExpression Testerで確認
3. **ユーザーフィードバックを収集** - 実際の会話ログを分析
4. **グループを意識** - 似た感情は同じグループに
5. **バランスを保つ** - 特定の表情が出すぎないよう調整

### DON'T ❌
1. **極端な値を避ける** - priority 200とかthreshold 50は避ける
2. **汎用語を使いすぎない** - 「です」「ます」などは誤検知の元
3. **正規表現を複雑にしすぎない** - メンテナンスが困難に
4. **cooldownを短くしすぎない** - 500ms以下は表情が不安定に
5. **テストを省略しない** - 必ず複数パターンで確認

## 🎨 表情追加の手順

### 1. 新しい表情を定義
```json
{
  "id": "new_emotion",
  "files": ["logo/new_emotion.png"],
  "priority": 60,
  "threshold": 12,
  "cooldown": 1800,
  "group": "positive",
  "when": ["キーワード1", "キーワード2"],
  "patterns": ["パターン1", "パターン2"]
}
```

### 2. 画像を用意
- サイズ: 105x105px推奨
- 形式: PNG（透過推奨）
- 命名: `logo/smaichan_[emotion].png`

### 3. テスト
1. Expression Testerで動作確認
2. 既存表情との競合チェック
3. 実際のチャットで使用感確認

### 4. 調整
- スコアが適切か確認
- 出現頻度を調整
- ユーザーテストでフィードバック収集

---

## 💡 トラブルシューティング

### Q: 特定の表情が全く出ない
A: thresholdが高すぎる可能性。8-10に下げてみる

### Q: 表情がコロコロ変わる
A: cooldownを長く（2000-3000ms）、thresholdを上げる

### Q: 誤検知が多い
A: キーワードが汎用的すぎる。より具体的な語に変更

### Q: スコアの確認方法は？
A: Expression Testerで詳細スコアを確認可能

---

*最終更新: 2024年8月*