# Expression Pipeline Operations Guide

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€è¡¨æƒ…ã‚·ã‚¹ãƒ†ãƒ ã®é‹ç”¨ã¨å•é¡Œè§£æ±ºã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ”§ Runtime Togglesï¼ˆå®Ÿè¡Œæ™‚ãƒˆã‚°ãƒ«ï¼‰

### 1. `window.__useModelHint` (default: true)
**æ©Ÿèƒ½**: AIãƒ¢ãƒ‡ãƒ«ãŒæä¾›ã™ã‚‹ `[[emo:id]]` ã‚¿ã‚°ã‚’å„ªå…ˆä½¿ç”¨

**æœ‰åŠ¹æ™‚ã®å‹•ä½œ**:
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ«å°¾ã® `[[emo:happy]]` ãªã©ã®ã‚¿ã‚°ã‚’æ¤œå‡º
- ã‚¿ã‚°ã§æŒ‡å®šã•ã‚ŒãŸè¡¨æƒ…ã‚’å¼·åˆ¶ä½¿ç”¨
- ã‚¿ã‚°ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¡¨ç¤ºã•ã‚Œãªã„ï¼ˆè‡ªå‹•å‰Šé™¤ï¼‰

**ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆ**:
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
window.__useModelHint = false;
```

**ä½¿ç”¨ã‚·ãƒ¼ãƒ³**:
- ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ã‚°ãŒä¸æ­£ç¢ºãªå ´åˆ
- è¡¨æƒ…ã‚¨ãƒ³ã‚¸ãƒ³ã®æ€§èƒ½ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆ
- ã‚¿ã‚°å‡¦ç†ã«å•é¡ŒãŒã‚ã‚‹å ´åˆã®ãƒ‡ãƒãƒƒã‚°

### 2. `window.__useStyleRender` (default: true)
**æ©Ÿèƒ½**: è¡¨æƒ…ã«å¿œã˜ãŸãƒˆãƒ¼ãƒ³èª¿æ•´ã‚’é©ç”¨

**æœ‰åŠ¹æ™‚ã®å‹•ä½œ**:
- happy â†’ ã€Œâœ¨ã€è¿½åŠ ã€èªå°¾ã‚’ã€Œã ã‚ˆï¼ã€ã«
- grateful â†’ ã€Œã‚ã‚ŠãŒã¨ã†ã€è¿½åŠ 
- thinking â†’ ã€Œã†ãƒ¼ã‚“ã€ã€ã‚’æ–‡é ­ã«
- ãã®ä»–ã€æ„Ÿæƒ…ã«å¿œã˜ãŸè»½å¾®ãªè£…é£¾

**ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆ**:
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
window.__useStyleRender = false;
```

**ä½¿ç”¨ã‚·ãƒ¼ãƒ³**:
- ç´”ç²‹ãªAIå‡ºåŠ›ã‚’ç¢ºèªã—ãŸã„å ´åˆ
- ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ãŒä¸è‡ªç„¶ãªå ´åˆ
- äº‹å®Ÿæƒ…å ±ã®æ­£ç¢ºæ€§ã‚’é‡è¦–ã™ã‚‹å ´åˆ

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: [[emo:]] ã‚¿ã‚°ãŒæ¥ãªã„

**ç—‡çŠ¶**: AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ„Ÿæƒ…ã‚¿ã‚°ãŒå«ã¾ã‚Œãªã„

**ç¢ºèªæ–¹æ³•**:
```javascript
// Network ã‚¿ãƒ–ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
// ã¾ãŸã¯
fetch('/.netlify/functions/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        messages: [
            {role: 'system', content: '...'},
            {role: 'user', content: 'ãƒ†ã‚¹ãƒˆ'}
        ]
    })
}).then(r => r.json()).then(console.log);
```

**å¯¾ç­–**:
1. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
2. ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªï¼ˆgpt-4ä»¥é™æ¨å¥¨ï¼‰
3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: `window.__useModelHint = false`

### å•é¡Œ2: èª¤ã£ãŸã‚¿ã‚°ãŒå¤šã„

**ç—‡çŠ¶**: ä¸é©åˆ‡ãªè¡¨æƒ…ã‚¿ã‚°ï¼ˆæ‚²ã—ã„å†…å®¹ãªã®ã« happy ãªã©ï¼‰

**ç¢ºèªæ–¹æ³•**:
```javascript
// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
window.__debugExpressions = true;

// ä¼šè©±å¾Œã«å±¥æ­´ã‚’ç¢ºèª
window.dumpExpressions();
```

**å¯¾ç­–**:
1. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª¿æ•´
2. è¨±å¯IDãƒªã‚¹ãƒˆã®è¦‹ç›´ã—
3. ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–: `window.__useModelHint = false`

### å•é¡Œ3: ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ãŒä¸è‡ªç„¶

**ç—‡çŠ¶**: çµµæ–‡å­—ãŒå¤šã™ãã‚‹ã€èªå°¾ãŒä¸è‡ªç„¶

**å¯¾ç­–**:
```javascript
// ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã‚’ç„¡åŠ¹åŒ–
window.__useStyleRender = false;

// ã¾ãŸã¯ style-renderer.js ã‚’èª¿æ•´
```

### å•é¡Œ4: è¡¨æƒ…ãŒé »ç¹ã«å¤‰ã‚ã‚‹

**ç—‡çŠ¶**: è¡¨æƒ…ãŒãƒ‘ã‚«ãƒ‘ã‚«åˆ‡ã‚Šæ›¿ã‚ã‚‹

**å¯¾ç­–**:
```javascript
// config/expressions.json ã§ cooldown ã‚’èª¿æ•´
"cooldown": 3000  // 3ç§’ã«å»¶é•·

// ã¾ãŸã¯ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹é–¾å€¤ã‚’èª¿æ•´ï¼ˆexpression-engine.jsï¼‰
```

## ğŸ“Š Metrics ã®è¦‹æ–¹

### Netlify Functions Logs

**ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•**:
1. Netlify Dashboard â†’ Functions â†’ metrics
2. "View logs" ã‚’ã‚¯ãƒªãƒƒã‚¯

**CLI ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–**:
```bash
netlify logs:function metrics --tail
```

**ãƒ­ã‚°ã®èª­ã¿æ–¹**:
```
[Metrics] Expression: id=happy source=model ts=2024-08-27T10:30:45.123Z
```
- `id`: é¸æŠã•ã‚ŒãŸè¡¨æƒ…
- `source`: `model`ï¼ˆAIæä¾›ï¼‰ã¾ãŸã¯ `engine`ï¼ˆè¨ˆç®—ï¼‰
- `ts`: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

### åˆ†æã®ãƒã‚¤ãƒ³ãƒˆ

**è¡¨æƒ…ã®åˆ†å¸ƒ**:
```javascript
// ãƒ­ã‚°ã‹ã‚‰é›†è¨ˆ
grep "Expression:" logs.txt | awk '{print $3}' | sort | uniq -c
```

**ã‚½ãƒ¼ã‚¹æ¯”ç‡**:
```javascript
// model vs engine ã®æ¯”ç‡
grep "source=model" logs.txt | wc -l
grep "source=engine" logs.txt | wc -l
```

## ğŸ§ª ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

### åŸºæœ¬çš„ãªå®Ÿè¡Œæ–¹æ³•

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œ
npm test
```

### ãƒ†ã‚¹ãƒˆçµæœã®è§£é‡ˆ

```
ğŸ“Š Test Results Summary
Total Tests: 84
âœ… Passed: 43
âŒ Failed: 41
ğŸ“ˆ Pass Rate: 51.2%
```

**æ³¨æ„ç‚¹**:
- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒšãƒŠãƒ«ãƒ†ã‚£ã§é€£ç¶šãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã‚„ã™ã„
- ã“ã‚Œã¯æ­£å¸¸ãªå‹•ä½œï¼ˆãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹åŠ¹æœï¼‰

### ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

`tests/expressions.fixtures.json` ã‚’ç·¨é›†:
```json
{
  "text": "æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹",
  "expect": "happy"
}
```

### CI/CD ã§ã®å®Ÿè¡Œ

`.github/workflows/test.yml`:
```yaml
- name: Run expression tests
  run: npm test
  continue-on-error: true  # è­¦å‘Šã¨ã—ã¦æ‰±ã†
```

## ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«

### Expression Tester UI

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ã
open tools/expression-tester.html

# ã¾ãŸã¯æœ¬ç•ªç’°å¢ƒ
https://[your-domain]/tools/expression-tester.html
```

**ä½¿ã„æ–¹**:
1. ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›
2. "Analyze" ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã‚¹ã‚³ã‚¢ã¨ç†ç”±ã‚’ç¢ºèª

### Console Commands

```javascript
// ç¾åœ¨ã®è¨­å®šã‚’ç¢ºèª
console.log({
    useModelHint: window.__useModelHint,
    useStyleRender: window.__useStyleRender,
    debugMode: window.__debugExpressions
});

// è¡¨æƒ…ã‚¨ãƒ³ã‚¸ãƒ³ã®çŠ¶æ…‹ç¢ºèª
console.log(window.__exprState);

// æ‰‹å‹•ã§è¡¨æƒ…ã‚’é¸æŠ
const result = window.expressionEngine.select({
    text: "ãƒ†ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆ",
    role: 'assistant',
    contexts: [],
    lastId: null
});
console.log(result);
```

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ã®èª¿æ•´

1. **é »åº¦ã®ä½ã„è¡¨æƒ…ã‚’ç¢ºèª**
   - é–¾å€¤ãŒé«˜ã™ãã‚‹å¯èƒ½æ€§
   - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä¸è¶³

2. **ç‰¹å®šè¡¨æƒ…ã®éå‰°å‡ºç¾**
   - å„ªå…ˆåº¦ãŒé«˜ã™ãã‚‹
   - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ±ç”¨çš„ã™ãã‚‹

3. **model vs engine ã®ãƒãƒ©ãƒ³ã‚¹**
   - modelæ¯”ç‡ãŒä½ã„ â†’ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´
   - engineæ¯”ç‡ãŒä½ã„ â†’ ã‚¿ã‚°ã®ä¿¡é ¼æ€§å‘ä¸Š

### æ¨å¥¨è¨­å®š

**å®‰å®šé‡è¦–**:
```javascript
window.__useModelHint = true;
window.__useStyleRender = false;
```

**è¡¨ç¾è±Šã‹**:
```javascript
window.__useModelHint = true;
window.__useStyleRender = true;
```

**ãƒ‡ãƒãƒƒã‚°**:
```javascript
window.__useModelHint = false;
window.__useStyleRender = false;
window.__debugExpressions = true;
```

## ğŸš€ ä»Šå¾Œã®æ”¹å–„æ¡ˆ

1. **A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½**
   - ãƒˆã‚°ãƒ«ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«è‡ªå‹•è¨­å®š
   - ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§æ¯”è¼ƒ

2. **è‡ªå‹•èª¿æ•´**
   - ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«åŸºã¥ã„ã¦é–¾å€¤ã‚’å‹•çš„èª¿æ•´
   - æ™‚é–“å¸¯ã«ã‚ˆã‚‹è¡¨æƒ…å‚¾å‘ã®å¤‰æ›´

3. **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨æƒ…ã‚’è©•ä¾¡ã§ãã‚‹UI
   - æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹æ”¹å–„

---

*æœ€çµ‚æ›´æ–°: 2024-08-27*