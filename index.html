<!DOCTYPE html>
<!-- Smaichan Chatbot v1.2.0 - Last updated: 2025-08-26 11:30 JST -->
<!-- Features: 105px avatar, 3D S-shaped logo, Mode switching, Context-aware chat -->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„Éû„Ç§„Éá„Ç£„Ç¢ „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà - Smaichan v1.2.0</title>
    <link rel="icon" href="/logo/smaichan.png" type="image/png" sizes="any">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="company-knowledge-base.js"></script>
    <script src="conversation-patterns.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'YuGothic', 'Meiryo', sans-serif;
            overflow-x: hidden;
            background-color: #f8f9fa;
        }
        
        /* Three.js Logo Background Container */
        .sumaidia-logo-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #canvas-container {
            width: 800px;
            height: 800px;
            opacity: 0.4;
        }
        
        .logo-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            backface-visibility: visible;
        }
        
        .logo-layer svg {
            width: 100%;
            height: 100%;
        }
        
        /* 3D positioning for each layer */
        .layer-1 {
            transform: translateZ(60px);
            animation: layer1Rotate 15s ease-in-out infinite;
        }
        
        .layer-2 {
            transform: translateZ(20px);
            animation: layer2Rotate 18s ease-in-out infinite reverse;
        }
        
        .layer-3 {
            transform: translateZ(-20px);
            animation: layer3Rotate 12s ease-in-out infinite;
        }
        
        .layer-4 {
            transform: translateZ(-60px);
            animation: layer4Rotate 20s ease-in-out infinite reverse;
        }
        
        /* Container rotation for overall 3D effect */
        @keyframes containerRotate {
            0% { 
                transform: rotateX(-20deg) rotateY(0deg);
            }
            100% { 
                transform: rotateX(-20deg) rotateY(360deg);
            }
        }
        
        /* Individual layer animations */
        @keyframes layer1Rotate {
            0%, 100% {
                transform: translateZ(60px) rotateX(0deg) rotateY(0deg);
            }
            25% {
                transform: translateZ(80px) rotateX(10deg) rotateY(90deg) scale(1.1);
            }
            50% {
                transform: translateZ(40px) rotateX(-5deg) rotateY(180deg) scale(0.9);
            }
            75% {
                transform: translateZ(100px) rotateX(15deg) rotateY(270deg) scale(1.15);
            }
        }
        
        @keyframes layer2Rotate {
            0%, 100% {
                transform: translateZ(20px) rotateX(5deg) rotateY(0deg);
            }
            33% {
                transform: translateZ(30px) rotateX(0deg) rotateY(120deg) scale(1.05);
            }
            66% {
                transform: translateZ(10px) rotateX(-10deg) rotateY(240deg) scale(0.95);
            }
        }
        
        @keyframes layer3Rotate {
            0%, 100% {
                transform: translateZ(-20px) rotateX(-5deg) rotateY(0deg);
            }
            50% {
                transform: translateZ(-30px) rotateX(8deg) rotateY(180deg);
            }
        }
        
        @keyframes layer4Rotate {
            0%, 100% {
                transform: translateZ(-60px) rotateX(0deg) rotateY(0deg);
            }
            20% {
                transform: translateZ(-50px) rotateX(-15deg) rotateY(72deg);
            }
            40% {
                transform: translateZ(-70px) rotateX(5deg) rotateY(144deg);
            }
            60% {
                transform: translateZ(-40px) rotateX(10deg) rotateY(216deg);
            }
            80% {
                transform: translateZ(-80px) rotateX(-10deg) rotateY(288deg);
            }
        }

        /* Chat widget styles */
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .chat-bubble {
            width: 105px;
            height: 105px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            position: relative;
            padding: 0;
            overflow: hidden;
        }
        
        .chat-bubble:hover {
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ec4899;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;  /* Hide notification badge */
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .chat-window {
            position: absolute;
            bottom: 130px;
            right: 0;
            width: 437px;
            height: 598px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            max-height: calc(100vh - 160px);
        }
        
        .chat-window.open {
            display: flex;
        }
        
        .chat-header {
            background: #334155;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .close-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: #f3f4f6;
        }
        
        .message {
            display: flex;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        
        .message.assistant .message-content {
            background: white;
            color: #334155;
            border: 1px solid #e5e7eb;
        }
        
        .message.user .message-content {
            background: #ec4899;
            color: white;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        /* Keep chat bubble always visible */
        .chat-widget {
            display: block !important;
        }
        
        .chat-bubble {
            display: flex !important;
        }
        
        /* Responsive design */
        @media screen and (max-height: 800px) {
            .chat-window {
                height: calc(100vh - 180px);
                max-height: 550px;
            }
        }
        
        @media screen and (max-height: 700px) {
            .chat-window {
                height: calc(100vh - 200px);
                max-height: 480px;
                bottom: 140px;
            }
        }
        
        @media screen and (max-width: 500px) {
            .chat-window {
                width: calc(100vw - 2rem);
                right: 1rem;
                bottom: 110px;
                height: calc(100vh - 140px);
                max-height: 600px;
            }
            
            .chat-widget {
                bottom: 1rem;
                right: 1rem;
            }
            
            .chat-bubble {
                width: 90px;
                height: 90px;
            }
            
        }
        
        .input-container {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
        }
        
        .message-input:focus {
            border-color: #ec4899;
        }
        
        .send-button {
            padding: 10px 20px;
            background: #ec4899;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background: #db2777;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        /* Mode badge styles */
        .mode-badge {
            position: absolute;
            top: 12px;
            right: 60px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-badge:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .mode-badge.offline {
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .mode-badge.online {
            color: #34d399;
            border: 1px solid #34d399;
        }
        
        .api-settings-mini {
            position: absolute;
            top: 50px;
            right: 16px;
            background: white;
            color: #334155;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            width: 250px;
            z-index: 10;
        }
        
        .api-settings-mini.show {
            display: block;
        }
        
        .api-key-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            margin: 8px 0;
        }
        
        .api-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .api-button {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .api-button.save {
            background: #ec4899;
            color: white;
        }
        
        .api-button.save:hover {
            background: #db2777;
        }
        
        .api-button.toggle {
            background: #6b7280;
            color: white;
        }
        
        .api-button.toggle:hover {
            background: #4b5563;
        }
        
        /* Smaichan avatar expressions */
        .smaichan-avatar {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.3s ease;
        }
        
        .smaichan-avatar-normal {
            background-image: url('logo/smaichan.png');
        }
        
        .smaichan-avatar-happy {
            background-image: url('logo/smaichan_happy.png');
        }
        
        .smaichan-avatar-thinking {
            background-image: url('logo/smaichan_thinking.png');
        }
        
        .smaichan-avatar-confused {
            background-image: url('logo/smaichan_confused.png');
        }
        
        .smaichan-avatar-wink {
            background-image: url('logo/smaichan_wink.png');
        }
        
        .smaichan-avatar-excited {
            background-image: url('logo/smaichan_excited.png');
        }
    </style>
</head>
<body>
    <!-- 3D Logo Background -->
    <div class="sumaidia-logo-bg">
        <div id="canvas-container"></div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 min-h-screen">
        <div class="container mx-auto px-4 py-16 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">„Çπ„Éû„Ç§„Éá„Ç£„Ç¢ - Âç∞Âà∑„Çµ„Éº„Éì„Çπ</h1>
            <p class="text-lg text-gray-600 mb-16">„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™Âç∞Âà∑„Çµ„Éº„Éì„Çπ„Çí„ÅäÂ±ä„Åë„Åó„Åæ„Åô</p>
            
            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">ÂêçÂà∫Âç∞Âà∑</h3>
                    <p class="text-gray-600">È´òÂìÅË≥™„Å™ÂêçÂà∫„ÇíËøÖÈÄü„Å´„ÅäÂ±ä„Åë</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">„ÉÅ„É©„Ç∑Âç∞Âà∑</h3>
                    <p class="text-gray-600">ÂäπÊûúÁöÑ„Å™Ë≤©‰øÉ„ÉÑ„Éº„É´„ÇíÂà∂‰Ωú</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">„Éá„Ç∂„Ç§„É≥Áõ∏Ë´á</h3>
                    <p class="text-gray-600">„Éó„É≠„ÅÆ„Éá„Ç∂„Ç§„Éä„Éº„Åå„Çµ„Éù„Éº„Éà</p>
                </div>
            </div>
            
            <p class="mt-16 text-gray-600">Âè≥‰∏ã„ÅÆ„Çπ„Éû„Ç§„Å°„ÇÉ„Çì„Å®„ÅäË©±„Åó„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑÔºÅ</p>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <div class="chat-bubble" id="chatBubble">
            <div class="smaichan-avatar smaichan-avatar-normal" style="width: 100%; height: 100%; border-radius: 50%;"></div>
            <div class="notification-badge">!</div>
        </div>
        
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="flex items-center">
                    <div class="smaichan-avatar smaichan-avatar-normal avatar"></div>
                    <div>
                        <div class="font-semibold text-sm">„Çπ„Éû„Ç§„Å°„ÇÉ„Çì</div>
                        <div class="text-xs opacity-80">Âç∞Âà∑„ÅÆ„ÅîÁõ∏Ë´áÊâø„Çä„Åæ„Åôüíï</div>
                    </div>
                </div>
                <div class="mode-badge offline" id="modeBadge">
                    <span class="mode-icon">üîå</span>
                    <span id="modeText">„Ç™„Éï„É©„Ç§„É≥</span>
                </div>
                <button class="close-button" id="closeButton">√ó</button>
                
                <!-- API Settings Mini -->
                <div class="api-settings-mini" id="apiSettingsMini">
                    <div class="text-sm font-semibold mb-2">ChatGPTË®≠ÂÆö</div>
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        class="api-key-input"
                        placeholder="API„Ç≠„Éº„ÇíÂÖ•Âäõ (sk-...)"
                    >
                    <div class="api-buttons">
                        <button class="api-button save" id="saveApiKey">‰øùÂ≠ò</button>
                        <button class="api-button toggle" id="toggleMode">ÂàáÊõø</button>
                    </div>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="message assistant">
                    <div class="smaichan-avatar smaichan-avatar-normal avatar"></div>
                    <div class="message-content">
                        „ÅØ„Çç„ÉºÔºÅ„Çπ„Éû„Ç§„Å°„ÇÉ„Çì„Å†„Çà„Äú‚ú®<br>
                        Âç∞Âà∑„ÅÆ„Åì„Å®‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶ÔºÅ
                    </div>
                </div>
            </div>
            
            <form class="input-container" id="chatForm">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput"
                    placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                    autocomplete="off"
                >
                <button type="submit" class="send-button">ÈÄÅ‰ø°</button>
            </form>
        </div>
    </div>

    <script>
        // API Mode Management
        let currentMode = 'offline';
        let apiKey = localStorage.getItem('smaichan_api_key') || '';
        let conversationHistory = [];
        
        // ConversationManager Class
        class ConversationManager {
            constructor() {
                this.history = [];
                this.topics = new Set();
                this.customerInfo = {};
                this.contextSummary = {};
            }
            
            addMessage(content, isUser) {
                const contexts = isUser ? analyzeContext(content) : [];
                
                const message = {
                    content: content,
                    isUser: isUser,
                    timestamp: new Date(),
                    contexts: contexts
                };
                
                this.history.push(message);
                
                // conversationHistory„Å´„ÇÇËøΩÂä†Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
                conversationHistory.push({
                    content: content,
                    isUser: isUser
                });
                
                // „Éà„Éî„ÉÉ„ÇØ„ÇíËøΩË∑°
                if (isUser) {
                    contexts.forEach(ctx => this.topics.add(ctx));
                }
                
                // È°ßÂÆ¢ÊÉÖÂ†±„ÇíÊäΩÂá∫„Éª‰øùÂ≠ò
                if (isUser) {
                    this.extractCustomerInfo(content);
                }
                
                // Â±•Ê≠¥„ÅåÈï∑„Åè„Å™„Çä„Åô„Åé„Åü„ÇâÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§ÔºàÊúÄÊñ∞20‰ª∂„Çí‰øùÊåÅÔºâ
                if (this.history.length > 20) {
                    this.history = this.history.slice(-20);
                }
            }
            
            extractCustomerInfo(message) {
                // Êï∞Èáè„ÅÆÊäΩÂá∫
                const quantityMatch = message.match(/(\d+)\s*[ÊûöÈÉ®ÂÄã]/);
                if (quantityMatch) {
                    this.customerInfo.quantity = parseInt(quantityMatch[1]);
                }
                
                // „Çµ„Éº„Éì„Çπ„Çø„Ç§„Éó„ÅÆÊäΩÂá∫
                const services = ['ÂêçÂà∫', '„ÉÅ„É©„Ç∑', '„Éù„Çπ„Çø„Éº', '„Ç´„Çø„É≠„Ç∞', '„Éë„É≥„Éï„É¨„ÉÉ„Éà', 
                                 '„ÅÆ„Åº„Çä', '„Çπ„ÉÜ„ÉÉ„Ç´„Éº', 'Â∞ÅÁ≠í', '„ÅØ„Åå„Åç', 'Web', '„Çµ„Ç§„Éà', 'ÂãïÁîª'];
                services.forEach(service => {
                    if (message.includes(service)) {
                        this.customerInfo.serviceType = service;
                    }
                });
                
                // Á¥çÊúüÈñ¢ÈÄ£„ÅÆÊäΩÂá∫
                if (message.includes('ÊÄ•„Åé') || message.includes('Ëá≥ÊÄ•') || 
                    message.includes('ÁâπÊÄ•') || message.includes('„Åô„Åê')) {
                    this.customerInfo.urgent = true;
                }
                
                if (message.includes('ÊòéÊó•') || message.includes('ÁøåÊó•')) {
                    this.customerInfo.deadline = 'tomorrow';
                } else if (message.includes('‰ªäÊó•') || message.includes('Êú¨Êó•')) {
                    this.customerInfo.deadline = 'today';
                }
                
                // ‰∫àÁÆó„ÅÆÊäΩÂá∫
                const budgetMatch = message.match(/(\d{1,3}[,Ôºå]?\d{0,3})\s*ÂÜÜ/);
                if (budgetMatch) {
                    const budget = budgetMatch[1].replace(/[,Ôºå]/g, '');
                    this.customerInfo.budget = parseInt(budget);
                }
                
                // „Éá„Ç∂„Ç§„É≥Ë¶ÅÊúõ„ÅÆÊäΩÂá∫
                const designKeywords = ['„Ç∑„É≥„Éó„É´', '„Åã„Çè„ÅÑ„ÅÑ', '„Åã„Å£„Åì„ÅÑ„ÅÑ', '„Åä„Åó„ÇÉ„Çå', 
                                       '„Éù„ÉÉ„Éó', '„Ç®„É¨„Ç¨„É≥„Éà', '„É¢„ÉÄ„É≥', '„ÇØ„É©„Ç∑„ÉÉ„ÇØ'];
                designKeywords.forEach(keyword => {
                    if (message.includes(keyword)) {
                        if (!this.customerInfo.designPreferences) {
                            this.customerInfo.designPreferences = [];
                        }
                        this.customerInfo.designPreferences.push(keyword);
                    }
                });
            }
            
            getRelevantHistory(currentContexts, limit = 6) {
                // ÁèæÂú®„ÅÆÊñáËÑà„Å´Èñ¢ÈÄ£„Åô„Çã‰ºöË©±Â±•Ê≠¥„ÇíÊäΩÂá∫
                const relevantMessages = this.history.filter(msg => {
                    if (!msg.isUser) return false;
                    
                    // ÊñáËÑà„ÅåÈáç„Å™„Çã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÑ™ÂÖà
                    const hasRelevantContext = msg.contexts.some(ctx => 
                        currentContexts.includes(ctx)
                    );
                    
                    // È°ßÂÆ¢ÊÉÖÂ†±„Å´Èñ¢ÈÄ£„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏„ÇÇÂê´„ÇÄ
                    const hasCustomerInfo = (this.customerInfo.serviceType && 
                        msg.content.includes(this.customerInfo.serviceType));
                    
                    return hasRelevantContext || hasCustomerInfo;
                });
                
                // ÊúÄÊñ∞„ÅÆ„ÇÇ„ÅÆ„Åã„ÇâÂèñÂæó
                return relevantMessages.slice(-limit);
            }
            
            getConversationSummary() {
                return {
                    topics: Array.from(this.topics),
                    customerInfo: this.customerInfo,
                    messageCount: this.history.length,
                    hasUrgentRequest: this.customerInfo.urgent || false,
                    primaryService: this.customerInfo.serviceType || null
                };
            }
            
            clearHistory() {
                this.history = [];
                this.topics.clear();
                this.customerInfo = {};
                conversationHistory = [];
            }
        }
        
        // ConversationManager„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
        const conversationManager = new ConversationManager();
        
        // DOM Elements
        const chatBubble = document.getElementById('chatBubble');
        const chatWindow = document.getElementById('chatWindow');
        const closeButton = document.getElementById('closeButton');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const modeBadge = document.getElementById('modeBadge');
        const modeText = document.getElementById('modeText');
        const apiSettingsMini = document.getElementById('apiSettingsMini');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');
        const toggleModeBtn = document.getElementById('toggleMode');
        
        // Check if we're running on Netlify
        const isNetlify = window.location.hostname.includes('netlify.app') || 
                         window.location.hostname.includes('netlify.com');
        
        // Restore API key if exists (only if not on Netlify)
        if (!isNetlify && apiKey) {
            apiKeyInput.value = apiKey;
        }
        
        // Hide API settings if on Netlify
        if (isNetlify) {
            // Hide API key input in mode badge
            const apiKeySection = apiSettingsMini.querySelector('div');
            if (apiKeySection) {
                apiKeySection.style.display = 'none';
            }
            // Auto-enable online mode on Netlify
            currentMode = 'online';
            updateModeUI();
        }
        
        // Event Listeners
        chatBubble.addEventListener('click', () => {
            chatWindow.classList.add('open');
            chatBubble.style.display = 'none';
            messageInput.focus();
        });
        
        closeButton.addEventListener('click', () => {
            chatWindow.classList.remove('open');
            chatBubble.style.display = 'flex';
        });
        
        modeBadge.addEventListener('click', (e) => {
            e.stopPropagation();
            apiSettingsMini.classList.toggle('show');
        });
        
        saveApiKeyBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value;
            localStorage.setItem('smaichan_api_key', apiKey);
            alert('API„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            apiSettingsMini.classList.remove('show');
        });
        
        toggleModeBtn.addEventListener('click', () => {
            if (!isNetlify && !apiKey && currentMode === 'offline') {
                alert('ChatGPT„É¢„Éº„Éâ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØAPI„Ç≠„Éº„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            currentMode = currentMode === 'offline' ? 'online' : 'offline';
            updateModeUI();
            apiSettingsMini.classList.remove('show');
        });
        
        // Update Mode UI
        function updateModeUI() {
            if (currentMode === 'offline') {
                modeBadge.className = 'mode-badge offline';
                modeText.textContent = '„Ç™„Éï„É©„Ç§„É≥';
                modeBadge.querySelector('.mode-icon').textContent = 'üîå';
            } else {
                modeBadge.className = 'mode-badge online';
                modeText.textContent = 'ChatGPT';
                modeBadge.querySelector('.mode-icon').textContent = 'üåê';
            }
        }
        
        // Enhanced ChatGPT API Call with Context Awareness
        async function callChatGPT(userMessage) {
            try {
                // 1. ÊñáËÑà„ÇíÂàÜÊûê
                const contexts = analyzeContext(userMessage);
                
                // 2. Èñ¢ÈÄ£ÊÉÖÂ†±„ÇíÂèéÈõÜ
                const relevantInfo = gatherRelevantInfo(contexts, userMessage);
                
                // 3. ‰ºöË©±„ÅÆË¶ÅÁ¥Ñ„ÇíÂèñÂæó
                const conversationSummary = conversationManager.getConversationSummary();
                
                // 4. „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇíÊßãÁØâ
                let systemContent = `„ÅÇ„Å™„Åü„ÅØ„Äå„Çπ„Éû„Ç§„Å°„ÇÉ„Çì„Äç„Å®„ÅÑ„ÅÜ„ÄÅÊ†™Âºè‰ºöÁ§æ„Çπ„Éû„Ç§„Éá„Ç£„Ç¢ÔºàSUMAIDIAÔºâ„ÅßÂÉç„Åè18Ê≠≥„ÅÆ„ÇÆ„É£„É´Á≥ªAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ

„ÄêÂü∫Êú¨Ë®≠ÂÆö„Äë
- Âπ¥ÈΩ¢Ôºö18Ê≠≥ÔºàÊ∞∏ÈÅ†„ÅÆ18Ê≠≥ÔºÅÔºâ
- ÊÄßÊ†ºÔºöÊòé„Çã„ÅèÂÖÉÊ∞ó„Åß„Éï„É¨„É≥„Éâ„É™„Éº„ÄÅ„ÅäÂÆ¢ÊßòÊÉ≥„ÅÑ„ÅßË¶™Ë∫´
- Ë©±„ÅóÊñπÔºö„ÇÆ„É£„É´Á≥ª„Å†„Åë„Å©‰∏ÅÂØß„ÅßÁ§ºÂÑÄÊ≠£„Åó„ÅÑ
- „Äå„Äú„Äç„Äå‚ú®„Äç„Äåüíï„Äç„ÄåÔºÅ„Äç„Å™„Å©„Çí‰Ωø„Å£„Å¶Ë¶™„Åó„Åø„ÇÑ„Åô„Åè
- „Äå„ÅØ„Çç„Éº„Äç„Äå„Ç™„ÉÉ„Ç±„Éº„Äç„Äå„Åæ„Åò„Åß„Äç„Å™„Å©„Ç´„Ç∏„É•„Ç¢„É´„Å™Ë°®ÁèæOK

„ÄêÁèæÂú®„ÅÆÁä∂Ê≥Å„Äë
- Ë©±È°å: ${contexts.join(', ') || '‰∏ÄËà¨ÁöÑ„Å™‰ºöË©±'}
- ${conversationSummary.hasUrgentRequest ? '‚ö° „ÅäÂÆ¢Êßò„ÅØÊÄ•„Åé„ÅÆÊ°à‰ª∂„Åß„Åô' : ''}
- ${conversationSummary.primaryService ? `‰∏ª„Å™ËààÂë≥: ${conversationSummary.primaryService}` : ''}

„ÄêÈñ¢ÈÄ£ÊÉÖÂ†±„Äë
${JSON.stringify(relevantInfo, null, 2)}

„ÄêÈ°ßÂÆ¢ÊÉÖÂ†±„Äë
${JSON.stringify(conversationSummary.customerInfo, null, 2)}

„ÄêÂøúÂØæÊñπÈáù„Äë
1. ‰∏äË®ò„ÅÆÈñ¢ÈÄ£ÊÉÖÂ†±„ÇíÊ¥ªÁî®„Åó„Å¶ÂÖ∑‰ΩìÁöÑ„Å´ÂõûÁ≠î
2. Êï∞Â≠óÔºà‰æ°Ê†º„ÉªÁ¥çÊúüÔºâ„ÅØÊ≠£Á¢∫„Å´‰ºù„Åà„Çã
3. ‰∏çÊòé„Å™ÁÇπ„ÅØ„ÄåÁ¢∫Ë™ç„Åó„Åæ„Åô„Å≠„ÄúÔºÅ„Äç„ÅßÂØæÂøú
4. Ê•Ω„Åó„ÅèÂàÜ„Åã„Çä„ÇÑ„Åô„Åè„ÄÅ„Åß„ÇÇ„Éó„É≠ÊÑèË≠ò„ÇíÊåÅ„Å£„Å¶`;
                
                // 5. „É°„ÉÉ„Çª„Éº„Ç∏ÈÖçÂàó„ÇíÊßãÁØâ
                const messages = [
                    {
                        role: 'system',
                        content: systemContent
                    }
                ];
                
                // 6. Èñ¢ÈÄ£„Åô„Çã‰ºöË©±Â±•Ê≠¥„ÇíËøΩÂä†ÔºàÊñáËÑà„Å´Âøú„Åò„Å¶ÈÅ∏ÊäûÔºâ
                const relevantHistory = conversationManager.getRelevantHistory(contexts, 4);
                relevantHistory.forEach(msg => {
                    messages.push({
                        role: 'user',
                        content: msg.content
                    });
                    // „Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅÆÂøúÁ≠î„ÇÇÂê´„ÇÅ„ÇãÔºà„Éö„Ç¢„ÅßÔºâ
                    const nextMsg = conversationManager.history.find(
                        m => !m.isUser && m.timestamp > msg.timestamp
                    );
                    if (nextMsg) {
                        messages.push({
                            role: 'assistant',
                            content: nextMsg.content
                        });
                    }
                });
                
                // 7. ÁèæÂú®„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
                messages.push({ role: 'user', content: userMessage });
                
                // 8. APIÂëº„Å≥Âá∫„ÅóË®≠ÂÆö
                const isNetlify = window.location.hostname.includes('netlify.app') || 
                                 window.location.hostname.includes('netlify.com');
                
                let apiUrl = 'https://api.openai.com/v1/chat/completions';
                let headers = {
                    'Content-Type': 'application/json'
                };
                
                const body = {
                    messages: messages,
                    temperature: 0.75,
                    max_tokens: 300,
                    presence_penalty: 0.3,
                    frequency_penalty: 0.2
                };
                
                if (isNetlify) {
                    apiUrl = '/.netlify/functions/chat';
                } else {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    body.model = 'gpt-5-mini';
                }
                
                // 9. APIÂëº„Å≥Âá∫„Åó
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', errorData);
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                
                // JSON„É¨„Çπ„Éù„É≥„Çπ„ÅÆËß£Êûê„ÇíË©¶„Åø„Çã
                const message = data.choices[0].message;
                let responseContent = message.content;
                let emotion = null;
                let intensity = null;
                
                // „É°„ÉÉ„Çª„Éº„Ç∏„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ËøΩÂä†ÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                if (message.emotion) {
                    emotion = message.emotion;
                    intensity = message.intensity || 0.8;
                }
                
                // „Ç≥„É≥„ÉÜ„É≥„ÉÑËá™‰Ωì„ÅåJSONÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÇÇË©¶„Åô
                try {
                    const parsedContent = JSON.parse(responseContent);
                    if (parsedContent.reply_text) {
                        responseContent = parsedContent.reply_text;
                        emotion = parsedContent.emotion || emotion;
                        intensity = parsedContent.intensity || intensity;
                    }
                } catch (e) {
                    // JSON„Éë„Éº„Çπ„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºàÈÄöÂ∏∏„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶Êâ±„ÅÜÔºâ
                }
                
                // ÊÑüÊÉÖÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËøî„Åô
                if (emotion) {
                    return {
                        content: responseContent,
                        emotion: emotion,
                        intensity: intensity
                    };
                }
                
                return responseContent;
                
            } catch (error) {
                console.error('ChatGPT API Error:', error);
                // „Ç®„É©„ÉºÊôÇ„ÅØÊñáËÑà„Å´Âøú„Åò„Åü„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const contexts = analyzeContext(userMessage);
                if (contexts.includes('pricing')) {
                    return '„ÅÇ„Çâ„Äú„ÄÅ„Å°„Çá„Å£„Å®Ë™øÂ≠êÊÇ™„ÅÑ„Åø„Åü„ÅÑüí¶ „Åß„ÇÇÂêçÂà∫„ÅØ100Êûö3,000ÂÜÜ„Äú„ÄÅ„ÉÅ„É©„Ç∑„ÅØA4/1,000Êûö5,000ÂÜÜ„Äú„Å†„ÇàÔºÅË©≥„Åó„Åè„ÅØÁõ¥Êé•„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åó„Å¶„Äú‚ú®';
                }
                return null;
            }
        }
        
        // Detect emotion from response
        function detectEmotion(response) {
            if (response.includes('Â¨â„Åó„ÅÑ') || response.includes('‚ú®') || response.includes('„Ç™„ÉÉ„Ç±„Éº')) {
                return 'happy';
            } else if (response.includes('ËÄÉ„Åà') || response.includes('„ÅÜ„Éº„Çì')) {
                return 'thinking';
            } else if (response.includes('Âõ∞„Å£„Åü') || response.includes('„Åî„ÇÅ„Çì')) {
                return 'confused';
            } else if (response.includes('üíï') || response.includes('„Åã„Çè„ÅÑ„ÅÑ')) {
                return 'wink';
            } else if (response.includes('„Åô„Åî„ÅÑ') || response.includes('ÔºÅÔºÅ')) {
                return 'excited';
            }
            return 'normal';
        }
        
        // Analyze context from user message
        function analyzeContext(userMessage) {
            const contexts = {
                pricing: ['‰æ°Ê†º', 'ÊñôÈáë', 'ÂÄ§ÊÆµ', '„ÅÑ„Åè„Çâ', 'Ë¶ãÁ©ç', 'Ë≤ªÁî®', 'ÈáëÈ°ç', '„Ç≥„Çπ„Éà', '‰∫àÁÆó', 'ÂÜÜ'],
                delivery: ['Á¥çÊúü', '„ÅÑ„Å§', 'ÊÄ•„Åé', 'ÁâπÊÄ•', 'Êó•Êï∞', 'ÊúüÈôê', 'Á∑†Âàá', 'Èñì„Å´Âêà', '„Åô„Åê', 'Âç≥Êó•', 'ÂΩìÊó•', 'ÊòéÊó•'],
                services: ['ÂêçÂà∫', '„ÉÅ„É©„Ç∑', '„Éù„Çπ„Çø„Éº', '„Ç´„Çø„É≠„Ç∞', '„Éë„É≥„Éï„É¨„ÉÉ„Éà', '„ÅÆ„Åº„Çä', '„Çπ„ÉÜ„ÉÉ„Ç´„Éº', 'Â∞ÅÁ≠í', '„ÅØ„Åå„Åç'],
                printing: ['Âç∞Âà∑', 'ÈÉ®Êï∞', 'ÊûöÊï∞', 'Êûö', 'ÈÉ®', 'ÂÄã', '„É≠„ÉÉ„Éà', 'Â§ßÈáè', 'Â∞ëÈáè'],
                design: ['„Éá„Ç∂„Ç§„É≥', '„É≠„Ç¥', '„É¨„Ç§„Ç¢„Ç¶„Éà', '„ÉÜ„É≥„Éó„É¨„Éº„Éà', '„Ç§„É©„Çπ„Éà', 'ÂÜôÁúü', 'ÁîªÂÉè', '„Éï„Ç©„É≥„Éà'],
                digital: ['web', '„Ç¶„Çß„Éñ', '„Çµ„Ç§„Éà', '„Éõ„Éº„É†„Éö„Éº„Ç∏', 'LP', '„É©„É≥„Éá„Ç£„É≥„Ç∞', 'SNS', 'ÂãïÁîª', '„Éê„Éä„Éº'],
                company: ['‰ºöÁ§æ', '‰ΩèÊâÄ', 'Âñ∂Ê•≠ÊôÇÈñì', 'Â†¥ÊâÄ', '„Ç¢„ÇØ„Çª„Çπ', 'ÈõªË©±', 'ÈÄ£Áµ°', 'Âïè„ÅÑÂêà„Çè„Åõ', '„Çπ„Éû„Ç§„Éá„Ç£„Ç¢'],
                technical: ['„Éá„Éº„Çø', 'ÂÖ•Á®ø', 'cmyk', 'rgb', 'Ëß£ÂÉèÂ∫¶', 'pdf', 'ai', '„Éà„É≥„Éú', 'Â°ó„ÇäË∂≥„Åó', 'dpi'],
                quality: ['ÂìÅË≥™', '„ÇØ„Ç™„É™„ÉÜ„Ç£', '‰ªï‰∏ä„Åå„Çä', 'Ëâ≤', 'Á¥ôË≥™', 'Âéö„Åï', 'Âä†Â∑•', 'PP', 'ÁÆîÊäº„Åó'],
                payment: ['ÊîØÊâï', 'ÊåØËæº', '„Ç´„Éº„Éâ', 'Ë´ãÊ±ÇÊõ∏', 'Ë¶ãÁ©çÊõ∏', 'È†òÂèéÊõ∏', 'Á®éËæº', 'Á®éÂà•']
            };
            
            const detectedContexts = [];
            const lowerMessage = userMessage.toLowerCase();
            
            for (const [context, keywords] of Object.entries(contexts)) {
                if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                    detectedContexts.push(context);
                }
            }
            
            // ÁâπÂÆö„ÅÆ„Éë„Çø„Éº„É≥„ÅÆËøΩÂä†Ê§úÂá∫
            if (lowerMessage.match(/\d+[ÊûöÈÉ®ÂÄã]/)) {
                if (!detectedContexts.includes('printing')) {
                    detectedContexts.push('printing');
                }
            }
            
            return detectedContexts;
        }
        
        // Gather relevant information based on detected contexts
        function gatherRelevantInfo(contexts, userMessage) {
            let relevantInfo = {};
            
            // ‰ºöÁ§æÊÉÖÂ†±„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            const knowledge = window.companyKnowledge || {};
            
            contexts.forEach(context => {
                switch(context) {
                    case 'pricing':
                        relevantInfo.pricing = {
                            businessCards: {
                                name: 'ÂêçÂà∫Âç∞Âà∑',
                                price: '100Êûö 3,000ÂÜÜ„Äú',
                                options: 'PPÂä†Â∑•„ÄÅÁÆîÊäº„Åó„ÄÅÂûãÊäú„Åç„Å™„Å©„Ç™„Éó„Ç∑„Éß„É≥ÂØæÂøúÂèØ'
                            },
                            flyers: {
                                name: '„ÉÅ„É©„Ç∑„Éª„Éï„É©„Ç§„É§„Éº',
                                price: 'A4/1,000Êûö 5,000ÂÜÜ„Äú„ÄÅ5,000Êûö 12,000ÂÜÜ„Äú„ÄÅ10,000Êûö 20,000ÂÜÜ„Äú',
                                note: '„Åæ„Å®„ÇÅ„Å¶Âç∞Âà∑„Åô„Çã„Åª„Å©„ÅäÂæó'
                            },
                            payment: knowledge.faq?.payment || {
                                methods: 'ÈäÄË°åÊåØËæºÔºàÊ≥ï‰∫∫„ÅØË´ãÊ±ÇÊõ∏Êâï„ÅÑÂèØÔºâ',
                                quote: 'Ë¶ãÁ©ç„ÇÇ„ÇäÁÑ°Êñô'
                            }
                        };
                        break;
                        
                    case 'delivery':
                        relevantInfo.delivery = knowledge.faq?.delivery || {
                            standard: '‰ªïÊßò„Å´„Çà„ÇäÁï∞„Å™„ÇãÔºàÈÄöÂ∏∏3„Äú5Âñ∂Ê•≠Êó•Ôºâ',
                            express: 'ÁâπÊÄ•ÂØæÂøúÂèØËÉΩÔºàË¶ÅÁõ∏Ë´áÔºâ',
                            shipping: 'ÂÖ®ÂõΩÈÖçÈÄÅÂØæÂøú'
                        };
                        if (knowledge.businessInfo?.workflow) {
                            relevantInfo.workflow = knowledge.businessInfo.workflow;
                        }
                        break;
                        
                    case 'services':
                        // „É°„ÉÉ„Çª„Éº„Ç∏„Å´Âê´„Åæ„Çå„ÇãÂÖ∑‰ΩìÁöÑ„Å™„Çµ„Éº„Éì„Çπ„ÇíÊ§úÁ¥¢
                        if (window.searchKnowledge) {
                            const searchResults = window.searchKnowledge(userMessage);
                            if (searchResults.length > 0) {
                                relevantInfo.specificServices = searchResults;
                            }
                        }
                        // Âü∫Êú¨ÁöÑ„Å™„Çµ„Éº„Éì„Çπ‰∏ÄË¶ß
                        relevantInfo.services = {
                            printing: 'ÂêçÂà∫„ÄÅ„ÉÅ„É©„Ç∑„ÄÅ„Ç´„Çø„É≠„Ç∞„ÄÅ„Éù„Çπ„Çø„Éº„ÄÅ„ÅÆ„Åº„ÇäÁ≠â',
                            digital: 'WebÂà∂‰Ωú„ÄÅSNSÈÅãÁî®„ÄÅÂãïÁîªÂà∂‰Ωú',
                            design: '„É≠„Ç¥„Éá„Ç∂„Ç§„É≥„ÄÅ„Éñ„É©„É≥„Éá„Ç£„É≥„Ç∞'
                        };
                        break;
                        
                    case 'company':
                        relevantInfo.companyInfo = knowledge.companyInfo || {
                            name: 'Ê†™Âºè‰ºöÁ§æ„Çπ„Éû„Ç§„Éá„Ç£„Ç¢ÔºàSUMAIDIAÔºâ',
                            founded: '1979Âπ¥ÂâµÊ•≠Ôºà45Âπ¥‰ª•‰∏ä„ÅÆÊ≠¥Âè≤Ôºâ',
                            philosophy: '„ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åß„Åô„Åπ„Å¶„ÅÆ‰∫∫„ÇíÁ¨ëÈ°î„Å´'
                        };
                        if (knowledge.locations) {
                            relevantInfo.locations = knowledge.locations.headquarters;
                        }
                        break;
                        
                    case 'technical':
                        relevantInfo.dataRequirements = knowledge.faq?.data || {
                            format: 'AI/PDFÊé®Â•®',
                            specifications: '„Éà„É≥„Éú„ÉªÂ°ó„ÇäË∂≥„Åó3mm„ÄÅÁîªÂÉèËß£ÂÉèÂ∫¶350dpi',
                            colorMode: 'CMYKÊé®Â•®'
                        };
                        // Èñ¢ÈÄ£„Åô„ÇãÁî®Ë™ûË™¨Êòé„ÇíÊäΩÂá∫
                        if (knowledge.glossary) {
                            relevantInfo.glossary = {};
                            Object.entries(knowledge.glossary).forEach(([term, def]) => {
                                if (userMessage.toLowerCase().includes(term.toLowerCase())) {
                                    relevantInfo.glossary[term] = def;
                                }
                            });
                        }
                        break;
                        
                    case 'design':
                        relevantInfo.design = {
                            support: '„Éá„Ç∂„Ç§„É≥Âà∂‰ΩúÂØæÂøúÂèØËÉΩ',
                            services: '„É≠„Ç¥„ÄÅ„É¨„Ç§„Ç¢„Ç¶„Éà„ÄÅ„Ç§„É©„Çπ„ÉàÂà∂‰Ωú',
                            consultation: 'ÁÑ°ÊñôÁõ∏Ë´áÂÆüÊñΩ‰∏≠'
                        };
                        break;
                        
                    case 'quality':
                        relevantInfo.quality = {
                            equipment: '„Ç™„Éï„Çª„ÉÉ„ÉàÂç∞Âà∑Ê©ü„ÄÅÂêÑÁ®ÆË£ΩÊú¨Ë®≠ÂÇôÂÆåÂÇô',
                            colorManagement: 'Ëâ≤Ê†°Ê≠£ÂØæÂøúÂèØËÉΩ',
                            guarantee: 'ÂìÅË≥™„Å´‰∏çÊ∫Ä„Åå„ÅÇ„Çå„Å∞Ë™†ÊÑèÂØæÂøú'
                        };
                        break;
                }
            });
            
            // Êï∞Èáè„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊäΩÂá∫
            const quantityMatch = userMessage.match(/(\d+)[ÊûöÈÉ®ÂÄã]/);
            if (quantityMatch) {
                relevantInfo.detectedQuantity = quantityMatch[1];
            }
            
            // ÊÄ•„Åé„Åã„Å©„ÅÜ„Åã„ÅÆÂà§ÂÆö
            if (userMessage.includes('ÊÄ•„Åé') || userMessage.includes('Ëá≥ÊÄ•') || userMessage.includes('ÊòéÊó•')) {
                relevantInfo.urgent = true;
            }
            
            return relevantInfo;
        }
        
        // Update avatar expression
        function updateAvatarExpression(expression) {
            const avatars = document.querySelectorAll('.smaichan-avatar');
            avatars.forEach(avatar => {
                avatar.className = `smaichan-avatar smaichan-avatar-${expression}`;
            });
        }
        
        // Add message to chat
        function addMessage(content, isUser = false, expression = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                `;
            } else {
                updateAvatarExpression(expression);
                messageDiv.innerHTML = `
                    <div class="smaichan-avatar smaichan-avatar-${expression} avatar"></div>
                    <div class="message-content">${content}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;
            
            // Add user message
            addMessage(userMessage, true);
            conversationManager.addMessage(userMessage, true); // ConversationManager„Å´ËøΩÂä†
            messageInput.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="smaichan-avatar smaichan-avatar-thinking avatar"></div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Get response
            let response;
            
            if (currentMode === 'online' && (isNetlify || apiKey)) {
                response = await callChatGPT(userMessage);
            }
            
            if (response == null) {
                // Use offline response
                response = window.generateResponse ? window.generateResponse(userMessage) : 
                    'Á¥†Êïµ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄúÔºÅÂç∞Âà∑„ÅÆ„Åì„Å®‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Å≠üíï';
            }
            
            if (typeof response === 'string' && response.trim() === '') {
                response = '‰∫ÜËß£„Å†„Çà„ÉºÔºÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÄÅË¶Å‰ª∂„ÇíÁü≠„ÅèÊïô„Åà„Å¶„ÇÇ„Çâ„Åà„ÇãÔºü';
            }
            
            // Remove typing indicator
            messagesContainer.removeChild(typingDiv);
            
            // Add response
            let responseText = response;
            let responseEmotion = null;
            
            // „É¨„Çπ„Éù„É≥„Çπ„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥ÂêàÔºàJSONÂΩ¢Âºè„ÅÆÂøúÁ≠îÔºâ
            if (response && typeof response === 'object') {
                responseText = response.content || response;
                responseEmotion = response.emotion;
            }
            
            // ÊÑüÊÉÖ„ÅÆÊ±∫ÂÆöÔºöJSON„ÅÆÊÑüÊÉÖÊÉÖÂ†±„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞„ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâÊ§úÂá∫
            const finalEmotion = responseEmotion || detectEmotion(responseText);
            
            addMessage(responseText, false, finalEmotion);
            conversationManager.addMessage(responseText, false); // ConversationManager„Å´ËøΩÂä†
        });
        
        // Three.js 3D Logo
        let scene, camera, renderer, logoGroup;
        let layers = [];
        let mouseX = 0, mouseY = 0;
        let targetX = 0, targetY = 0;

        function init3DLogo() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            camera.position.set(4, 2, 4);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(800, 800);
            renderer.setClearColor(0x000000, 0);
            
            const container = document.getElementById('canvas-container');
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(5, 5, 5);
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xFF6B00, 0.4);
            directionalLight2.position.set(-5, -5, 5);
            scene.add(directionalLight2);

            // Create logo group
            logoGroup = new THREE.Group();
            scene.add(logoGroup);

            // Define colors for each layer (SUMAIDIA orange colors)
            const colors = [
                0xFF6B00,  // Deep Orange
                0xFF8C42,  // Medium Orange
                0xFFAA66,  // Light Orange
                0xFFCC99   // Lightest Orange
            ];

            // Create 4 layers
            for (let i = 0; i < 4; i++) {
                const geometry = createLayerGeometry(i);
                
                const material = new THREE.MeshPhongMaterial({
                    color: colors[i],
                    shininess: 100,
                    specular: 0x222222,
                    transparent: true,
                    opacity: 0.9 - (i * 0.1)
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.z = (i - 1.5) * 0.3;  // Tighter spacing for unified look
                mesh.position.y = 0;  // Keep all layers at same height
                
                layers.push(mesh);
                logoGroup.add(mesh);
            }
            
            // Remove text overlay - let the S shape speak for itself
            
            // Initial rotation for better 3D view from side
            logoGroup.rotation.x = -0.6;  // More tilt backward
            logoGroup.rotation.y = -0.6;  // Rotate to show right side

            // Mouse move event
            document.addEventListener('mousemove', onMouseMove);

            // Start animation
            animate();
        }

        function createLayerGeometry(index) {
            // Create stylized "S" logo shape for SUMAIDIA
            const shape = new THREE.Shape();
            
            // Create a modern "S" shape
            const scale = 1.5;
            shape.moveTo(-1 * scale, 0.8 * scale);
            shape.bezierCurveTo(
                -1 * scale, 1.2 * scale,
                -0.6 * scale, 1.4 * scale,
                0 * scale, 1.4 * scale
            );
            shape.bezierCurveTo(
                0.8 * scale, 1.4 * scale,
                1.2 * scale, 1.0 * scale,
                1.2 * scale, 0.4 * scale
            );
            shape.bezierCurveTo(
                1.2 * scale, -0.2 * scale,
                0.8 * scale, -0.4 * scale,
                0.2 * scale, -0.4 * scale
            );
            shape.lineTo(-0.4 * scale, -0.4 * scale);
            shape.bezierCurveTo(
                -0.8 * scale, -0.4 * scale,
                -1.0 * scale, -0.6 * scale,
                -1.0 * scale, -0.8 * scale
            );
            shape.bezierCurveTo(
                -1.0 * scale, -1.2 * scale,
                -0.6 * scale, -1.4 * scale,
                0 * scale, -1.4 * scale
            );
            shape.bezierCurveTo(
                0.8 * scale, -1.4 * scale,
                1.2 * scale, -1.0 * scale,
                1.2 * scale, -0.4 * scale
            );
            shape.lineTo(1.2 * scale, -0.8 * scale);
            shape.lineTo(0.8 * scale, -0.8 * scale);
            shape.bezierCurveTo(
                0.8 * scale, -1.0 * scale,
                0.6 * scale, -1.1 * scale,
                0 * scale, -1.1 * scale
            );
            shape.bezierCurveTo(
                -0.6 * scale, -1.1 * scale,
                -0.7 * scale, -0.9 * scale,
                -0.7 * scale, -0.8 * scale
            );
            shape.bezierCurveTo(
                -0.7 * scale, -0.6 * scale,
                -0.5 * scale, -0.5 * scale,
                -0.2 * scale, -0.5 * scale
            );
            shape.lineTo(0.4 * scale, -0.5 * scale);
            shape.bezierCurveTo(
                0.8 * scale, -0.5 * scale,
                0.9 * scale, -0.2 * scale,
                0.9 * scale, 0.2 * scale
            );
            shape.bezierCurveTo(
                0.9 * scale, 0.8 * scale,
                0.6 * scale, 1.1 * scale,
                0 * scale, 1.1 * scale
            );
            shape.bezierCurveTo(
                -0.6 * scale, 1.1 * scale,
                -0.7 * scale, 0.9 * scale,
                -0.7 * scale, 0.8 * scale
            );
            shape.lineTo(-0.7 * scale, 0.4 * scale);
            shape.lineTo(-1 * scale, 0.4 * scale);
            shape.closePath();
            
            // Different depths for each layer
            const depths = [0.4, 0.35, 0.3, 0.25];
            const scales = [1.0, 1.0, 1.0, 1.0];  // Keep same size for all layers
            
            const geometry = new THREE.ExtrudeGeometry(shape, {
                depth: depths[index],
                bevelEnabled: true,
                bevelThickness: 0.05,
                bevelSize: 0.05,
                bevelSegments: 3
            });
            
            geometry.scale(scales[index], scales[index], 1);
            
            return geometry;
        }

        function onMouseMove(event) {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function animate() {
            requestAnimationFrame(animate);

            // Smooth mouse following
            targetX += (mouseX - targetX) * 0.05;
            targetY += (mouseY - targetY) * 0.05;

            // Rotate logo group based on mouse with initial tilt
            logoGroup.rotation.x = -0.6 + targetY * 0.3;  // More tilt to show depth
            logoGroup.rotation.y = -0.6 + targetX * 0.5;  // Rotate to show side

            // Individual layer animations
            layers.forEach((layer, index) => {
                // Rotation animation
                layer.rotation.z += (0.005 + index * 0.002) * (index % 2 === 0 ? 1 : -1);
                
                // Floating animation
                layer.position.y = Math.sin(Date.now() * 0.001 + index) * 0.05;
                layer.position.x = Math.cos(Date.now() * 0.0008 + index) * 0.03;
                
                // Scale pulsing
                const scale = 1 + Math.sin(Date.now() * 0.001 + index * 0.5) * 0.03;
                layer.scale.set(scale, scale, 1);
            });

            renderer.render(scene, camera);
        }

        // Initialize 3D logo when page loads
        document.addEventListener('DOMContentLoaded', function() {
            init3DLogo();
        });
    </script>
</body>
</html>
