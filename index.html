<!DOCTYPE html>
<!-- Smaichan Chatbot v1.2.0 - Last updated: 2025-08-26 11:30 JST -->
<!-- Features: 105px avatar, 3D S-shaped logo, Mode switching, Context-aware chat -->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマイディア チャットボット - Smaichan v1.2.0</title>
    <link rel="icon" href="/logo/smaichan.png" type="image/png" sizes="any">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="company-knowledge-base.js"></script>
    <script src="conversation-patterns.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'YuGothic', 'Meiryo', sans-serif;
            overflow-x: hidden;
            background-color: #f8f9fa;
        }
        
        /* Three.js Logo Background Container */
        .sumaidia-logo-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #canvas-container {
            width: 800px;
            height: 800px;
            opacity: 0.4;
        }
        
        .logo-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            backface-visibility: visible;
        }
        
        .logo-layer svg {
            width: 100%;
            height: 100%;
        }
        
        /* 3D positioning for each layer */
        .layer-1 {
            transform: translateZ(60px);
            animation: layer1Rotate 15s ease-in-out infinite;
        }
        
        .layer-2 {
            transform: translateZ(20px);
            animation: layer2Rotate 18s ease-in-out infinite reverse;
        }
        
        .layer-3 {
            transform: translateZ(-20px);
            animation: layer3Rotate 12s ease-in-out infinite;
        }
        
        .layer-4 {
            transform: translateZ(-60px);
            animation: layer4Rotate 20s ease-in-out infinite reverse;
        }
        
        /* Container rotation for overall 3D effect */
        @keyframes containerRotate {
            0% { 
                transform: rotateX(-20deg) rotateY(0deg);
            }
            100% { 
                transform: rotateX(-20deg) rotateY(360deg);
            }
        }
        
        /* Individual layer animations */
        @keyframes layer1Rotate {
            0%, 100% {
                transform: translateZ(60px) rotateX(0deg) rotateY(0deg);
            }
            25% {
                transform: translateZ(80px) rotateX(10deg) rotateY(90deg) scale(1.1);
            }
            50% {
                transform: translateZ(40px) rotateX(-5deg) rotateY(180deg) scale(0.9);
            }
            75% {
                transform: translateZ(100px) rotateX(15deg) rotateY(270deg) scale(1.15);
            }
        }
        
        @keyframes layer2Rotate {
            0%, 100% {
                transform: translateZ(20px) rotateX(5deg) rotateY(0deg);
            }
            33% {
                transform: translateZ(30px) rotateX(0deg) rotateY(120deg) scale(1.05);
            }
            66% {
                transform: translateZ(10px) rotateX(-10deg) rotateY(240deg) scale(0.95);
            }
        }
        
        @keyframes layer3Rotate {
            0%, 100% {
                transform: translateZ(-20px) rotateX(-5deg) rotateY(0deg);
            }
            50% {
                transform: translateZ(-30px) rotateX(8deg) rotateY(180deg);
            }
        }
        
        @keyframes layer4Rotate {
            0%, 100% {
                transform: translateZ(-60px) rotateX(0deg) rotateY(0deg);
            }
            20% {
                transform: translateZ(-50px) rotateX(-15deg) rotateY(72deg);
            }
            40% {
                transform: translateZ(-70px) rotateX(5deg) rotateY(144deg);
            }
            60% {
                transform: translateZ(-40px) rotateX(10deg) rotateY(216deg);
            }
            80% {
                transform: translateZ(-80px) rotateX(-10deg) rotateY(288deg);
            }
        }

        /* Chat widget styles */
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .chat-bubble {
            width: 105px;
            height: 105px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            position: relative;
            padding: 0;
            overflow: hidden;
        }
        
        .chat-bubble:hover {
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ec4899;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;  /* Hide notification badge */
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .chat-window {
            position: absolute;
            bottom: 130px;
            right: 0;
            width: 437px;
            height: 598px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            max-height: calc(100vh - 160px);
        }
        
        .chat-window.open {
            display: flex;
        }
        
        .chat-header {
            background: #334155;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .close-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: #f3f4f6;
        }
        
        .message {
            display: flex;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        
        .message.assistant .message-content {
            background: white;
            color: #334155;
            border: 1px solid #e5e7eb;
        }
        
        .message.user .message-content {
            background: #ec4899;
            color: white;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        /* Keep chat bubble always visible */
        .chat-widget {
            display: block !important;
        }
        
        .chat-bubble {
            display: flex !important;
        }
        
        /* Responsive design */
        @media screen and (max-height: 800px) {
            .chat-window {
                height: calc(100vh - 180px);
                max-height: 550px;
            }
        }
        
        @media screen and (max-height: 700px) {
            .chat-window {
                height: calc(100vh - 200px);
                max-height: 480px;
                bottom: 140px;
            }
        }
        
        @media screen and (max-width: 500px) {
            .chat-window {
                width: calc(100vw - 2rem);
                right: 1rem;
                bottom: 110px;
                height: calc(100vh - 140px);
                max-height: 600px;
            }
            
            .chat-widget {
                bottom: 1rem;
                right: 1rem;
            }
            
            .chat-bubble {
                width: 90px;
                height: 90px;
            }
            
        }
        
        .input-container {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
        }
        
        .message-input:focus {
            border-color: #ec4899;
        }
        
        .send-button {
            padding: 10px 20px;
            background: #ec4899;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background: #db2777;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        /* Mode badge styles */
        .mode-badge {
            position: absolute;
            top: 12px;
            right: 60px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-badge:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .mode-badge.offline {
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .mode-badge.online {
            color: #34d399;
            border: 1px solid #34d399;
        }
        
        .api-settings-mini {
            position: absolute;
            top: 50px;
            right: 16px;
            background: white;
            color: #334155;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            width: 250px;
            z-index: 10;
        }
        
        .api-settings-mini.show {
            display: block;
        }
        
        .api-key-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            margin: 8px 0;
        }
        
        .api-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .api-button {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .api-button.save {
            background: #ec4899;
            color: white;
        }
        
        .api-button.save:hover {
            background: #db2777;
        }
        
        .api-button.toggle {
            background: #6b7280;
            color: white;
        }
        
        .api-button.toggle:hover {
            background: #4b5563;
        }
        
        /* Smaichan avatar expressions */
        .smaichan-avatar {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.3s ease;
        }
        
        .smaichan-avatar-normal {
            background-image: url('logo/smaichan.png');
        }
        
        .smaichan-avatar-happy {
            background-image: url('logo/smaichan_happy.png');
        }
        
        .smaichan-avatar-thinking {
            background-image: url('logo/smaichan_thinking.png');
        }
        
        .smaichan-avatar-confused {
            background-image: url('logo/smaichan_confused.png');
        }
        
        .smaichan-avatar-wink {
            background-image: url('logo/smaichan_wink.png');
        }
        
        .smaichan-avatar-excited {
            background-image: url('logo/smaichan_excited.png');
        }
    </style>
</head>
<body>
    <!-- 3D Logo Background -->
    <div class="sumaidia-logo-bg">
        <div id="canvas-container"></div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 min-h-screen">
        <div class="container mx-auto px-4 py-16 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">スマイディア - 印刷サービス</h1>
            <p class="text-lg text-gray-600 mb-16">プロフェッショナルな印刷サービスをお届けします</p>
            
            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">名刺印刷</h3>
                    <p class="text-gray-600">高品質な名刺を迅速にお届け</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">チラシ印刷</h3>
                    <p class="text-gray-600">効果的な販促ツールを制作</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">デザイン相談</h3>
                    <p class="text-gray-600">プロのデザイナーがサポート</p>
                </div>
            </div>
            
            <p class="mt-16 text-gray-600">右下のスマイちゃんとお話ししてみてください！</p>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <div class="chat-bubble" id="chatBubble">
            <div class="smaichan-avatar smaichan-avatar-normal" style="width: 100%; height: 100%; border-radius: 50%;"></div>
            <div class="notification-badge">!</div>
        </div>
        
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="flex items-center">
                    <div class="smaichan-avatar smaichan-avatar-normal avatar"></div>
                    <div>
                        <div class="font-semibold text-sm">スマイちゃん</div>
                        <div class="text-xs opacity-80">印刷のご相談承ります💕</div>
                    </div>
                </div>
                <div class="mode-badge offline" id="modeBadge">
                    <span class="mode-icon">🔌</span>
                    <span id="modeText">オフライン</span>
                </div>
                <button class="close-button" id="closeButton">×</button>
                
                <!-- API Settings Mini -->
                <div class="api-settings-mini" id="apiSettingsMini">
                    <div class="text-sm font-semibold mb-2">ChatGPT設定</div>
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        class="api-key-input"
                        placeholder="APIキーを入力 (sk-...)"
                    >
                    <div class="api-buttons">
                        <button class="api-button save" id="saveApiKey">保存</button>
                        <button class="api-button toggle" id="toggleMode">切替</button>
                    </div>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="message assistant">
                    <div class="smaichan-avatar smaichan-avatar-normal avatar"></div>
                    <div class="message-content">
                        はろー！スマイちゃんだよ〜✨<br>
                        印刷のこと何でも聞いて！
                    </div>
                </div>
            </div>
            
            <form class="input-container" id="chatForm">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput"
                    placeholder="メッセージを入力..."
                    autocomplete="off"
                >
                <button type="submit" class="send-button">送信</button>
            </form>
        </div>
    </div>

    <script>
        // API Mode Management
        let currentMode = 'offline';
        let apiKey = localStorage.getItem('smaichan_api_key') || '';
        let conversationHistory = [];
        
        // ConversationManager Class
        class ConversationManager {
            constructor() {
                this.history = [];
                this.topics = new Set();
                this.customerInfo = {};
                this.contextSummary = {};
            }
            
            addMessage(content, isUser) {
                const contexts = isUser ? analyzeContext(content) : [];
                
                const message = {
                    content: content,
                    isUser: isUser,
                    timestamp: new Date(),
                    contexts: contexts
                };
                
                this.history.push(message);
                
                // conversationHistoryにも追加（互換性のため）
                conversationHistory.push({
                    content: content,
                    isUser: isUser
                });
                
                // トピックを追跡
                if (isUser) {
                    contexts.forEach(ctx => this.topics.add(ctx));
                }
                
                // 顧客情報を抽出・保存
                if (isUser) {
                    this.extractCustomerInfo(content);
                }
                
                // 履歴が長くなりすぎたら古いものを削除（最新20件を保持）
                if (this.history.length > 20) {
                    this.history = this.history.slice(-20);
                }
            }
            
            extractCustomerInfo(message) {
                // 数量の抽出
                const quantityMatch = message.match(/(\d+)\s*[枚部個]/);
                if (quantityMatch) {
                    this.customerInfo.quantity = parseInt(quantityMatch[1]);
                }
                
                // サービスタイプの抽出
                const services = ['名刺', 'チラシ', 'ポスター', 'カタログ', 'パンフレット', 
                                 'のぼり', 'ステッカー', '封筒', 'はがき', 'Web', 'サイト', '動画'];
                services.forEach(service => {
                    if (message.includes(service)) {
                        this.customerInfo.serviceType = service;
                    }
                });
                
                // 納期関連の抽出
                if (message.includes('急ぎ') || message.includes('至急') || 
                    message.includes('特急') || message.includes('すぐ')) {
                    this.customerInfo.urgent = true;
                }
                
                if (message.includes('明日') || message.includes('翌日')) {
                    this.customerInfo.deadline = 'tomorrow';
                } else if (message.includes('今日') || message.includes('本日')) {
                    this.customerInfo.deadline = 'today';
                }
                
                // 予算の抽出
                const budgetMatch = message.match(/(\d{1,3}[,，]?\d{0,3})\s*円/);
                if (budgetMatch) {
                    const budget = budgetMatch[1].replace(/[,，]/g, '');
                    this.customerInfo.budget = parseInt(budget);
                }
                
                // デザイン要望の抽出
                const designKeywords = ['シンプル', 'かわいい', 'かっこいい', 'おしゃれ', 
                                       'ポップ', 'エレガント', 'モダン', 'クラシック'];
                designKeywords.forEach(keyword => {
                    if (message.includes(keyword)) {
                        if (!this.customerInfo.designPreferences) {
                            this.customerInfo.designPreferences = [];
                        }
                        this.customerInfo.designPreferences.push(keyword);
                    }
                });
            }
            
            getRelevantHistory(currentContexts, limit = 6) {
                // 現在の文脈に関連する会話履歴を抽出
                const relevantMessages = this.history.filter(msg => {
                    if (!msg.isUser) return false;
                    
                    // 文脈が重なるメッセージを優先
                    const hasRelevantContext = msg.contexts.some(ctx => 
                        currentContexts.includes(ctx)
                    );
                    
                    // 顧客情報に関連するメッセージも含む
                    const hasCustomerInfo = (this.customerInfo.serviceType && 
                        msg.content.includes(this.customerInfo.serviceType));
                    
                    return hasRelevantContext || hasCustomerInfo;
                });
                
                // 最新のものから取得
                return relevantMessages.slice(-limit);
            }
            
            getConversationSummary() {
                return {
                    topics: Array.from(this.topics),
                    customerInfo: this.customerInfo,
                    messageCount: this.history.length,
                    hasUrgentRequest: this.customerInfo.urgent || false,
                    primaryService: this.customerInfo.serviceType || null
                };
            }
            
            clearHistory() {
                this.history = [];
                this.topics.clear();
                this.customerInfo = {};
                conversationHistory = [];
            }
        }
        
        // ConversationManagerのインスタンスを作成
        const conversationManager = new ConversationManager();
        
        // DOM Elements
        const chatBubble = document.getElementById('chatBubble');
        const chatWindow = document.getElementById('chatWindow');
        const closeButton = document.getElementById('closeButton');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const modeBadge = document.getElementById('modeBadge');
        const modeText = document.getElementById('modeText');
        const apiSettingsMini = document.getElementById('apiSettingsMini');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');
        const toggleModeBtn = document.getElementById('toggleMode');
        
        // Check if we're running on Netlify
        const isNetlify = window.location.hostname.includes('netlify.app') || 
                         window.location.hostname.includes('netlify.com');
        
        // Restore API key if exists (only if not on Netlify)
        if (!isNetlify && apiKey) {
            apiKeyInput.value = apiKey;
        }
        
        // Hide API settings if on Netlify
        if (isNetlify) {
            // Hide API key input in mode badge
            const apiKeySection = apiSettingsMini.querySelector('div');
            if (apiKeySection) {
                apiKeySection.style.display = 'none';
            }
            // Auto-enable online mode on Netlify
            currentMode = 'online';
            updateModeUI();
        }
        
        // Event Listeners
        chatBubble.addEventListener('click', () => {
            chatWindow.classList.add('open');
            chatBubble.style.display = 'none';
            messageInput.focus();
        });
        
        closeButton.addEventListener('click', () => {
            chatWindow.classList.remove('open');
            chatBubble.style.display = 'flex';
        });
        
        modeBadge.addEventListener('click', (e) => {
            e.stopPropagation();
            apiSettingsMini.classList.toggle('show');
        });
        
        saveApiKeyBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value;
            localStorage.setItem('smaichan_api_key', apiKey);
            alert('APIキーを保存しました！');
            apiSettingsMini.classList.remove('show');
        });
        
        toggleModeBtn.addEventListener('click', () => {
            if (!isNetlify && !apiKey && currentMode === 'offline') {
                alert('ChatGPTモードを使用するにはAPIキーの設定が必要です');
                return;
            }
            
            currentMode = currentMode === 'offline' ? 'online' : 'offline';
            updateModeUI();
            apiSettingsMini.classList.remove('show');
        });
        
        // Update Mode UI
        function updateModeUI() {
            if (currentMode === 'offline') {
                modeBadge.className = 'mode-badge offline';
                modeText.textContent = 'オフライン';
                modeBadge.querySelector('.mode-icon').textContent = '🔌';
            } else {
                modeBadge.className = 'mode-badge online';
                modeText.textContent = 'ChatGPT';
                modeBadge.querySelector('.mode-icon').textContent = '🌐';
            }
        }
        
        // Enhanced ChatGPT API Call with Context Awareness
        async function callChatGPT(userMessage) {
            try {
                // 1. 文脈を分析
                const contexts = analyzeContext(userMessage);
                
                // 2. 関連情報を収集
                const relevantInfo = gatherRelevantInfo(contexts, userMessage);
                
                // 3. 会話の要約を取得
                const conversationSummary = conversationManager.getConversationSummary();
                
                // 4. システムプロンプトを構築
                let systemContent = `あなたは「スマイちゃん」という、株式会社スマイディア（SUMAIDIA）で働く18歳のギャル系AIアシスタントです。

【基本設定】
- 年齢：18歳（永遠の18歳！）
- 性格：明るく元気でフレンドリー、お客様想いで親身
- 話し方：ギャル系だけど丁寧で礼儀正しい
- 「〜」「✨」「💕」「！」などを使って親しみやすく
- 「はろー」「オッケー」「まじで」などカジュアルな表現OK

【現在の状況】
- 話題: ${contexts.join(', ') || '一般的な会話'}
- ${conversationSummary.hasUrgentRequest ? '⚡ お客様は急ぎの案件です' : ''}
- ${conversationSummary.primaryService ? `主な興味: ${conversationSummary.primaryService}` : ''}

【関連情報】
${JSON.stringify(relevantInfo, null, 2)}

【顧客情報】
${JSON.stringify(conversationSummary.customerInfo, null, 2)}

【応対方針】
1. 上記の関連情報を活用して具体的に回答
2. 数字（価格・納期）は正確に伝える
3. 不明な点は「確認しますね〜！」で対応
4. 楽しく分かりやすく、でもプロ意識を持って`;
                
                // 5. メッセージ配列を構築
                const messages = [
                    {
                        role: 'system',
                        content: systemContent
                    }
                ];
                
                // 6. 関連する会話履歴を追加（文脈に応じて選択）
                const relevantHistory = conversationManager.getRelevantHistory(contexts, 4);
                relevantHistory.forEach(msg => {
                    messages.push({
                        role: 'user',
                        content: msg.content
                    });
                    // アシスタントの応答も含める（ペアで）
                    const nextMsg = conversationManager.history.find(
                        m => !m.isUser && m.timestamp > msg.timestamp
                    );
                    if (nextMsg) {
                        messages.push({
                            role: 'assistant',
                            content: nextMsg.content
                        });
                    }
                });
                
                // 7. 現在のメッセージを追加
                messages.push({ role: 'user', content: userMessage });
                
                // 8. API呼び出し設定
                const isNetlify = window.location.hostname.includes('netlify.app') || 
                                 window.location.hostname.includes('netlify.com');
                
                let apiUrl = 'https://api.openai.com/v1/chat/completions';
                let headers = {
                    'Content-Type': 'application/json'
                };
                
                const body = {
                    messages: messages,
                    temperature: 0.75,
                    max_tokens: 300,
                    presence_penalty: 0.3,
                    frequency_penalty: 0.2
                };
                
                if (isNetlify) {
                    apiUrl = '/.netlify/functions/chat';
                } else {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    body.model = 'gpt-5-mini';
                }
                
                // 9. API呼び出し
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', errorData);
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                
                // JSONレスポンスの解析を試みる
                const message = data.choices[0].message;
                let responseContent = message.content;
                let emotion = null;
                let intensity = null;
                
                // メッセージオブジェクトに追加情報が含まれているか確認
                if (message.emotion) {
                    emotion = message.emotion;
                    intensity = message.intensity || 0.8;
                }
                
                // コンテンツ自体がJSON形式の場合も試す
                try {
                    const parsedContent = JSON.parse(responseContent);
                    if (parsedContent.reply_text) {
                        responseContent = parsedContent.reply_text;
                        emotion = parsedContent.emotion || emotion;
                        intensity = parsedContent.intensity || intensity;
                    }
                } catch (e) {
                    // JSONパースエラーは無視（通常のテキストとして扱う）
                }
                
                // 感情情報がある場合は返す
                if (emotion) {
                    return {
                        content: responseContent,
                        emotion: emotion,
                        intensity: intensity
                    };
                }
                
                return responseContent;
                
            } catch (error) {
                console.error('ChatGPT API Error:', error);
                // エラー時は文脈に応じたフォールバック
                const contexts = analyzeContext(userMessage);
                if (contexts.includes('pricing')) {
                    return 'あら〜、ちょっと調子悪いみたい💦 でも名刺は100枚3,000円〜、チラシはA4/1,000枚5,000円〜だよ！詳しくは直接お問い合わせして〜✨';
                }
                return null;
            }
        }
        
        // Detect emotion from response
        function detectEmotion(response) {
            if (response.includes('嬉しい') || response.includes('✨') || response.includes('オッケー')) {
                return 'happy';
            } else if (response.includes('考え') || response.includes('うーん')) {
                return 'thinking';
            } else if (response.includes('困った') || response.includes('ごめん')) {
                return 'confused';
            } else if (response.includes('💕') || response.includes('かわいい')) {
                return 'wink';
            } else if (response.includes('すごい') || response.includes('！！')) {
                return 'excited';
            }
            return 'normal';
        }
        
        // Analyze context from user message
        function analyzeContext(userMessage) {
            const contexts = {
                pricing: ['価格', '料金', '値段', 'いくら', '見積', '費用', '金額', 'コスト', '予算', '円'],
                delivery: ['納期', 'いつ', '急ぎ', '特急', '日数', '期限', '締切', '間に合', 'すぐ', '即日', '当日', '明日'],
                services: ['名刺', 'チラシ', 'ポスター', 'カタログ', 'パンフレット', 'のぼり', 'ステッカー', '封筒', 'はがき'],
                printing: ['印刷', '部数', '枚数', '枚', '部', '個', 'ロット', '大量', '少量'],
                design: ['デザイン', 'ロゴ', 'レイアウト', 'テンプレート', 'イラスト', '写真', '画像', 'フォント'],
                digital: ['web', 'ウェブ', 'サイト', 'ホームページ', 'LP', 'ランディング', 'SNS', '動画', 'バナー'],
                company: ['会社', '住所', '営業時間', '場所', 'アクセス', '電話', '連絡', '問い合わせ', 'スマイディア'],
                technical: ['データ', '入稿', 'cmyk', 'rgb', '解像度', 'pdf', 'ai', 'トンボ', '塗り足し', 'dpi'],
                quality: ['品質', 'クオリティ', '仕上がり', '色', '紙質', '厚さ', '加工', 'PP', '箔押し'],
                payment: ['支払', '振込', 'カード', '請求書', '見積書', '領収書', '税込', '税別']
            };
            
            const detectedContexts = [];
            const lowerMessage = userMessage.toLowerCase();
            
            for (const [context, keywords] of Object.entries(contexts)) {
                if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                    detectedContexts.push(context);
                }
            }
            
            // 特定のパターンの追加検出
            if (lowerMessage.match(/\d+[枚部個]/)) {
                if (!detectedContexts.includes('printing')) {
                    detectedContexts.push('printing');
                }
            }
            
            return detectedContexts;
        }
        
        // Gather relevant information based on detected contexts
        function gatherRelevantInfo(contexts, userMessage) {
            let relevantInfo = {};
            
            // 会社情報が初期化されていない場合のフォールバック
            const knowledge = window.companyKnowledge || {};
            
            contexts.forEach(context => {
                switch(context) {
                    case 'pricing':
                        relevantInfo.pricing = {
                            businessCards: {
                                name: '名刺印刷',
                                price: '100枚 3,000円〜',
                                options: 'PP加工、箔押し、型抜きなどオプション対応可'
                            },
                            flyers: {
                                name: 'チラシ・フライヤー',
                                price: 'A4/1,000枚 5,000円〜、5,000枚 12,000円〜、10,000枚 20,000円〜',
                                note: 'まとめて印刷するほどお得'
                            },
                            payment: knowledge.faq?.payment || {
                                methods: '銀行振込（法人は請求書払い可）',
                                quote: '見積もり無料'
                            }
                        };
                        break;
                        
                    case 'delivery':
                        relevantInfo.delivery = knowledge.faq?.delivery || {
                            standard: '仕様により異なる（通常3〜5営業日）',
                            express: '特急対応可能（要相談）',
                            shipping: '全国配送対応'
                        };
                        if (knowledge.businessInfo?.workflow) {
                            relevantInfo.workflow = knowledge.businessInfo.workflow;
                        }
                        break;
                        
                    case 'services':
                        // メッセージに含まれる具体的なサービスを検索
                        if (window.searchKnowledge) {
                            const searchResults = window.searchKnowledge(userMessage);
                            if (searchResults.length > 0) {
                                relevantInfo.specificServices = searchResults;
                            }
                        }
                        // 基本的なサービス一覧
                        relevantInfo.services = {
                            printing: '名刺、チラシ、カタログ、ポスター、のぼり等',
                            digital: 'Web制作、SNS運用、動画制作',
                            design: 'ロゴデザイン、ブランディング'
                        };
                        break;
                        
                    case 'company':
                        relevantInfo.companyInfo = knowledge.companyInfo || {
                            name: '株式会社スマイディア（SUMAIDIA）',
                            founded: '1979年創業（45年以上の歴史）',
                            philosophy: 'クリエイティビティですべての人を笑顔に'
                        };
                        if (knowledge.locations) {
                            relevantInfo.locations = knowledge.locations.headquarters;
                        }
                        break;
                        
                    case 'technical':
                        relevantInfo.dataRequirements = knowledge.faq?.data || {
                            format: 'AI/PDF推奨',
                            specifications: 'トンボ・塗り足し3mm、画像解像度350dpi',
                            colorMode: 'CMYK推奨'
                        };
                        // 関連する用語説明を抽出
                        if (knowledge.glossary) {
                            relevantInfo.glossary = {};
                            Object.entries(knowledge.glossary).forEach(([term, def]) => {
                                if (userMessage.toLowerCase().includes(term.toLowerCase())) {
                                    relevantInfo.glossary[term] = def;
                                }
                            });
                        }
                        break;
                        
                    case 'design':
                        relevantInfo.design = {
                            support: 'デザイン制作対応可能',
                            services: 'ロゴ、レイアウト、イラスト制作',
                            consultation: '無料相談実施中'
                        };
                        break;
                        
                    case 'quality':
                        relevantInfo.quality = {
                            equipment: 'オフセット印刷機、各種製本設備完備',
                            colorManagement: '色校正対応可能',
                            guarantee: '品質に不満があれば誠意対応'
                        };
                        break;
                }
            });
            
            // 数量が含まれている場合は抽出
            const quantityMatch = userMessage.match(/(\d+)[枚部個]/);
            if (quantityMatch) {
                relevantInfo.detectedQuantity = quantityMatch[1];
            }
            
            // 急ぎかどうかの判定
            if (userMessage.includes('急ぎ') || userMessage.includes('至急') || userMessage.includes('明日')) {
                relevantInfo.urgent = true;
            }
            
            return relevantInfo;
        }
        
        // Update avatar expression
        function updateAvatarExpression(expression) {
            const avatars = document.querySelectorAll('.smaichan-avatar');
            avatars.forEach(avatar => {
                avatar.className = `smaichan-avatar smaichan-avatar-${expression}`;
            });
        }
        
        // Add message to chat
        function addMessage(content, isUser = false, expression = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                `;
            } else {
                updateAvatarExpression(expression);
                messageDiv.innerHTML = `
                    <div class="smaichan-avatar smaichan-avatar-${expression} avatar"></div>
                    <div class="message-content">${content}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;
            
            // Add user message
            addMessage(userMessage, true);
            conversationManager.addMessage(userMessage, true); // ConversationManagerに追加
            messageInput.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="smaichan-avatar smaichan-avatar-thinking avatar"></div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Get response
            let response;
            
            if (currentMode === 'online' && (isNetlify || apiKey)) {
                response = await callChatGPT(userMessage);
            }
            
            if (response == null) {
                // Use offline response
                response = window.generateResponse ? window.generateResponse(userMessage) : 
                    '素敵なメッセージありがとう〜！印刷のこと何でも聞いてね💕';
            }
            
            if (typeof response === 'string' && response.trim() === '') {
                response = '了解だよー！もう一度、要件を短く教えてもらえる？';
            }
            
            // Remove typing indicator
            messagesContainer.removeChild(typingDiv);
            
            // Add response
            let responseText = response;
            let responseEmotion = null;
            
            // レスポンスがオブジェクトの場合（JSON形式の応答）
            if (response && typeof response === 'object') {
                responseText = response.content || response;
                responseEmotion = response.emotion;
            }
            
            // 感情の決定：JSONの感情情報を優先、なければテキストから検出
            const finalEmotion = responseEmotion || detectEmotion(responseText);
            
            addMessage(responseText, false, finalEmotion);
            conversationManager.addMessage(responseText, false); // ConversationManagerに追加
        });
        
        // Three.js 3D Logo
        let scene, camera, renderer, logoGroup;
        let layers = [];
        let mouseX = 0, mouseY = 0;
        let targetX = 0, targetY = 0;

        function init3DLogo() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            camera.position.set(4, 2, 4);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(800, 800);
            renderer.setClearColor(0x000000, 0);
            
            const container = document.getElementById('canvas-container');
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(5, 5, 5);
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xFF6B00, 0.4);
            directionalLight2.position.set(-5, -5, 5);
            scene.add(directionalLight2);

            // Create logo group
            logoGroup = new THREE.Group();
            scene.add(logoGroup);

            // Define colors for each layer (SUMAIDIA orange colors)
            const colors = [
                0xFF6B00,  // Deep Orange
                0xFF8C42,  // Medium Orange
                0xFFAA66,  // Light Orange
                0xFFCC99   // Lightest Orange
            ];

            // Create 4 layers
            for (let i = 0; i < 4; i++) {
                const geometry = createLayerGeometry(i);
                
                const material = new THREE.MeshPhongMaterial({
                    color: colors[i],
                    shininess: 100,
                    specular: 0x222222,
                    transparent: true,
                    opacity: 0.9 - (i * 0.1)
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.z = (i - 1.5) * 0.3;  // Tighter spacing for unified look
                mesh.position.y = 0;  // Keep all layers at same height
                
                layers.push(mesh);
                logoGroup.add(mesh);
            }
            
            // Remove text overlay - let the S shape speak for itself
            
            // Initial rotation for better 3D view from side
            logoGroup.rotation.x = -0.6;  // More tilt backward
            logoGroup.rotation.y = -0.6;  // Rotate to show right side

            // Mouse move event
            document.addEventListener('mousemove', onMouseMove);

            // Start animation
            animate();
        }

        function createLayerGeometry(index) {
            // Create stylized "S" logo shape for SUMAIDIA
            const shape = new THREE.Shape();
            
            // Create a modern "S" shape
            const scale = 1.5;
            shape.moveTo(-1 * scale, 0.8 * scale);
            shape.bezierCurveTo(
                -1 * scale, 1.2 * scale,
                -0.6 * scale, 1.4 * scale,
                0 * scale, 1.4 * scale
            );
            shape.bezierCurveTo(
                0.8 * scale, 1.4 * scale,
                1.2 * scale, 1.0 * scale,
                1.2 * scale, 0.4 * scale
            );
            shape.bezierCurveTo(
                1.2 * scale, -0.2 * scale,
                0.8 * scale, -0.4 * scale,
                0.2 * scale, -0.4 * scale
            );
            shape.lineTo(-0.4 * scale, -0.4 * scale);
            shape.bezierCurveTo(
                -0.8 * scale, -0.4 * scale,
                -1.0 * scale, -0.6 * scale,
                -1.0 * scale, -0.8 * scale
            );
            shape.bezierCurveTo(
                -1.0 * scale, -1.2 * scale,
                -0.6 * scale, -1.4 * scale,
                0 * scale, -1.4 * scale
            );
            shape.bezierCurveTo(
                0.8 * scale, -1.4 * scale,
                1.2 * scale, -1.0 * scale,
                1.2 * scale, -0.4 * scale
            );
            shape.lineTo(1.2 * scale, -0.8 * scale);
            shape.lineTo(0.8 * scale, -0.8 * scale);
            shape.bezierCurveTo(
                0.8 * scale, -1.0 * scale,
                0.6 * scale, -1.1 * scale,
                0 * scale, -1.1 * scale
            );
            shape.bezierCurveTo(
                -0.6 * scale, -1.1 * scale,
                -0.7 * scale, -0.9 * scale,
                -0.7 * scale, -0.8 * scale
            );
            shape.bezierCurveTo(
                -0.7 * scale, -0.6 * scale,
                -0.5 * scale, -0.5 * scale,
                -0.2 * scale, -0.5 * scale
            );
            shape.lineTo(0.4 * scale, -0.5 * scale);
            shape.bezierCurveTo(
                0.8 * scale, -0.5 * scale,
                0.9 * scale, -0.2 * scale,
                0.9 * scale, 0.2 * scale
            );
            shape.bezierCurveTo(
                0.9 * scale, 0.8 * scale,
                0.6 * scale, 1.1 * scale,
                0 * scale, 1.1 * scale
            );
            shape.bezierCurveTo(
                -0.6 * scale, 1.1 * scale,
                -0.7 * scale, 0.9 * scale,
                -0.7 * scale, 0.8 * scale
            );
            shape.lineTo(-0.7 * scale, 0.4 * scale);
            shape.lineTo(-1 * scale, 0.4 * scale);
            shape.closePath();
            
            // Different depths for each layer
            const depths = [0.4, 0.35, 0.3, 0.25];
            const scales = [1.0, 1.0, 1.0, 1.0];  // Keep same size for all layers
            
            const geometry = new THREE.ExtrudeGeometry(shape, {
                depth: depths[index],
                bevelEnabled: true,
                bevelThickness: 0.05,
                bevelSize: 0.05,
                bevelSegments: 3
            });
            
            geometry.scale(scales[index], scales[index], 1);
            
            return geometry;
        }

        function onMouseMove(event) {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function animate() {
            requestAnimationFrame(animate);

            // Smooth mouse following
            targetX += (mouseX - targetX) * 0.05;
            targetY += (mouseY - targetY) * 0.05;

            // Rotate logo group based on mouse with initial tilt
            logoGroup.rotation.x = -0.6 + targetY * 0.3;  // More tilt to show depth
            logoGroup.rotation.y = -0.6 + targetX * 0.5;  // Rotate to show side

            // Individual layer animations
            layers.forEach((layer, index) => {
                // Rotation animation
                layer.rotation.z += (0.005 + index * 0.002) * (index % 2 === 0 ? 1 : -1);
                
                // Floating animation
                layer.position.y = Math.sin(Date.now() * 0.001 + index) * 0.05;
                layer.position.x = Math.cos(Date.now() * 0.0008 + index) * 0.03;
                
                // Scale pulsing
                const scale = 1 + Math.sin(Date.now() * 0.001 + index * 0.5) * 0.03;
                layer.scale.set(scale, scale, 1);
            });

            renderer.render(scene, camera);
        }

        // Initialize 3D logo when page loads
        document.addEventListener('DOMContentLoaded', function() {
            init3DLogo();
        });
    </script>
</body>
</html>
