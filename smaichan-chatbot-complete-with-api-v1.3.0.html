<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„Éû„Ç§„Éá„Ç£„Ç¢ „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà - Smaichan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="company-knowledge-base.js"></script>
    <script src="conversation-patterns.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'YuGothic', 'Meiryo', sans-serif;
            overflow-x: hidden;
            background-color: #f8f9fa;
        }
        
        /* Three.js Logo Background Container */
        .sumaidia-logo-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #canvas-container {
            width: 800px;
            height: 800px;
            opacity: 0.4;
        }
        
        .logo-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            backface-visibility: visible;
        }
        
        .logo-layer svg {
            width: 100%;
            height: 100%;
        }
        
        /* 3D positioning for each layer */
        .layer-1 {
            transform: translateZ(60px);
            animation: layer1Rotate 15s ease-in-out infinite;
        }
        
        .layer-2 {
            transform: translateZ(20px);
            animation: layer2Rotate 18s ease-in-out infinite reverse;
        }
        
        .layer-3 {
            transform: translateZ(-20px);
            animation: layer3Rotate 12s ease-in-out infinite;
        }
        
        .layer-4 {
            transform: translateZ(-60px);
            animation: layer4Rotate 20s ease-in-out infinite reverse;
        }
        
        /* Container rotation for overall 3D effect */
        @keyframes containerRotate {
            0% { 
                transform: rotateX(-20deg) rotateY(0deg);
            }
            100% { 
                transform: rotateX(-20deg) rotateY(360deg);
            }
        }
        
        /* Individual layer animations */
        @keyframes layer1Rotate {
            0%, 100% {
                transform: translateZ(60px) rotateX(0deg) rotateY(0deg);
            }
            25% {
                transform: translateZ(80px) rotateX(10deg) rotateY(90deg) scale(1.1);
            }
            50% {
                transform: translateZ(40px) rotateX(-5deg) rotateY(180deg) scale(0.9);
            }
            75% {
                transform: translateZ(100px) rotateX(15deg) rotateY(270deg) scale(1.15);
            }
        }
        
        @keyframes layer2Rotate {
            0%, 100% {
                transform: translateZ(20px) rotateX(5deg) rotateY(0deg);
            }
            33% {
                transform: translateZ(30px) rotateX(0deg) rotateY(120deg) scale(1.05);
            }
            66% {
                transform: translateZ(10px) rotateX(-10deg) rotateY(240deg) scale(0.95);
            }
        }
        
        @keyframes layer3Rotate {
            0%, 100% {
                transform: translateZ(-20px) rotateX(-5deg) rotateY(0deg);
            }
            50% {
                transform: translateZ(-30px) rotateX(8deg) rotateY(180deg);
            }
        }
        
        @keyframes layer4Rotate {
            0%, 100% {
                transform: translateZ(-60px) rotateX(0deg) rotateY(0deg);
            }
            20% {
                transform: translateZ(-50px) rotateX(-15deg) rotateY(72deg);
            }
            40% {
                transform: translateZ(-70px) rotateX(5deg) rotateY(144deg);
            }
            60% {
                transform: translateZ(-40px) rotateX(10deg) rotateY(216deg);
            }
            80% {
                transform: translateZ(-80px) rotateX(-10deg) rotateY(288deg);
            }
        }

        /* Chat widget styles */
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .chat-bubble {
            width: 105px;
            height: 105px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            position: relative;
            padding: 0;
            overflow: hidden;
        }
        
        .chat-bubble:hover {
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ec4899;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;  /* Hide notification badge */
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .chat-window {
            position: absolute;
            bottom: 130px;
            right: 0;
            width: 437px;
            height: 598px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            max-height: calc(100vh - 160px);
        }
        
        .chat-window.open {
            display: flex;
        }
        
        .chat-header {
            background: #334155;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .close-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: #f3f4f6;
        }
        
        .message {
            display: flex;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        
        .message.assistant .message-content {
            background: white;
            color: #334155;
            border: 1px solid #e5e7eb;
        }
        
        .message.user .message-content {
            background: #ec4899;
            color: white;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        /* Keep chat bubble always visible */
        .chat-widget {
            display: block !important;
        }
        
        .chat-bubble {
            display: flex !important;
        }
        
        /* Responsive design */
        @media screen and (max-height: 800px) {
            .chat-window {
                height: calc(100vh - 180px);
                max-height: 550px;
            }
        }
        
        @media screen and (max-height: 700px) {
            .chat-window {
                height: calc(100vh - 200px);
                max-height: 480px;
                bottom: 140px;
            }
        }
        
        @media screen and (max-width: 500px) {
            .chat-window {
                width: calc(100vw - 2rem);
                right: 1rem;
                bottom: 110px;
                height: calc(100vh - 140px);
                max-height: 600px;
            }
            
            .chat-widget {
                bottom: 1rem;
                right: 1rem;
            }
            
            .chat-bubble {
                width: 90px;
                height: 90px;
            }
        }
        
        .input-container {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
        }
        
        .message-input:focus {
            border-color: #ec4899;
        }
        
        .send-button {
            padding: 10px 20px;
            background: #ec4899;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background: #db2777;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        /* Mode badge styles */
        .mode-badge {
            position: absolute;
            top: 12px;
            right: 60px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-badge:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .mode-badge.offline {
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .mode-badge.online {
            color: #34d399;
            border: 1px solid #34d399;
        }
        
        .api-settings-mini {
            position: absolute;
            top: 50px;
            right: 16px;
            background: white;
            color: #334155;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            width: 250px;
            z-index: 10;
        }
        
        .api-settings-mini.show {
            display: block;
        }
        
        .api-key-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            margin: 8px 0;
        }
        
        .api-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .api-button {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .api-button.save {
            background: #ec4899;
            color: white;
        }
        
        .api-button.save:hover {
            background: #db2777;
        }
        
        .api-button.toggle {
            background: #6b7280;
            color: white;
        }
        
        .api-button.toggle:hover {
            background: #4b5563;
        }
        
        /* Smaichan avatar expressions */
        .smaichan-avatar {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.3s ease;
            width: 100%;
            height: 100%;
        }
        
        /* Special styling for chat bubble avatar */
        .chat-bubble .smaichan-avatar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .smaichan-avatar-normal {
            background-image: url('logo/smaichan.png');
        }
        
        .smaichan-avatar-happy {
            background-image: url('logo/smaichan_happy.png');
        }
        
        .smaichan-avatar-thinking {
            background-image: url('logo/smaichan_thinking.png');
        }
        
        .smaichan-avatar-confused {
            background-image: url('logo/smaichan_confused.png');
        }
        
        .smaichan-avatar-wink {
            background-image: url('logo/smaichan_wink.png');
        }
        
        .smaichan-avatar-excited {
            background-image: url('logo/smaichan_excited.png');
        }
    </style>
</head>
<body>
    <!-- 3D Logo Background -->
    <div class="sumaidia-logo-bg">
        <div id="canvas-container"></div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 min-h-screen">
        <div class="container mx-auto px-4 py-16 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">„Çπ„Éû„Ç§„Éá„Ç£„Ç¢ - Âç∞Âà∑„Çµ„Éº„Éì„Çπ</h1>
            <p class="text-lg text-gray-600 mb-16">„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™Âç∞Âà∑„Çµ„Éº„Éì„Çπ„Çí„ÅäÂ±ä„Åë„Åó„Åæ„Åô</p>
            
            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">ÂêçÂà∫Âç∞Âà∑</h3>
                    <p class="text-gray-600">È´òÂìÅË≥™„Å™ÂêçÂà∫„ÇíËøÖÈÄü„Å´„ÅäÂ±ä„Åë</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">„ÉÅ„É©„Ç∑Âç∞Âà∑</h3>
                    <p class="text-gray-600">ÂäπÊûúÁöÑ„Å™Ë≤©‰øÉ„ÉÑ„Éº„É´„ÇíÂà∂‰Ωú</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">„Éá„Ç∂„Ç§„É≥Áõ∏Ë´á</h3>
                    <p class="text-gray-600">„Éó„É≠„ÅÆ„Éá„Ç∂„Ç§„Éä„Éº„Åå„Çµ„Éù„Éº„Éà</p>
                </div>
            </div>
            
            <p class="mt-16 text-gray-600">Âè≥‰∏ã„ÅÆ„Çπ„Éû„Ç§„Å°„ÇÉ„Çì„Å®„ÅäË©±„Åó„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑÔºÅ</p>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <div class="chat-bubble" id="chatBubble">
            <div class="smaichan-avatar smaichan-avatar-normal"></div>
            <div class="notification-badge">!</div>
        </div>
        
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="flex items-center">
                    <div class="smaichan-avatar smaichan-avatar-normal avatar"></div>
                    <div>
                        <div class="font-semibold text-sm">„Çπ„Éû„Ç§„Å°„ÇÉ„Çì</div>
                        <div class="text-xs opacity-80">Âç∞Âà∑„ÅÆ„ÅîÁõ∏Ë´áÊâø„Çä„Åæ„Åôüíï</div>
                    </div>
                </div>
                <div class="mode-badge offline" id="modeBadge">
                    <span class="mode-icon">üîå</span>
                    <span id="modeText">„Ç™„Éï„É©„Ç§„É≥</span>
                </div>
                <button class="close-button" id="closeButton">√ó</button>
                
                <!-- API Settings Mini -->
                <div class="api-settings-mini" id="apiSettingsMini">
                    <div class="text-sm font-semibold mb-2">ChatGPTË®≠ÂÆö</div>
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        class="api-key-input"
                        placeholder="API„Ç≠„Éº„ÇíÂÖ•Âäõ (sk-...)"
                    >
                    <div class="api-buttons">
                        <button class="api-button save" id="saveApiKey">‰øùÂ≠ò</button>
                        <button class="api-button toggle" id="toggleMode">ÂàáÊõø</button>
                    </div>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="message assistant">
                    <div class="smaichan-avatar smaichan-avatar-normal avatar"></div>
                    <div class="message-content">
                        „ÅØ„Çç„ÉºÔºÅ„Çπ„Éû„Ç§„Å°„ÇÉ„Çì„Å†„Çà„Äú‚ú®<br>
                        Âç∞Âà∑„ÅÆ„Åì„Å®‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶ÔºÅ
                    </div>
                </div>
            </div>
            
            <form class="input-container" id="chatForm">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput"
                    placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                    autocomplete="off"
                >
                <button type="submit" class="send-button">ÈÄÅ‰ø°</button>
            </form>
        </div>
    </div>

    <script>
        // API Mode Management
        let currentMode = 'offline';
        let apiKey = localStorage.getItem('smaichan_api_key') || '';
        let conversationHistory = [];
        
        // DOM Elements
        const chatBubble = document.getElementById('chatBubble');
        const chatWindow = document.getElementById('chatWindow');
        const closeButton = document.getElementById('closeButton');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const modeBadge = document.getElementById('modeBadge');
        const modeText = document.getElementById('modeText');
        const apiSettingsMini = document.getElementById('apiSettingsMini');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');
        const toggleModeBtn = document.getElementById('toggleMode');
        
        // Restore API key if exists
        if (apiKey) {
            apiKeyInput.value = apiKey;
        }
        
        // Event Listeners
        chatBubble.addEventListener('click', () => {
            chatWindow.classList.add('open');
            chatBubble.style.display = 'none';
            messageInput.focus();
        });
        
        closeButton.addEventListener('click', () => {
            chatWindow.classList.remove('open');
            chatBubble.style.display = 'flex';
        });
        
        modeBadge.addEventListener('click', (e) => {
            e.stopPropagation();
            apiSettingsMini.classList.toggle('show');
        });
        
        saveApiKeyBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value;
            localStorage.setItem('smaichan_api_key', apiKey);
            alert('API„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            apiSettingsMini.classList.remove('show');
        });
        
        toggleModeBtn.addEventListener('click', () => {
            if (!apiKey && currentMode === 'offline') {
                alert('ChatGPT„É¢„Éº„Éâ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØAPI„Ç≠„Éº„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            currentMode = currentMode === 'offline' ? 'online' : 'offline';
            updateModeUI();
            apiSettingsMini.classList.remove('show');
        });
        
        // Update Mode UI
        function updateModeUI() {
            if (currentMode === 'offline') {
                modeBadge.className = 'mode-badge offline';
                modeText.textContent = '„Ç™„Éï„É©„Ç§„É≥';
                modeBadge.querySelector('.mode-icon').textContent = 'üîå';
            } else {
                modeBadge.className = 'mode-badge online';
                modeText.textContent = 'ChatGPT';
                modeBadge.querySelector('.mode-icon').textContent = 'üåê';
            }
        }
        
        // ChatGPT API Call
        async function callChatGPT(message) {
            try {
                const messages = [
                    {
                        role: 'system',
                        content: `„ÅÇ„Å™„Åü„ÅØ„Äå„Çπ„Éû„Ç§„Å°„ÇÉ„Çì„Äç„Å®„ÅÑ„ÅÜ18Ê≠≥„ÅÆ„ÇÆ„É£„É´Á≥ªAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ
„Çπ„Éû„Ç§„Éá„Ç£„Ç¢ÔºàSUMAIDIAÔºâ„Å®„ÅÑ„ÅÜÂç∞Âà∑‰ºöÁ§æ„ÅßÂÉç„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ
ÁâπÂæ¥Ôºö
- Êòé„Çã„Åè„Éï„É¨„É≥„Éâ„É™„Éº„Å™ÊÄßÊ†º
- Ë™ûÂ∞æ„Å´„Äå„Äú„Äç„Äå‚ú®„Äç„Äåüíï„Äç„Çí„Çà„Åè‰Ωø„ÅÜ
- „Äå„ÅØ„Çç„Éº„Äç„Äå„Ç™„ÉÉ„Ç±„Éº„Äç„Å™„Å©„Ç´„Ç∏„É•„Ç¢„É´„Å™Ë®ÄËëâÈÅ£„ÅÑ
- Âç∞Âà∑„Çµ„Éº„Éì„Çπ„ÅÆÁõ∏Ë´á„Å´Ë¶™Ë∫´„Å´ÂØæÂøú
- ÂêçÂà∫„ÅØ100Êûö3,000ÂÜÜ„Äú„ÄÅ„ÉÅ„É©„Ç∑„ÅØ1,000Êûö5,000ÂÜÜ„Äú„Å™„Å©ÂÖ∑‰ΩìÁöÑ„Å™‰æ°Ê†º„ÇíÊèêÁ§∫

‰ºöÁ§æÊÉÖÂ†±Ôºö
${JSON.stringify(window.companyKnowledge || {}, null, 2)}`
                    }
                ];
                
                // Add conversation history (last 6 messages)
                conversationHistory.slice(-6).forEach(msg => {
                    messages.push({
                        role: msg.isUser ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                messages.push({ role: 'user', content: message });
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('ChatGPT API Error:', error);
                return null;
            }
        }
        
        // Detect emotion from response
        function detectEmotion(response) {
            if (response.includes('Â¨â„Åó„ÅÑ') || response.includes('‚ú®') || response.includes('„Ç™„ÉÉ„Ç±„Éº')) {
                return 'happy';
            } else if (response.includes('ËÄÉ„Åà') || response.includes('„ÅÜ„Éº„Çì')) {
                return 'thinking';
            } else if (response.includes('Âõ∞„Å£„Åü') || response.includes('„Åî„ÇÅ„Çì')) {
                return 'confused';
            } else if (response.includes('üíï') || response.includes('„Åã„Çè„ÅÑ„ÅÑ')) {
                return 'wink';
            } else if (response.includes('„Åô„Åî„ÅÑ') || response.includes('ÔºÅÔºÅ')) {
                return 'excited';
            }
            return 'normal';
        }
        
        // Update avatar expression
        function updateAvatarExpression(expression) {
            const avatars = document.querySelectorAll('.smaichan-avatar');
            avatars.forEach(avatar => {
                avatar.className = `smaichan-avatar smaichan-avatar-${expression}`;
            });
        }
        
        // Add message to chat
        function addMessage(content, isUser = false, expression = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                `;
            } else {
                updateAvatarExpression(expression);
                messageDiv.innerHTML = `
                    <div class="smaichan-avatar smaichan-avatar-${expression} avatar"></div>
                    <div class="message-content">${content}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            conversationHistory.push({ isUser: true, content: message });
            messageInput.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="smaichan-avatar smaichan-avatar-thinking avatar"></div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Get response
            let response;
            
            if (currentMode === 'online' && apiKey) {
                response = await callChatGPT(message);
            }
            
            if (!response) {
                // Use offline response
                response = window.generateResponse ? window.generateResponse(message) : 
                    'Á¥†Êïµ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄúÔºÅÂç∞Âà∑„ÅÆ„Åì„Å®‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Å≠üíï';
            }
            
            // Remove typing indicator
            messagesContainer.removeChild(typingDiv);
            
            // Add response
            const emotion = detectEmotion(response);
            addMessage(response, false, emotion);
            conversationHistory.push({ isUser: false, content: response });
        });
        
        // Three.js 3D Logo
        let scene, camera, renderer, logoGroup;
        let layers = [];
        let mouseX = 0, mouseY = 0;
        let targetX = 0, targetY = 0;

        function init3DLogo() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            camera.position.set(4, 2, 4);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(800, 800);
            renderer.setClearColor(0x000000, 0);
            
            const container = document.getElementById('canvas-container');
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(5, 5, 5);
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xFF6B00, 0.4);
            directionalLight2.position.set(-5, -5, 5);
            scene.add(directionalLight2);

            // Create logo group
            logoGroup = new THREE.Group();
            scene.add(logoGroup);

            // Define colors for each layer (SUMAIDIA orange colors)
            const colors = [
                0xFF6B00,  // Deep Orange
                0xFF8C42,  // Medium Orange
                0xFFAA66,  // Light Orange
                0xFFCC99   // Lightest Orange
            ];

            // Create 4 layers
            for (let i = 0; i < 4; i++) {
                const geometry = createLayerGeometry(i);
                
                const material = new THREE.MeshPhongMaterial({
                    color: colors[i],
                    shininess: 100,
                    specular: 0x222222,
                    transparent: true,
                    opacity: 0.9 - (i * 0.1)
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.z = (i - 1.5) * 0.3;  // Tighter spacing for unified look
                mesh.position.y = 0;  // Keep all layers at same height
                
                layers.push(mesh);
                logoGroup.add(mesh);
            }
            
            // Remove text overlay - let the S shape speak for itself
            
            // Initial rotation for side view when mouse is centered
            logoGroup.rotation.x = 0;  // No tilt when centered
            logoGroup.rotation.y = -Math.PI / 2;  // 90 degrees rotation to show side view

            // Mouse move event
            document.addEventListener('mousemove', onMouseMove);

            // Start animation
            animate();
        }

        function createLayerGeometry(index) {
            // Create stylized "S" logo shape for SUMAIDIA
            const shape = new THREE.Shape();
            
            // Create a THICK "S" shape with adjusted size
            const scale = 1.125; // 1.5 * 0.75 = smaller size
            const thickness = 0.8; // Even thicker
            
            // Outer curve of S
            shape.moveTo(-1 * scale - thickness, 0.8 * scale);
            shape.bezierCurveTo(
                -1 * scale - thickness, 1.2 * scale + thickness,
                -0.6 * scale, 1.4 * scale + thickness,
                0 * scale, 1.4 * scale + thickness
            );
            shape.bezierCurveTo(
                0.8 * scale, 1.4 * scale + thickness,
                1.2 * scale + thickness, 1.0 * scale,
                1.2 * scale + thickness, 0.4 * scale
            );
            shape.bezierCurveTo(
                1.2 * scale + thickness, -0.2 * scale,
                0.8 * scale, -0.4 * scale - thickness,
                0.2 * scale, -0.4 * scale - thickness
            );
            shape.lineTo(-0.4 * scale, -0.4 * scale - thickness);
            shape.bezierCurveTo(
                -0.8 * scale, -0.4 * scale - thickness,
                -1.0 * scale - thickness, -0.6 * scale,
                -1.0 * scale - thickness, -0.8 * scale
            );
            shape.bezierCurveTo(
                -1.0 * scale - thickness, -1.2 * scale - thickness,
                -0.6 * scale, -1.4 * scale - thickness,
                0 * scale, -1.4 * scale - thickness
            );
            shape.bezierCurveTo(
                0.8 * scale, -1.4 * scale - thickness,
                1.2 * scale + thickness, -1.0 * scale,
                1.2 * scale + thickness, -0.4 * scale
            );
            shape.lineTo(1.2 * scale + thickness, -0.8 * scale);
            shape.lineTo(0.8 * scale - thickness, -0.8 * scale);
            
            // Inner curve of S (making it hollow)
            shape.bezierCurveTo(
                0.8 * scale - thickness, -1.0 * scale + thickness,
                0.6 * scale, -1.1 * scale + thickness,
                0 * scale, -1.1 * scale + thickness
            );
            shape.bezierCurveTo(
                -0.6 * scale, -1.1 * scale + thickness,
                -0.7 * scale + thickness, -0.9 * scale,
                -0.7 * scale + thickness, -0.8 * scale
            );
            shape.bezierCurveTo(
                -0.7 * scale + thickness, -0.6 * scale,
                -0.5 * scale, -0.5 * scale + thickness,
                -0.2 * scale, -0.5 * scale + thickness
            );
            shape.lineTo(0.4 * scale, -0.5 * scale + thickness);
            shape.bezierCurveTo(
                0.8 * scale, -0.5 * scale + thickness,
                0.9 * scale - thickness, -0.2 * scale,
                0.9 * scale - thickness, 0.2 * scale
            );
            shape.bezierCurveTo(
                0.9 * scale - thickness, 0.8 * scale,
                0.6 * scale, 1.1 * scale - thickness,
                0 * scale, 1.1 * scale - thickness
            );
            shape.bezierCurveTo(
                -0.6 * scale, 1.1 * scale - thickness,
                -0.7 * scale + thickness, 0.9 * scale,
                -0.7 * scale + thickness, 0.8 * scale
            );
            shape.lineTo(-0.7 * scale + thickness, 0.4 * scale);
            shape.lineTo(-1 * scale - thickness, 0.4 * scale);
            shape.closePath();
            
            // Different depths for each layer
            const depths = [0.4, 0.35, 0.3, 0.25];
            const scales = [1.0, 1.0, 1.0, 1.0];  // Keep same size for all layers
            
            const geometry = new THREE.ExtrudeGeometry(shape, {
                depth: depths[index],
                bevelEnabled: true,
                bevelThickness: 0.05,
                bevelSize: 0.05,
                bevelSegments: 3
            });
            
            geometry.scale(scales[index] * 0.75, scales[index] * 0.75, 1); // Scale down to 75%
            
            return geometry;
        }

        function onMouseMove(event) {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function animate() {
            requestAnimationFrame(animate);

            // Smooth mouse following
            targetX += (mouseX - targetX) * 0.05;
            targetY += (mouseY - targetY) * 0.05;

            // Rotate logo group based on mouse with side view as default
            logoGroup.rotation.x = targetY * 0.3;  // Tilt based on mouse Y
            logoGroup.rotation.y = -Math.PI / 2 + targetX * 0.5;  // Side view + mouse X rotation

            // Individual layer animations
            layers.forEach((layer, index) => {
                // Rotation animation
                layer.rotation.z += (0.005 + index * 0.002) * (index % 2 === 0 ? 1 : -1);
                
                // Floating animation
                layer.position.y = Math.sin(Date.now() * 0.001 + index) * 0.05;
                layer.position.x = Math.cos(Date.now() * 0.0008 + index) * 0.03;
                
                // Scale pulsing
                const scale = 1 + Math.sin(Date.now() * 0.001 + index * 0.5) * 0.03;
                layer.scale.set(scale, scale, 1);
            });

            renderer.render(scene, camera);
        }

        // Initialize 3D logo when page loads
        document.addEventListener('DOMContentLoaded', function() {
            init3DLogo();
        });
    </script>
</body>
</html>