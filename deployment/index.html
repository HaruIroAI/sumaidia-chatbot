<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ - Smaichan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="company-knowledge-base.js"></script>
    <script src="conversation-patterns.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'YuGothic', 'Meiryo', sans-serif;
            overflow-x: hidden;
            background-color: #f8f9fa;
        }
        
        /* Three.js Logo Background Container */
        .sumaidia-logo-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #canvas-container {
            width: 800px;
            height: 800px;
            opacity: 0.4;
        }
        
        .logo-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            backface-visibility: visible;
        }
        
        .logo-layer svg {
            width: 100%;
            height: 100%;
        }
        
        /* 3D positioning for each layer */
        .layer-1 {
            transform: translateZ(60px);
            animation: layer1Rotate 15s ease-in-out infinite;
        }
        
        .layer-2 {
            transform: translateZ(20px);
            animation: layer2Rotate 18s ease-in-out infinite reverse;
        }
        
        .layer-3 {
            transform: translateZ(-20px);
            animation: layer3Rotate 12s ease-in-out infinite;
        }
        
        .layer-4 {
            transform: translateZ(-60px);
            animation: layer4Rotate 20s ease-in-out infinite reverse;
        }
        
        /* Container rotation for overall 3D effect */
        @keyframes containerRotate {
            0% { 
                transform: rotateX(-20deg) rotateY(0deg);
            }
            100% { 
                transform: rotateX(-20deg) rotateY(360deg);
            }
        }
        
        /* Individual layer animations */
        @keyframes layer1Rotate {
            0%, 100% {
                transform: translateZ(60px) rotateX(0deg) rotateY(0deg);
            }
            25% {
                transform: translateZ(80px) rotateX(10deg) rotateY(90deg) scale(1.1);
            }
            50% {
                transform: translateZ(40px) rotateX(-5deg) rotateY(180deg) scale(0.9);
            }
            75% {
                transform: translateZ(100px) rotateX(15deg) rotateY(270deg) scale(1.15);
            }
        }
        
        @keyframes layer2Rotate {
            0%, 100% {
                transform: translateZ(20px) rotateY(0deg) rotateZ(0deg);
            }
            33% {
                transform: translateZ(50px) rotateY(120deg) rotateZ(-30deg) scale(1.2);
            }
            66% {
                transform: translateZ(-10px) rotateY(240deg) rotateZ(30deg) scale(0.85);
            }
        }
        
        @keyframes layer3Rotate {
            0%, 100% {
                transform: translateZ(-20px) rotateX(0deg) rotateZ(0deg);
            }
            50% {
                transform: translateZ(-50px) rotateX(180deg) rotateZ(45deg) scale(1.3);
            }
        }
        
        @keyframes layer4Rotate {
            0%, 100% {
                transform: translateZ(-60px) rotateY(0deg);
            }
            20% {
                transform: translateZ(-40px) rotateY(72deg) rotateX(20deg) scale(0.8);
            }
            40% {
                transform: translateZ(-80px) rotateY(144deg) rotateX(-20deg) scale(1.25);
            }
            60% {
                transform: translateZ(-30px) rotateY(216deg) rotateX(10deg) scale(0.95);
            }
            80% {
                transform: translateZ(-100px) rotateY(288deg) rotateX(-10deg) scale(1.1);
            }
        }
        
        /* Each color with 3D depth and lighting effects */
        .logoColor200 {
            fill: #FFE4B5 !important;
            opacity: 0.35 !important;
            filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.2));
        }
        
        .logoColor400 {
            fill: #FFB366 !important;
            opacity: 0.45 !important;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.25));
        }
        
        .logoColor600 {
            fill: #FF8C42 !important;
            opacity: 0.55 !important;
            filter: drop-shadow(-2px -2px 4px rgba(0,0,0,0.3));
        }
        
        .logoColor800 {
            fill: #FF6B6B !important;
            opacity: 0.65 !important;
            filter: drop-shadow(-3px -3px 6px rgba(0,0,0,0.35));
        }
        
        /* 3D depth blur based on Z position */
        .layer-1 path {
            filter: blur(0.3px) drop-shadow(5px 5px 10px rgba(0,0,0,0.15));
        }
        
        .layer-2 path {
            filter: blur(0.1px) drop-shadow(3px 3px 6px rgba(0,0,0,0.2));
        }
        
        .layer-3 path {
            filter: blur(0.2px) drop-shadow(-3px -3px 6px rgba(0,0,0,0.25));
        }
        
        .layer-4 path {
            filter: blur(0.5px) drop-shadow(-5px -5px 10px rgba(0,0,0,0.3));
        }
        
        /* 3D lighting and perspective effects */
        .logo-3d-container::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, 
                transparent 30%,
                rgba(255, 183, 102, 0.1) 50%,
                transparent 70%);
            animation: glowPulse 4s ease-in-out infinite;
        }
        
        @keyframes glowPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        /* Enhanced 3D extrusion effects for each layer */
        .logo-layer {
            position: relative;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        
        /* Create multiple shadow layers for true 3D depth */
        .logo-layer::before,
        .logo-layer::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        /* Front highlight layer */
        .logo-layer::before {
            transform: translateZ(2px);
            opacity: 0.2;
            filter: blur(0.5px);
            mix-blend-mode: screen;
        }
        
        /* Back shadow layer */
        .logo-layer::after {
            transform: translateZ(-8px);
            opacity: 0.4;
            filter: blur(4px);
            mix-blend-mode: multiply;
        }
        
        .layer-1::before {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.6), transparent 70%);
        }
        
        .layer-1::after {
            background: radial-gradient(circle at 70% 70%, transparent, rgba(139, 69, 19, 0.3));
        }
        
        .layer-2::before {
            background: radial-gradient(circle at 40% 20%, rgba(255,255,255,0.5), transparent 60%);
        }
        
        .layer-2::after {
            background: radial-gradient(circle at 60% 80%, transparent, rgba(160, 82, 45, 0.35));
        }
        
        .layer-3::before {
            background: radial-gradient(circle at 20% 40%, rgba(255,255,255,0.4), transparent 65%);
        }
        
        .layer-3::after {
            background: radial-gradient(circle at 80% 60%, transparent, rgba(184, 134, 11, 0.4));
        }
        
        .layer-4::before {
            background: radial-gradient(circle at 50% 30%, rgba(255,255,255,0.3), transparent 70%);
        }
        
        .layer-4::after {
            background: radial-gradient(circle at 50% 70%, transparent, rgba(139, 0, 0, 0.45));
        }
        
        .chat-bubble-entrance {
            animation: bubbleEntrance 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes bubbleEntrance {
            0% { 
                transform: translateY(100px) scale(0); 
                opacity: 0; 
            }
            100% { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .message-slide-in {
            animation: slideInLeft 0.3s ease-out;
        }
        
        @keyframes slideInLeft {
            0% { 
                transform: translateX(-20px); 
                opacity: 0; 
            }
            100% { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        .user-message-slide-in {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            0% { 
                transform: translateX(20px); 
                opacity: 0; 
            }
            100% { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        .avatar-bounce {
            animation: avatarBounce 2s ease-in-out infinite;
        }
        
        @keyframes avatarBounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }
        
        .typing-indicator {
            animation: typingPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes typingPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .gradient-bg {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 50%, #2c5aa0 100%);
        }

        .chat-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .avatar-container {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .price-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #dee2e6;
        }

        .sparkle {
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* Smaichan avatar image */
        .smaichan-avatar {
            background-image: url('./logo/smaichan.png');
            background-size: cover;
            background-position: center;
        }
        
        /* ã‚¢ãƒã‚¿ãƒ¼è¡¨æƒ…å¤‰æ›´ï¼ˆç”»åƒåˆ‡ã‚Šæ›¿ãˆã§å®Ÿç¾ï¼‰ */
        .smaichan-avatar {
            background-size: cover;
            background-position: center;
            transition: opacity 0.3s ease;
        }
        
        .smaichan-avatar-normal {
            background-image: url('./logo/smaichan.png');
        }
        
        .smaichan-avatar-happy {
            background-image: url('./logo/smaichan_happy.png');
        }
        
        .smaichan-avatar-thinking {
            background-image: url('./logo/smaichan_thinking.png');
        }
        
        .smaichan-avatar-confused {
            background-image: url('./logo/smaichan_confused.png');
        }
        
        .smaichan-avatar-wink {
            background-image: url('./logo/smaichan_wink.png');
        }
        
        .smaichan-avatar-excited {
            background-image: url('./logo/smaichan_excited.png');
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <!-- Three.js Logo Background -->
    <div class="sumaidia-logo-bg">
        <div id="canvas-container"></div>
    </div>

    <!-- Demo Background (for demonstration purposes) -->
    <div class="max-w-4xl mx-auto py-16 relative z-10">
        <div class="text-center mb-16">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ - å°åˆ·ã‚µãƒ¼ãƒ“ã‚¹</h1>
            <p class="text-lg text-gray-600">ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå°åˆ·ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãŠå±Šã‘ã—ã¾ã™</p>
        </div>
        
        <div class="grid md:grid-cols-3 gap-8 mb-16">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">ååˆºå°åˆ·</h3>
                <p class="text-gray-600">é«˜å“è³ªãªååˆºã‚’è¿…é€Ÿã«ãŠå±Šã‘</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">ãƒãƒ©ã‚·å°åˆ·</h3>
                <p class="text-gray-600">åŠ¹æœçš„ãªè²©ä¿ƒãƒ„ãƒ¼ãƒ«ã‚’åˆ¶ä½œ</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">ãƒ‡ã‚¶ã‚¤ãƒ³ç›¸è«‡</h3>
                <p class="text-gray-600">ãƒ—ãƒ­ã®ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ãŒã‚µãƒãƒ¼ãƒˆ</p>
            </div>
        </div>

        <div class="text-center text-gray-600">
            <p>å³ä¸‹ã®ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ã¨ãŠè©±ã—ã—ã¦ã¿ã¦ãã ã•ã„ï¼</p>
        </div>
    </div>

    <!-- Chat Widget -->
    <div id="chatWidget" class="fixed bottom-6 right-6 z-50">
        <!-- Chat Bubble -->
        <div id="chatBubble" class="relative cursor-pointer hover:scale-105 transition-transform duration-200 chat-bubble-entrance">
            <div class="w-20 h-20 chat-shadow hover:shadow-2xl transition-shadow duration-300 rounded-full overflow-hidden bg-white border-2 border-gray-200">
                <div class="w-full h-full smaichan-avatar avatar-bounce"></div>
            </div>
            
            <!-- Notification Badge -->
            <div id="notificationBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-pink-500 rounded-full flex items-center justify-center text-xs text-white font-bold sparkle">
                !
            </div>
        </div>

        <!-- Chat Window -->
        <div id="chatWindow" class="absolute bottom-20 right-0 w-[460px] h-[720px] bg-white rounded-lg chat-shadow hidden flex-col overflow-hidden">
            <!-- Header -->
            <div class="bg-gray-800 text-white p-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full overflow-hidden bg-white border border-gray-300">
                        <div class="w-full h-full smaichan-avatar"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold">ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“</h3>
                        <p class="text-xs text-gray-300">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</p>
                    </div>
                </div>
                <button id="closeChat" class="text-white hover:text-gray-300 focus:outline-none text-xl font-bold">
                    Ã—
                </button>
            </div>

            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <!-- Messages will be added here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-4 py-2">
                <div class="flex items-center space-x-2 text-gray-500 text-sm">
                    <div class="w-8 h-8 rounded-full overflow-hidden bg-white border border-gray-300">
                        <div class="w-full h-full smaichan-avatar"></div>
                    </div>
                    <span class="typing-indicator">å…¥åŠ›ä¸­...</span>
                </div>
            </div>

            <!-- Quick Replies -->
            <div id="quickReplies" class="px-4 py-2 flex flex-wrap gap-2">
                <!-- Quick reply buttons will be added here -->
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-gray-200 bg-white">
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="messageInput"
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                        class="flex-1 px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent"
                    >
                    <button 
                        id="sendButton" 
                        class="px-5 py-3 bg-gray-700 hover:bg-gray-800 text-white text-base rounded-lg hover:shadow-lg transition-all duration-200 hover:scale-105"
                    >
                        é€ä¿¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chat state management
        const chatState = {
            currentContext: {},
            conversationHistory: [],
            isTyping: false,
            isOpen: false,
            lastQuestion: null,  // Track the last question asked
            conversationStage: null  // Track where we are in the conversation
        };

        // Price calculation logic
        const priceCalculator = {
            businessCard: (qty, sides, color, paper, finish) => {
                let base = 10000; // Base price 10,000 yen
                
                // Quantity adjustments
                if (qty <= 100) base = 10000;
                else if (qty <= 500) base = 15000;
                else if (qty <= 1000) base = 20000;
                else base = 25000;
                
                // Double-sided
                if (sides === 'ä¸¡é¢') base *= 1.3;
                
                // Color printing
                if (color === 'ã‚«ãƒ©ãƒ¼') base *= 1.2;
                
                // Paper quality
                if (paper && paper.includes('é«˜ç´š')) base *= 1.3;
                
                // Special finishes
                if (finish && finish.includes('PP')) base *= 1.2;
                if (finish && finish.includes('ç®”æŠ¼ã—')) base *= 1.5;
                
                // Determine price range
                if (base < 20000) return { range: 'ä½', estimate: Math.round(base) };
                if (base < 30000) return { range: 'ä¸­', estimate: Math.round(base) };
                return { range: 'é«˜', estimate: Math.round(base) };
            },
            
            flyer: (size, qty, sides, color, paper) => {
                let base = 50000; // Base price for flyers
                
                // Size adjustments
                const sizeMultiplier = {
                    'A6': 0.6,
                    'A5': 0.8,
                    'A4': 1.0,
                    'A3': 1.5,
                    'B5': 0.9,
                    'B4': 1.3
                };
                
                base *= sizeMultiplier[size] || 1.0;
                
                // Quantity adjustments
                if (qty <= 500) base = base * 0.8;
                else if (qty <= 1000) base = base * 1.0;
                else if (qty <= 5000) base = base * 1.5;
                else base = base * 2.0;
                
                // Double-sided
                if (sides === 'ä¸¡é¢') base *= 1.4;
                
                // Color
                if (color === 'ã‚«ãƒ©ãƒ¼') base *= 1.3;
                
                // Determine price range
                if (base < 80000) return { range: 'ä½', estimate: Math.round(base) };
                if (base < 150000) return { range: 'ä¸­', estimate: Math.round(base) };
                return { range: 'é«˜', estimate: Math.round(base) };
            }
        };

        // Expression management
        let expressionTimeout;
        
        // Function to change avatar expression
        const changeAvatarExpression = (expression, duration = 3000) => {
            const avatars = document.querySelectorAll('.smaichan-avatar');
            const expressions = ['happy', 'thinking', 'excited', 'confused', 'wink'];
            
            // Clear existing timeout
            if (expressionTimeout) {
                clearTimeout(expressionTimeout);
            }
            
            avatars.forEach(avatar => {
                // Remove all expression classes
                expressions.forEach(exp => {
                    avatar.classList.remove(`smaichan-avatar-${exp}`);
                });
                // Add new expression
                avatar.classList.add(`smaichan-avatar-${expression}`);
            });
            
            // Return to happy after duration (except for thinking)
            if (expression !== 'thinking' && expression !== 'happy') {
                expressionTimeout = setTimeout(() => {
                    changeAvatarExpression('happy', 0);
                }, duration);
            }
        };
        
        // Analyze emotion from message
        const analyzeEmotion = (message) => {
            const lowerMessage = message.toLowerCase();
            
            // Check if detectEmotionFromMessage is available
            if (window.detectEmotionFromMessage) {
                return window.detectEmotionFromMessage(message);
            }
            
            // Fallback emotion detection
            // Excited patterns
            if (lowerMessage.match(/ã™ã”ã„|ã‚„ã£ãŸ|å¬‰ã—ã„|æœ€é«˜|ã‚ã‚ŠãŒã¨ã†|ãŸã®ã—ã„|æ¥½ã—ã„|ã‚ãƒ¼ã„|ã‚[ããƒ¼]ã„/)) {
                return 'excited';
            }
            
            // Confused patterns
            if (lowerMessage.match(/ã‚ã‹ã‚‰ãªã„|åˆ†ã‹ã‚‰ãªã„|é›£ã—ã„|å›°ã£ãŸ|ã©ã†ã—ã‚ˆã†|ãˆ[ï¼Ÿãƒ¼]|ãªã«[ï¼Ÿ?]|ã¯[ï¼Ÿ?]/)) {
                return 'confused';
            }
            
            // Thinking patterns
            if (lowerMessage.match(/ã©ã†|ã©ã‚“ãª|ã„ãã‚‰|ã„ã¤|ã©ã“|ãªãœ|ã©ã†ã—ã¦|æ•™ãˆã¦/)) {
                return 'thinking';
            }
            
            // Wink patterns (for playful messages)
            if (lowerMessage.match(/ã‹ã‚ã„ã„|å¯æ„›ã„|ã™ã|å¥½ã|ã„ã„ã­|ã•ã™ãŒ/)) {
                return 'wink';
            }
            
            // Default happy
            return 'happy';
        };

        // Response generation logic with priority system
        const generateResponse = (userMessage) => {
            const lowerMessage = userMessage.toLowerCase();
            const originalMessage = userMessage;
            const trimmedMessage = userMessage.trim();
            
            // Debug logging removed for production
            
            // Priority 1: Check for exact match patterns first
            if (window.exactMatchPatterns && window.exactMatchPatterns[trimmedMessage]) {
                return {
                    text: window.exactMatchPatterns[trimmedMessage],
                    quickReplies: [],
                    emotion: analyzeEmotion(window.exactMatchPatterns[trimmedMessage])
                };
            }
            
            // Priority 2: Check greeting patterns using checkGreeting
            if (window.checkGreeting) {
                const greetingResult = window.checkGreeting(userMessage);
                if (greetingResult && greetingResult.response) {
                    return {
                        text: greetingResult.response,
                        quickReplies: [],
                        emotion: analyzeEmotion(greetingResult.response)
                    };
                }
            }
            
            // Check if this is a contextual response
            if (chatState.lastQuestion && lowerMessage.match(/ç›¸è«‡|ãã†ã ã‚“|è©±ã—ãŸã„|èããŸã„|æ•™ãˆã¦/)) {
                // Handle consultation in context of last question
                if (chatState.lastQuestion.includes('ãƒšãƒ¼ã‚¸')) {
                    return {
                        text: 'ãƒšãƒ¼ã‚¸æ•°ã®ç›¸è«‡ã­ï¼äºˆç®—ã¨ã‹ç”¨é€”ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã‘ã©...\n\nã©ã‚“ãªã‚«ã‚¿ãƒ­ã‚°ä½œã‚‹äºˆå®šï¼Ÿå•†å“ç´¹ä»‹ï¼Ÿä¼šç¤¾æ¡ˆå†…ï¼Ÿ',
                        quickReplies: ['å•†å“ã‚«ã‚¿ãƒ­ã‚°', 'ä¼šç¤¾æ¡ˆå†…', 'ã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹', 'ç·åˆã‚«ã‚¿ãƒ­ã‚°']
                    };
                } else if (chatState.lastQuestion.includes('æš') || chatState.lastQuestion.includes('éƒ¨')) {
                    return {
                        text: 'æ•°é‡ã®ç›¸è«‡ã­ï¼ä½¿ã†æœŸé–“ã¨ã‹é…ã‚‹ç›¸æ‰‹ã«ã‚ˆã£ã¦æœ€é©ãªæšæ•°å¤‰ã‚ã‚‹ã‚ˆã€œ\n\nã©ã‚“ãªã‚·ãƒ¼ãƒ³ã§ä½¿ã†äºˆå®šï¼Ÿ',
                        quickReplies: ['é•·æœŸé–“ä½¿ã†', 'ã‚¤ãƒ™ãƒ³ãƒˆé…å¸ƒ', 'å–¶æ¥­ã§ä½¿ã†', 'åœ¨åº«ã¨ã—ã¦']
                    };
                } else if (chatState.lastQuestion.includes('ã‚µã‚¤ã‚º')) {
                    return {
                        text: 'ã‚µã‚¤ã‚ºé¸ã³é›£ã—ã„ã‚ˆã­ã€œï¼ç”¨é€”ã«ã‚ˆã£ã¦ãŠã™ã™ã‚å¤‰ã‚ã‚‹ã‚ˆğŸ’•\n\nä½•ã«ä½¿ã†äºˆå®šï¼Ÿ',
                        quickReplies: ['æŒã¡æ­©ãç”¨', 'æ²ç¤ºç”¨', 'é…å¸ƒç”¨', 'ã¾ã æ±ºã‚ã¦ãªã„']
                    };
                } else if (chatState.lastQuestion.includes('ãƒ‡ã‚¶ã‚¤ãƒ³')) {
                    return {
                        text: 'ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç›¸è«‡ã­ï¼ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã•ã‚“è¶…å„ªç§€ã ã‹ã‚‰å®‰å¿ƒã—ã¦ã€œâœ¨\n\nã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‹å¸Œæœ›ã‚ã‚‹ï¼Ÿ',
                        quickReplies: ['ã‚·ãƒ³ãƒ—ãƒ«ç³»', 'ã‹ã‚ã„ã„ç³»', 'ã‹ã£ã“ã„ã„ç³»', 'ãŠã¾ã‹ã›']
                    };
                }
            }
            
            // Handle basic printing keywords first
            if (lowerMessage.match(/å°åˆ·/) && !lowerMessage.match(/ååˆº|ãƒãƒ©ã‚·|ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ|ãƒã‚¹ã‚¿ãƒ¼/)) {
                return {
                    text: 'å°åˆ·ã®ã“ã¨èããŸã„ã‚“ã ã­ï¼âœ¨\n\nã©ã‚“ãªå°åˆ·ç‰©ã‚’ä½œã‚ŠãŸã„ï¼Ÿ',
                    quickReplies: ['ååˆºå°åˆ·', 'ãƒãƒ©ã‚·å°åˆ·', 'ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆå°åˆ·', 'ãã®ä»–ã®å°åˆ·']
                };
            }
            
            // Handle Web site requests
            if (lowerMessage.match(/web|ã‚¦ã‚§ãƒ–|ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸|hp/i) && lowerMessage.match(/ä½œ|ã¤ã|åˆ¶ä½œ|æ¬²ã—ã„|ã»ã—ã„/)) {
                chatState.currentContext.type = 'website';
                if (window.companyKnowledge) {
                    const service = window.companyKnowledge.services.digital.webDesign;
                    return {
                        text: `Webã‚µã‚¤ãƒˆåˆ¶ä½œã­ï¼ã„ã„ã‚ˆã€œğŸ’»\n\n${service.description}\n${service.cms}ã‚‚å¯¾å¿œã—ã¦ã‚‹ã‚ˆâœ¨\n\nã©ã‚“ãªã‚µã‚¤ãƒˆä½œã‚ŠãŸã„ï¼Ÿ`,
                        quickReplies: ['ä¼æ¥­ã‚µã‚¤ãƒˆ', 'ECã‚µã‚¤ãƒˆ', 'LPï¼ˆ1ãƒšãƒ¼ã‚¸ï¼‰', 'ç›¸è«‡ã—ãŸã„']
                    };
                } else {
                    return {
                        text: 'Webã‚µã‚¤ãƒˆåˆ¶ä½œã­ï¼ã„ã„ã‚ˆã€œğŸ’»\n\nã©ã‚“ãªã‚µã‚¤ãƒˆä½œã‚ŠãŸã„ï¼Ÿ',
                        quickReplies: ['ä¼æ¥­ã‚µã‚¤ãƒˆ', 'ECã‚µã‚¤ãƒˆ', 'LPï¼ˆ1ãƒšãƒ¼ã‚¸ï¼‰', 'ç›¸è«‡ã—ãŸã„']
                    };
                }
            }
            
            // Handle specific website types
            if (chatState.currentContext.type === 'website') {
                if (lowerMessage.match(/ä¼æ¥­ã‚µã‚¤ãƒˆ|ä¼šç¤¾.*ã‚µã‚¤ãƒˆ|ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆ/)) {
                    chatState.currentContext.websiteType = 'corporate';
                    return {
                        text: 'ä¼æ¥­ã‚µã‚¤ãƒˆã­ï¼ã‚·ãƒ³ãƒ—ãƒ«ã§ä¿¡é ¼æ„Ÿã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ãŒã„ã„ã‚ˆã­ã€œâœ¨\n\nãƒšãƒ¼ã‚¸æ•°ã©ã®ãã‚‰ã„ã®è¦æ¨¡ã§è€ƒãˆã¦ã‚‹ï¼Ÿ',
                        quickReplies: ['5ãƒšãƒ¼ã‚¸ä»¥å†…', '10ãƒšãƒ¼ã‚¸ç¨‹åº¦', '20ãƒšãƒ¼ã‚¸ä»¥ä¸Š', 'ç›¸è«‡ã—ãŸã„']
                    };
                } else if (lowerMessage.match(/ecã‚µã‚¤ãƒˆ|ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—|é€šè²©/)) {
                    chatState.currentContext.websiteType = 'ec';
                    return {
                        text: 'ECã‚µã‚¤ãƒˆä½œã‚‹ã‚“ã ï¼å•†å“è²©å£²ãŒã‚“ã°ã£ã¦ã€œğŸ’•\n\nå•†å“ç‚¹æ•°ã©ã®ãã‚‰ã„ï¼Ÿ',
                        quickReplies: ['10ç‚¹ä»¥å†…', '50ç‚¹ç¨‹åº¦', '100ç‚¹ä»¥ä¸Š', 'ã¾ã æ±ºã‚ã¦ãªã„']
                    };
                } else if (lowerMessage.match(/lp|ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°|1ãƒšãƒ¼ã‚¸/)) {
                    chatState.currentContext.websiteType = 'lp';
                    return {
                        text: 'LPï¼ˆãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼‰ã­ï¼ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³é‡è¦–ã§ã„ãã‚ˆã€œğŸ¯\n\nä½•ã®å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®LPï¼Ÿ',
                        quickReplies: ['å•†å“è²©å£²', 'ã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹', 'è³‡æ–™è«‹æ±‚', 'ã‚¤ãƒ™ãƒ³ãƒˆå‘ŠçŸ¥']
                    };
                }
            }
            
            // Handle simple acknowledgments
            if (lowerMessage.match(/^(ã¯ã„|ã†ã‚“|ok|ãŠã£ã‘ãƒ¼|ã‚ã‹ã£ãŸ|äº†è§£)$/)) {
                return {
                    text: 'ã‚ªãƒƒã‚±ãƒ¼ï¼ã§ã€ä½•ä½œã‚ŠãŸã„æ„Ÿã˜ï¼Ÿå…·ä½“çš„ã«æ•™ãˆã¦ã€œ',
                    quickReplies: ['ååˆº', 'ãƒãƒ©ã‚·', 'ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ', 'ã¾ã æ±ºã‚ã¦ãªã„']
                };
            }
            
            // Handle "what can you do" type questions - using knowledge base
            if (lowerMessage.match(/ä½•ãŒã§ã|ã§ãã‚‹ã“ã¨|ãƒ¡ãƒ‹ãƒ¥ãƒ¼|ã‚µãƒ¼ãƒ“ã‚¹/)) {
                if (window.companyKnowledge) {
                    const services = window.companyKnowledge.services;
                    return {
                        text: `ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ã§ã§ãã‚‹ã“ã¨ï¼Ÿã‚ã£ã¡ã‚ƒã‚ã‚‹ã‚ˆã€œï¼âœ¨\n\nã€å°åˆ·ç³»ã€‘\n${Object.keys(services.printing).map(key => services.printing[key].name).join('ã€')}\n\nã€ãƒ‡ã‚¸ã‚¿ãƒ«ç³»ã€‘\n${Object.keys(services.digital).map(key => services.digital[key].name).join('ã€')}\n\nã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€‘\n${Object.keys(services.design).map(key => services.design[key].name).join('ã€')}\n\nã©ã‚Œã‹æ°—ã«ãªã‚‹ã‚„ã¤ã‚ã‚‹ï¼ŸğŸ’•`,
                        quickReplies: ['å°åˆ·ç³»ã®ç›¸è«‡', 'Webåˆ¶ä½œ', 'å‹•ç”»åˆ¶ä½œ', 'ã¨ã‚Šã‚ãˆãšè¦‹ç©ã‚‚ã‚Š']
                    };
                } else {
                    return {
                        text: 'ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ã§ã§ãã‚‹ã“ã¨ï¼Ÿã‚ã£ã¡ã‚ƒã‚ã‚‹ã‚ˆã€œï¼\n\nå°åˆ·ç³»ãªã‚‰ååˆºã€ãƒãƒ©ã‚·ã€ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆã€ãƒã‚¹ã‚¿ãƒ¼ã€ã®ã¼ã‚Š...\nãƒ‡ã‚¸ã‚¿ãƒ«ç³»ãªã‚‰Webã‚µã‚¤ãƒˆã€SNSé‹ç”¨ã€å‹•ç”»åˆ¶ä½œã‚‚ï¼\n\nã©ã‚Œã‹æ°—ã«ãªã‚‹ã‚„ã¤ã‚ã‚‹ï¼ŸğŸ’•',
                        quickReplies: ['å°åˆ·ç³»ã®ç›¸è«‡', 'Webåˆ¶ä½œ', 'å‹•ç”»åˆ¶ä½œ', 'ã¨ã‚Šã‚ãˆãšè¦‹ç©ã‚‚ã‚Š']
                    };
                }
            }
            
            // Handle general inquiry keywords early
            if (lowerMessage.match(/è¦‹ç©|ã¿ã¤ã‚‚ã‚Š|ãŠé¡˜ã„|é ¼ã¿ãŸã„|ä½œã‚ŠãŸã„|ã¤ãã‚ŠãŸã„/) && !chatState.currentContext.type) {
                return {
                    text: 'ãŠä»•äº‹ã®ç›¸è«‡ã ã­ï¼å¬‰ã—ã„ã€œğŸ’•\n\nä½•ã‚’ä½œã‚ŠãŸã„ï¼Ÿ',
                    quickReplies: ['ååˆº', 'ãƒãƒ©ã‚·', 'ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ', 'ãã®ä»–']
                };
            }
            
            // Handle PP question
            if (lowerMessage.match(/pp[ã£]?ã¦|ãƒ”ãƒ¼ãƒ”ãƒ¼/)) {
                return {
                    text: 'PPã¯è¡¨é¢ä¿è­·ã®è–„ã€œã„ãƒ•ã‚£ãƒ«ãƒ ã®ã“ã¨ã ã‚ˆï¼\n\nã‚ˆãè§¦ã‚‹ã‚‚ã®ã¨ã‹ã€é•·ãä½¿ã†ã‚‚ã®ã«ã¯ãŠã™ã™ã‚ã€œâœ¨\nçŸ­æœŸé–“ã§é…ã‚‹ã ã‘ãªã‚‰ç„¡ãã¦ã‚‚OKã‹ã‚‚ï¼\n\nã©ã‚“ãªä½¿ã„æ–¹ã™ã‚‹äºˆå®šï¼Ÿ',
                    quickReplies: ['é•·ãä½¿ã†', 'çŸ­æœŸé…å¸ƒ', 'ã‚ˆãã‚ã‹ã‚‰ãªã„', 'ä»–ã®åŠ å·¥ã‚‚çŸ¥ã‚ŠãŸã„']
                };
            }
            
            // Pattern matching for business cards
            if (lowerMessage.includes('ååˆº')) {
                if (!chatState.currentContext.type) {
                    chatState.currentContext.type = 'businessCard';
                    return {
                        text: 'ååˆºã­ï¼ã‚ªãƒƒã‚±ãƒ¼âœ¨ ä½•æšãã‚‰ã„ä½œã‚‹äºˆå®šã€œï¼Ÿ',
                        quickReplies: ['100æš', '500æš', '1000æš', 'ãã‚Œä»¥ä¸Š']
                    };
                }
            }
            
            // Pattern matching for flyers
            if (lowerMessage.includes('ãƒãƒ©ã‚·') || lowerMessage.includes('ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼')) {
                if (!chatState.currentContext.type) {
                    chatState.currentContext.type = 'flyer';
                    return {
                        text: 'ãƒãƒ©ã‚·ã‹ãã€œï¼ã„ã„ã­ğŸ’• ã‚µã‚¤ã‚ºã©ã†ã™ã‚‹ï¼Ÿ',
                        quickReplies: ['A4ã‚µã‚¤ã‚º', 'A5ã‚µã‚¤ã‚º', 'B5ã‚µã‚¤ã‚º', 'ãã®ä»–']
                    };
                }
            }
            
            // Handle urgent requests - with knowledge base info
            if (lowerMessage.includes('æ€¥ã') || lowerMessage.includes('æ˜æ—¥') || lowerMessage.includes('ä»Šæ—¥')) {
                chatState.currentContext.urgent = true;
                if (window.companyKnowledge && window.companyKnowledge.faq.delivery.express) {
                    return {
                        text: `ãŠã£ã¨æ€¥ãã‹ãï¼ä»»ã›ã¦ã€œğŸ”¥\n\n${window.companyKnowledge.faq.delivery.express}ã ã‚ˆï¼ä½•ä½œã‚‹ï¼Ÿ`,
                        quickReplies: ['ååˆº', 'ãƒãƒ©ã‚·', 'ãƒã‚¹ã‚¿ãƒ¼', 'ãã®ä»–']
                    };
                } else {
                    return {
                        text: 'ãŠã£ã¨æ€¥ãã‹ãï¼ä»»ã›ã¦ã€œğŸ”¥ ä½•ä½œã‚‹ï¼Ÿ',
                        quickReplies: ['ååˆº', 'ãƒãƒ©ã‚·', 'ãƒã‚¹ã‚¿ãƒ¼', 'ãã®ä»–']
                    };
                }
            }
            
            // Handle delivery/shipping questions
            if (lowerMessage.match(/ç´æœŸ|ã„ã¤å±Š|é…é€|é€æ–™|ç™ºé€/)) {
                if (window.companyKnowledge && window.companyKnowledge.faq.delivery) {
                    const delivery = window.companyKnowledge.faq.delivery;
                    return {
                        text: `ç´æœŸã®ã“ã¨ï¼Ÿ\n\n${delivery.standard}\n${delivery.shipping}ã ã‚ˆã€œğŸ“¦`,
                        quickReplies: ['æ€¥ããªã‚“ã ã‘ã©', 'åœŸæ—¥ã‚‚å¯¾å¿œï¼Ÿ', 'é…é€ã‚¨ãƒªã‚¢ã¯ï¼Ÿ', 'é€æ–™ã„ãã‚‰ï¼Ÿ']
                    };
                }
            }
            
            // Handle payment questions
            if (lowerMessage.match(/æ”¯æ‰•|æ‰•ã„æ–¹|ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ|æŒ¯è¾¼|è«‹æ±‚æ›¸/)) {
                if (window.companyKnowledge && window.companyKnowledge.faq.payment) {
                    const payment = window.companyKnowledge.faq.payment;
                    return {
                        text: `æ”¯æ‰•ã„æ–¹æ³•ã­ï¼\n\n${payment.methods}\n${payment.invoice ? payment.invoice : ''}`,
                        quickReplies: ['è¦‹ç©ã‚‚ã‚Šã¯ç„¡æ–™ï¼Ÿ', 'åˆ†å‰²æ‰•ã„ã§ãã‚‹ï¼Ÿ', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã¯ï¼Ÿ', 'ã„ã¤æ”¯æ‰•ã„ï¼Ÿ']
                    };
                }
            }
            
            // Handle size selection for flyers
            if (chatState.currentContext.type === 'flyer' && !chatState.currentContext.size) {
                if (lowerMessage.match(/a4|a5|a6|a3|b4|b5/)) {
                    const sizeMatch = lowerMessage.match(/(a3|a4|a5|a6|b4|b5)/i);
                    chatState.currentContext.size = sizeMatch[0].toUpperCase();
                    return {
                        text: `${chatState.currentContext.size}ã‚µã‚¤ã‚ºã­ï¼ä½•éƒ¨ãã‚‰ã„ä½œã‚‹äºˆå®šï¼Ÿ`,
                        quickReplies: ['500éƒ¨', '1000éƒ¨', '3000éƒ¨', '5000éƒ¨ä»¥ä¸Š']
                    };
                }
            }
            
            // Handle "other" or "more" selections
            if (lowerMessage.match(/ãã®ä»–|ãã‚Œä»¥ä¸Š|ã‚‚ã£ã¨å¤šã„|ã‚‚ã£ã¨|ä»–ã®|ã»ã‹ã®|åˆ¥ã®/)) {
                // Check context to provide appropriate response
                if (chatState.currentContext.type === 'businessCard' && !chatState.currentContext.quantity) {
                    return {
                        text: '1000æšä»¥ä¸Šã ã¨å¤§é‡å°åˆ·å‰²å¼•ã‚‚ã‚ã‚‹ã‚ˆã€œï¼âœ¨\n\nå…·ä½“çš„ã«ä½•æšãã‚‰ã„ï¼Ÿ',
                        quickReplies: ['2000æš', '3000æš', '5000æš', '10000æšä»¥ä¸Š']
                    };
                } else if (chatState.currentContext.type === 'flyer' && !chatState.currentContext.quantity) {
                    return {
                        text: 'å¤§é‡å°åˆ·ã ã­ï¼ãŠå¾—ã«ãªã‚‹ã‚ˆã€œğŸ’•\n\nä½•éƒ¨ãã‚‰ã„ä½œã‚‹äºˆå®šï¼Ÿ',
                        quickReplies: ['10000éƒ¨', '20000éƒ¨', '50000éƒ¨', 'ç›¸è«‡ã—ãŸã„']
                    };
                } else if (chatState.currentContext.type === 'flyer' && !chatState.currentContext.size) {
                    return {
                        text: 'ç‰¹æ®Šãªã‚µã‚¤ã‚ºã‚‚OKã ã‚ˆï¼ã©ã‚“ãªã‚µã‚¤ã‚ºãŒã„ã„ï¼Ÿ',
                        quickReplies: ['B4ã‚µã‚¤ã‚º', 'A3ã‚µã‚¤ã‚º', 'æ­£æ–¹å½¢', 'ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ã‚º']
                    };
                } else if (chatState.currentContext.type === 'pamphlet') {
                    return {
                        text: 'ãƒšãƒ¼ã‚¸æ•°å¤šã‚ã®ã‚«ã‚¿ãƒ­ã‚°ã¨ã‹ã‹ãªï¼Ÿ\n\nä½•ãƒšãƒ¼ã‚¸ãã‚‰ã„ã«ãªã‚Šãã†ï¼Ÿ',
                        quickReplies: ['20ãƒšãƒ¼ã‚¸', '40ãƒšãƒ¼ã‚¸', '60ãƒšãƒ¼ã‚¸ä»¥ä¸Š', 'ç›¸è«‡ã—ãŸã„']
                    };
                } else {
                    // General "other" response
                    return {
                        text: 'ãã®ä»–ã®å°åˆ·ç‰©ã ã­ï¼ãªã‚“ã§ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã€œâœ¨\n\nã©ã‚“ãªã‚‚ã®ä½œã‚ŠãŸã„ï¼Ÿ',
                        quickReplies: ['ãƒã‚¹ã‚¿ãƒ¼', 'ã‚«ã‚¿ãƒ­ã‚°', 'ç‰¹æ®Šå°åˆ·', 'ç›¸è«‡ã—ãŸã„']
                    };
                }
            }
            
            // Handle quantity inputs
            if (lowerMessage.match(/\d+æš/) || lowerMessage.match(/\d+éƒ¨/)) {
                const qty = parseInt(lowerMessage.match(/\d+/)[0]);
                chatState.currentContext.quantity = qty;
                
                if (chatState.currentContext.type === 'businessCard') {
                    return {
                        text: `${qty}æšã­ï¼äº†è§£ã€œ ç‰‡é¢ï¼Ÿä¸¡é¢ï¼Ÿ`,
                        quickReplies: ['ç‰‡é¢', 'ä¸¡é¢']
                    };
                } else if (chatState.currentContext.type === 'flyer') {
                    return {
                        text: `${qty}éƒ¨ã­ï¼ã‚ªãƒƒã‚±ãƒ¼ ç‰‡é¢ï¼Ÿä¸¡é¢ï¼Ÿ`,
                        quickReplies: ['ç‰‡é¢', 'ä¸¡é¢']
                    };
                }
            }
            
            // Handle sides selection
            if (lowerMessage.includes('ç‰‡é¢') || lowerMessage.includes('ä¸¡é¢')) {
                chatState.currentContext.sides = lowerMessage.includes('ä¸¡é¢') ? 'ä¸¡é¢' : 'ç‰‡é¢';
                return {
                    text: 'ã‚«ãƒ©ãƒ¼ã«ã™ã‚‹ï¼Ÿãã‚Œã¨ã‚‚ãƒ¢ãƒã‚¯ãƒ­ï¼Ÿ',
                    quickReplies: ['ã‚«ãƒ©ãƒ¼', 'ãƒ¢ãƒã‚¯ãƒ­']
                };
            }
            
            // Handle color selection
            if (lowerMessage.includes('ã‚«ãƒ©ãƒ¼') || lowerMessage.includes('ãƒ¢ãƒã‚¯ãƒ­')) {
                chatState.currentContext.color = lowerMessage.includes('ã‚«ãƒ©ãƒ¼') ? 'ã‚«ãƒ©ãƒ¼' : 'ãƒ¢ãƒã‚¯ãƒ­';
                
                // If we have enough info, calculate estimate
                if (chatState.currentContext.type === 'businessCard' && 
                    chatState.currentContext.quantity && 
                    chatState.currentContext.sides && 
                    chatState.currentContext.color) {
                    
                    const result = priceCalculator.businessCard(
                        chatState.currentContext.quantity,
                        chatState.currentContext.sides,
                        chatState.currentContext.color
                    );
                    
                    return {
                        text: `ã‚ªãƒƒã‚±ãƒ¼ï¼ã¡ã‚‡ã£ã¨è¨ˆç®—ã™ã‚‹ã­ã€œğŸ’•`,
                        estimate: {
                            items: [
                                { label: 'å•†å“', value: 'ååˆºå°åˆ·' },
                                { label: 'æ•°é‡', value: `${chatState.currentContext.quantity}æš` },
                                { label: 'ä»•æ§˜', value: `${chatState.currentContext.sides}ãƒ»${chatState.currentContext.color}` },
                                { label: 'ä¾¡æ ¼å¸¯', value: `${result.range}ï¼ˆ${result.estimate.toLocaleString()}å††å‰å¾Œï¼‰` }
                            ],
                            note: 'â€»æ­£ç¢ºãªé‡‘é¡ã¯æ‹…å½“è€…ãŒæœ€çµ‚ç¢ºèªã—ã¾ã™'
                        },
                        followUp: 'æ€¥ããªã‚‰æ‹…å½“ã®äººã«ç¹‹ãã‘ã©ã€ã©ã†ã™ã‚‹ï¼Ÿ'
                    };
                } else if (chatState.currentContext.type === 'flyer' && 
                    chatState.currentContext.size &&
                    chatState.currentContext.quantity && 
                    chatState.currentContext.sides && 
                    chatState.currentContext.color) {
                    
                    const result = priceCalculator.flyer(
                        chatState.currentContext.size,
                        chatState.currentContext.quantity,
                        chatState.currentContext.sides,
                        chatState.currentContext.color
                    );
                    
                    return {
                        text: `ã¯ã„ã€è¨ˆç®—ã§ããŸã‚ˆã€œï¼`,
                        estimate: {
                            items: [
                                { label: 'å•†å“', value: 'ãƒãƒ©ã‚·å°åˆ·' },
                                { label: 'ã‚µã‚¤ã‚º', value: chatState.currentContext.size },
                                { label: 'æ•°é‡', value: `${chatState.currentContext.quantity}éƒ¨` },
                                { label: 'ä»•æ§˜', value: `${chatState.currentContext.sides}ãƒ»${chatState.currentContext.color}` },
                                { label: 'ä¾¡æ ¼å¸¯', value: `${result.range}ï¼ˆ${result.estimate.toLocaleString()}å††å‰å¾Œï¼‰` }
                            ],
                            note: 'â€»æ­£ç¢ºãªé‡‘é¡ã¯æ‹…å½“è€…ãŒæœ€çµ‚ç¢ºèªã—ã¾ã™'
                        },
                        followUp: 'ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ã‹ã‚‚å¿…è¦ï¼Ÿãã‚Œã¨ã‚‚å…¥ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚ã‚‹ï¼Ÿ'
                    };
                }
            }
            
            // Handle consultation requests
            if (lowerMessage.includes('ç›¸è«‡') || lowerMessage.includes('ã‚ã‹ã‚‰ãªã„') || lowerMessage.includes('æ•™ãˆã¦')) {
                return {
                    text: 'ã†ã‚“ã†ã‚“ã€ãªã‚“ã§ã‚‚ç›¸è«‡ã—ã¦ã€œï¼ä½•ã«å›°ã£ã¦ã‚‹ï¼ŸğŸ’•',
                    quickReplies: ['å°åˆ·ç‰©ã®ç¨®é¡', 'äºˆç®—ã«ã¤ã„ã¦', 'ç´æœŸã«ã¤ã„ã¦', 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚‚é ¼ã¿ãŸã„']
                };
            }
            
            // Handle design requests
            if (lowerMessage.includes('ãƒ‡ã‚¶ã‚¤ãƒ³')) {
                return {
                    text: 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚‚ã‚„ã‚‹ã‚ˆã€œï¼ç´ æã¨ã‹ã‚ã‚‹ï¼Ÿãƒ­ã‚´ã¨ã‹å†™çœŸã¨ã‹âœ¨',
                    quickReplies: ['ç´ æã‚ã‚Š', 'ä¸€éƒ¨ã‚ã‚Š', 'å…¨éƒ¨ãŠä»»ã›', 'ç›¸è«‡ã—ãŸã„']
                };
            }
            
            // Handle various printing products questions
            if (lowerMessage.match(/ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ|ã‚«ã‚¿ãƒ­ã‚°|å†Šå­/)) {
                if (!chatState.currentContext.type) {
                    chatState.currentContext.type = 'pamphlet';
                    return {
                        text: 'ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆã¨ã‹ã‚«ã‚¿ãƒ­ã‚°ã­ï¼ã„ã„ã‚ˆã€œâœ¨\n\nä½•ãƒšãƒ¼ã‚¸ãã‚‰ã„ã®äºˆå®šï¼Ÿ',
                        quickReplies: ['4ãƒšãƒ¼ã‚¸', '8ãƒšãƒ¼ã‚¸', '16ãƒšãƒ¼ã‚¸', 'ã‚‚ã£ã¨å¤šã„']
                    };
                }
            }
            
            if (lowerMessage.match(/ãƒã‚¹ã‚¿ãƒ¼|çœ‹æ¿|ã®ã¼ã‚Š/)) {
                return {
                    text: 'å¤§å‹å°åˆ·ç‰©ã ã­ï¼ã©ã‚Œä½œã‚‹ï¼Ÿâœ¨',
                    quickReplies: ['ãƒã‚¹ã‚¿ãƒ¼', 'çœ‹æ¿', 'ã®ã¼ã‚Š', 'æ¨ªæ–­å¹•']
                };
            }
            
            if (lowerMessage.match(/ã‚¹ãƒ†ãƒƒã‚«ãƒ¼|ã‚·ãƒ¼ãƒ«|ãƒ©ãƒ™ãƒ«/)) {
                return {
                    text: 'ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã¨ã‹ã‚·ãƒ¼ãƒ«ä½œã‚ŠãŸã„ã®ï¼Ÿã‹ã‚ã„ã„ã€œğŸ’•\n\nã©ã‚“ãªå½¢ãŒã„ã„ï¼Ÿ',
                    quickReplies: ['å››è§’å½¢', 'å††å½¢', 'ã‚ªãƒªã‚¸ãƒŠãƒ«å½¢çŠ¶', 'ã¾ã æ±ºã‚ã¦ãªã„']
                };
            }
            
            // Handle price questions with context awareness
            if (lowerMessage.match(/ã„ãã‚‰|å€¤æ®µ|æ–™é‡‘|ä¾¡æ ¼|è²»ç”¨|äºˆç®—|é«˜ã„|å®‰ã„/)) {
                // Check if we already know what they want to make
                if (chatState.currentContext.type) {
                    const productType = chatState.currentContext.type;
                    if (productType === 'website') {
                        return {
                            text: 'Webã‚µã‚¤ãƒˆã®åˆ¶ä½œè²»ç”¨ã­ï¼è¦æ¨¡ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã‘ã©...\n\nä¼æ¥­ã‚µã‚¤ãƒˆãªã‚‰30ä¸‡ã€œã€ECã‚µã‚¤ãƒˆãªã‚‰50ä¸‡ã€œãŒç›®å®‰ã‹ãªğŸ’•\n\nã©ã‚“ãªã‚µã‚¤ãƒˆã«ã—ãŸã„ï¼Ÿ',
                            quickReplies: ['ã‚·ãƒ³ãƒ—ãƒ«ãªä¼æ¥­ã‚µã‚¤ãƒˆ', 'ECã‚µã‚¤ãƒˆ', 'LPï¼ˆ1ãƒšãƒ¼ã‚¸ï¼‰', 'è©³ã—ã„è¦‹ç©ã‚‚ã‚Š']
                        };
                    } else if (productType === 'businessCard') {
                        return {
                            text: 'ååˆºã®å€¤æ®µã­ï¼æšæ•°ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã‘ã©...\n\n100æšãªã‚‰3000å††ã€œã€500æšãªã‚‰5000å††ã€œãã‚‰ã„ã‹ãªğŸ’•',
                            quickReplies: ['ãƒ‡ã‚¶ã‚¤ãƒ³è¾¼ã¿ã®å€¤æ®µ', 'ç‰¹æ®ŠåŠ å·¥ã®å€¤æ®µ', 'è©³ã—ã„è¦‹ç©ã‚‚ã‚Š', 'ä»–ã®æšæ•°']
                        };
                    } else if (productType === 'flyer') {
                        return {
                            text: 'ãƒãƒ©ã‚·ã®å€¤æ®µã­ï¼ã‚µã‚¤ã‚ºã¨æšæ•°æ¬¡ç¬¬ã ã‘ã©...\n\nA4ãƒ»1000éƒ¨ãªã‚‰1ä¸‡å††ã€œãã‚‰ã„ãŒç›®å®‰ğŸ’•',
                            quickReplies: ['ä»–ã®ã‚µã‚¤ã‚ºã®å€¤æ®µ', 'ã‚«ãƒ©ãƒ¼ã®å€¤æ®µ', 'è©³ã—ã„è¦‹ç©ã‚‚ã‚Š', 'ãƒ‡ã‚¶ã‚¤ãƒ³æ–™é‡‘']
                        };
                    }
                }
                
                // Check recent conversation for context
                if (chatState.conversationHistory.length > 0) {
                    const recentMessages = chatState.conversationHistory.slice(-3);
                    const lastUserMessage = recentMessages.filter(m => m.role === 'user').pop();
                    
                    if (lastUserMessage) {
                        if (lastUserMessage.content.match(/web|ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸|ã‚µã‚¤ãƒˆ/i)) {
                            chatState.currentContext.type = 'website';
                            return {
                                text: 'Webã‚µã‚¤ãƒˆã®åˆ¶ä½œè²»ç”¨ã­ï¼è¦æ¨¡ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã‘ã©...\n\nä¼æ¥­ã‚µã‚¤ãƒˆãªã‚‰30ä¸‡ã€œã€ECã‚µã‚¤ãƒˆãªã‚‰50ä¸‡ã€œãŒç›®å®‰ã‹ãªğŸ’•\n\nã©ã‚“ãªã‚µã‚¤ãƒˆã«ã—ãŸã„ï¼Ÿ',
                                quickReplies: ['ã‚·ãƒ³ãƒ—ãƒ«ãªä¼æ¥­ã‚µã‚¤ãƒˆ', 'ECã‚µã‚¤ãƒˆ', 'LPï¼ˆ1ãƒšãƒ¼ã‚¸ï¼‰', 'è©³ã—ã„è¦‹ç©ã‚‚ã‚Š']
                            };
                        }
                    }
                }
                
                // Default response if no context
                return {
                    text: 'å€¤æ®µæ°—ã«ãªã‚‹ã‚ˆã­ã€œï¼\n\nä½•ã‚’ä½œã‚ŠãŸã„ã‹æ•™ãˆã¦ãã‚ŒãŸã‚‰ã€ã™ãæ¦‚ç®—å‡ºã™ã‚ˆğŸ’•',
                    quickReplies: ['ååˆºã®å€¤æ®µ', 'ãƒãƒ©ã‚·ã®å€¤æ®µ', 'ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆã®å€¤æ®µ', 'è¦‹ç©ã‚‚ã‚Šã‚’ã‚‚ã‚‰ã†']
                };
            }
            
            // Handle timeline questions
            if (lowerMessage.match(/ã„ã¤|ç´æœŸ|ä½•æ—¥|æœŸé–“|æ™‚é–“|æ€¥ã|è‡³æ€¥/)) {
                chatState.currentContext.urgent = true;
                return {
                    text: 'ç´æœŸã®ã“ã¨ï¼Ÿé€šå¸¸ã¯3ã€œ5å–¶æ¥­æ—¥ã ã‘ã©ã€æ€¥ããªã‚‰ç›¸è«‡ã®ã‚‹ã‚ˆã€œï¼ğŸ”¥\n\nã„ã¤ã¾ã§ã«å¿…è¦ï¼Ÿ',
                    quickReplies: ['ä»Šæ—¥ä¸­', 'æ˜æ—¥ã¾ã§', '3æ—¥ä»¥å†…', '1é€±é–“ä»¥å†…']
                };
            }
            
            // Handle design questions
            if (lowerMessage.match(/ãƒ‡ã‚¶ã‚¤ãƒ³|ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ|ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ|ã‚µãƒ³ãƒ—ãƒ«|è¦‹æœ¬/)) {
                return {
                    text: 'ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç›¸è«‡ã­ï¼ã‚ã£ã¡ã‚ƒå¾—æ„ã€œâœ¨\n\nã©ã‚“ãªæ„Ÿã˜ãŒã„ã„ï¼Ÿ',
                    quickReplies: ['ãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚‰é¸ã¶', 'ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³', 'ãƒ‡ã‚¶ã‚¤ãƒ³æŒã¡è¾¼ã¿', 'ãŠã¾ã‹ã›']
                };
            }
            
            // Handle process questions
            if (lowerMessage.match(/ã©ã†ã‚„ã£ã¦|æ–¹æ³•|æµã‚Œ|æ‰‹é †|æ³¨æ–‡|é ¼ã¿æ–¹/)) {
                return {
                    text: 'æ³¨æ–‡ã®æµã‚Œèª¬æ˜ã™ã‚‹ã­ã€œï¼\n\n1. ä½œã‚ŠãŸã„ã‚‚ã®æ±ºã‚ã‚‹\n2. ä»•æ§˜ï¼ˆã‚µã‚¤ã‚ºãƒ»æšæ•°ãªã©ï¼‰æ±ºã‚ã‚‹\n3. ãƒ‡ã‚¶ã‚¤ãƒ³ç›¸è«‡\n4. è¦‹ç©ã‚‚ã‚Šç¢ºèª\n5. æ³¨æ–‡ç¢ºå®šï¼\n\nç°¡å˜ã§ã—ã‚‡ï¼ŸğŸ’•',
                    quickReplies: ['ä»Šã™ãå§‹ã‚ã‚‹', 'è¦‹ç©ã‚‚ã‚Šã ã‘', 'ãƒ‡ã‚¶ã‚¤ãƒ³ç›¸è«‡', 'ã‚‚ã£ã¨è©³ã—ã']
                };
            }
            
            // Handle company/service questions
            if (lowerMessage.match(/ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢|ä¼šç¤¾|å–¶æ¥­æ™‚é–“|å ´æ‰€|ä½æ‰€|é›»è©±/)) {
                return {
                    text: 'ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ã®ã“ã¨çŸ¥ã‚ŠãŸã„ã®ï¼Ÿ\n\nå°åˆ·ã‹ã‚‰Webåˆ¶ä½œã¾ã§ã€ãªã‚“ã§ã‚‚ã‚„ã£ã¦ã‚‹ä¼šç¤¾ã ã‚ˆã€œï¼\n24æ™‚é–“ã„ã¤ã§ã‚‚ç›¸è«‡OKï¼ˆã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ãŒï¼‰âœ¨',
                    quickReplies: ['ä¼šç¤¾æ¦‚è¦', 'å–¶æ¥­æ™‚é–“', 'ã‚¢ã‚¯ã‚»ã‚¹', 'ãŠå•ã„åˆã‚ã›']
                };
            }
            
            // Handle quality questions
            if (lowerMessage.match(/å“è³ª|ãã‚Œã„|ç”»è³ª|ç´™|ç´ æ|åŠ å·¥/)) {
                return {
                    text: 'å“è³ªã«ã“ã ã‚ã‚‹ã®ã€ã„ã„ã­ã€œï¼âœ¨\n\nã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ã¯é«˜å“è³ªå°åˆ·ãŒè‡ªæ…¢ã ã‚ˆğŸ’•\nç´™ã®ç¨®é¡ã‚‚åŠ å·¥ã‚‚ã„ã‚ã„ã‚ã‚ã‚‹ã‹ã‚‰ã€ç›¸è«‡ã—ã¦ã¿ã¦ï¼',
                    quickReplies: ['ç´™ã®ç¨®é¡', 'ç‰¹æ®ŠåŠ å·¥', 'ã‚µãƒ³ãƒ—ãƒ«è«‹æ±‚', 'å“è³ªã«ã¤ã„ã¦']
                };
            }
            
            // Handle comparison questions
            if (lowerMessage.match(/é•ã„|ã©ã£ã¡|æ¯”è¼ƒ|ãŠã™ã™ã‚|ã©ã‚Œ/)) {
                return {
                    text: 'è¿·ã£ã¦ã‚‹æ„Ÿã˜ï¼Ÿã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ãŒç›¸è«‡ã®ã‚‹ã‚ˆã€œï¼\n\nä½•ã¨ä½•ã§è¿·ã£ã¦ã‚‹ï¼Ÿ',
                    quickReplies: ['ãƒãƒ©ã‚·vsãƒã‚¹ã‚¿ãƒ¼', 'ã‚«ãƒ©ãƒ¼vsãƒ¢ãƒã‚¯ãƒ­', 'ç´™ã®ç¨®é¡ã§è¿·ã†', 'ãŠã™ã™ã‚æ•™ãˆã¦']
                };
            }
            
            // Handle generic business/work related keywords
            if (lowerMessage.match(/ä»•äº‹|ãƒ“ã‚¸ãƒã‚¹|æ¥­å‹™|ä¼šç¤¾|ä¼æ¥­|ãŠåº—|åº—èˆ—/)) {
                return {
                    text: 'ãŠä»•äº‹ã§ä½¿ã†ã‚‚ã®ã ã­ï¼ã©ã‚“ãªã®å¿…è¦ï¼Ÿâœ¨',
                    quickReplies: ['ååˆº', 'ãƒãƒ©ã‚·ãƒ»ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ', 'çœ‹æ¿ãƒ»ãƒã‚¹ã‚¿ãƒ¼', 'ãã®ä»–']
                };
            }
            
            // Handle uncertain/undecided responses with context
            if (lowerMessage.match(/ã¾ã |æ±ºã‚ã¦|ãã‚ã¦|ã‚ã‹ã‚‰ãªã„|ä¸æ˜|æœªå®š|æ¤œè¨ä¸­/)) {
                // Check what we were talking about
                if (chatState.lastQuestion && chatState.lastQuestion.includes('ãƒšãƒ¼ã‚¸')) {
                    return {
                        text: 'ãƒšãƒ¼ã‚¸æ•°ã¾ã æ±ºã¾ã£ã¦ãªã„ã®ã­ã€œ\n\nå†…å®¹ã®é‡ã¨ã‹äºˆç®—ã‹ã‚‰ä¸€ç·’ã«è€ƒãˆã‚ˆã£ã‹ï¼ŸğŸ’•',
                        quickReplies: ['äºˆç®—ã‹ã‚‰è€ƒãˆã‚‹', 'å†…å®¹é‡ã‹ã‚‰è€ƒãˆã‚‹', 'ã‚µãƒ³ãƒ—ãƒ«è¦‹ãŸã„', 'æ‹…å½“è€…ã«ç›¸è«‡']
                    };
                } else if (chatState.lastQuestion && (chatState.lastQuestion.includes('æš') || chatState.lastQuestion.includes('éƒ¨'))) {
                    return {
                        text: 'æ•°é‡è¿·ã†ã‚ˆã­ã€œï¼\n\næœ€å°ãƒ­ãƒƒãƒˆã‹ã‚‰å§‹ã‚ã¦ã€å¿…è¦ã«å¿œã˜ã¦è¿½åŠ å°åˆ·ã‚‚ã§ãã‚‹ã‚ˆğŸ’•',
                        quickReplies: ['æœ€å°ãƒ­ãƒƒãƒˆã¯ï¼Ÿ', 'è¿½åŠ å°åˆ·ã«ã¤ã„ã¦', 'äºˆç®—ã‹ã‚‰æ±ºã‚ã‚‹', 'ç”¨é€”ã‹ã‚‰ç›¸è«‡']
                    };
                } else {
                    return {
                        text: 'ã¾ã æ±ºã¾ã£ã¦ãªã„ã‚“ã ã­ã€œ å¤§ä¸ˆå¤«ï¼\n\nä¸€ç·’ã«è€ƒãˆã‚ˆï¼Ÿã©ã‚“ãªã‚·ãƒ¼ãƒ³ã§ä½¿ã†äºˆå®šï¼ŸğŸ’•',
                        quickReplies: ['ãƒ“ã‚¸ãƒã‚¹ç”¨', 'ã‚¤ãƒ™ãƒ³ãƒˆç”¨', 'å€‹äººç”¨', 'ã¨ã‚Šã‚ãˆãšç›¸è«‡']
                    };
                }
            }
            
            // Handle consultation requests - improved with context
            if (lowerMessage.match(/ç›¸è«‡|ã‚ã‹ã‚‰ãªã„|æ•™ãˆã¦|åˆã‚ã¦|ã¯ã˜ã‚ã¦|å›°ã£ã¦|æ‚©ã‚“ã§/)) {
                // If we have context from the last question, provide specific help
                if (chatState.lastQuestion) {
                    if (chatState.lastQuestion.includes('ãƒšãƒ¼ã‚¸')) {
                        return {
                            text: 'ãƒšãƒ¼ã‚¸æ•°ã®ç›¸è«‡ã­ï¼äºˆç®—ã¨ã‹ç”¨é€”ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã‘ã©...\n\nã©ã‚“ãªã‚«ã‚¿ãƒ­ã‚°ä½œã‚‹äºˆå®šï¼Ÿå•†å“ç´¹ä»‹ï¼Ÿä¼šç¤¾æ¡ˆå†…ï¼Ÿ',
                            quickReplies: ['å•†å“ã‚«ã‚¿ãƒ­ã‚°', 'ä¼šç¤¾æ¡ˆå†…', 'ã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹', 'ç·åˆã‚«ã‚¿ãƒ­ã‚°']
                        };
                    } else if (chatState.lastQuestion.includes('ã‚µã‚¤ã‚º')) {
                        return {
                            text: 'ã‚µã‚¤ã‚ºé¸ã³ã®ç›¸è«‡ã­ï¼ç”¨é€”ã«ã‚ˆã£ã¦ãŠã™ã™ã‚å¤‰ã‚ã‚‹ã‚ˆã€œ\n\næŒã¡é‹ã¶ï¼Ÿé…ã‚‹ï¼Ÿæ²ç¤ºã™ã‚‹ï¼Ÿ',
                            quickReplies: ['æŒã¡é‹ã³ç”¨', 'é…å¸ƒç”¨', 'æ²ç¤ºç”¨', 'ãã®ä»–ã®ç”¨é€”']
                        };
                    } else if (chatState.currentContext.type) {
                        // We're in the middle of a specific product conversation
                        return {
                            text: `${chatState.currentContext.type === 'businessCard' ? 'ååˆº' : chatState.currentContext.type === 'flyer' ? 'ãƒãƒ©ã‚·' : 'ã‚«ã‚¿ãƒ­ã‚°'}ã®ç›¸è«‡ã­ï¼\n\nã©ã‚“ãªã“ã¨ãŒæ°—ã«ãªã‚‹ï¼Ÿ`,
                            quickReplies: ['ãƒ‡ã‚¶ã‚¤ãƒ³', 'ä¾¡æ ¼', 'ç´æœŸ', 'ä»•æ§˜å…¨èˆ¬']
                        };
                    }
                }
                
                // Generic consultation response
                return {
                    text: 'ãªã‚“ã§ã‚‚ç›¸è«‡ã—ã¦ã€œï¼ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ãŒã„ã‚‹ã‹ã‚‰å¤§ä¸ˆå¤«ğŸ’•\n\nã©ã‚“ãªã“ã¨ã§å›°ã£ã¦ã‚‹ï¼Ÿ',
                    quickReplies: ['ä½•ã‚’ä½œã‚Œã°ã„ã„ã‹', 'äºˆç®—ã®ç›¸è«‡', 'ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç›¸è«‡', 'ç´æœŸã®ç›¸è«‡']
                };
            }
            
            // Handle yes/no questions
            if (lowerMessage.match(/ã§ãã‚‹[ï¼Ÿ?]|ã§ãã¾ã™[ã‹ï¼Ÿ?]|å¯èƒ½[ï¼Ÿ?]|ã‚ã‚‹[ï¼Ÿ?]|ã‚ã‚Šã¾/)) {
                return {
                    text: 'ã§ãã‚‹ã‹ã©ã†ã‹æ°—ã«ãªã‚‹ã‚ˆã­ï¼\n\nã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ã¯ã»ã¨ã‚“ã©ã®ã“ã¨å¯¾å¿œã—ã¦ã‚‹ã‹ã‚‰ã€å…·ä½“çš„ã«èã„ã¦ã¿ã¦ã€œâœ¨',
                    quickReplies: ['å¯¾å¿œã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§', 'ç‰¹æ®Šãªå°åˆ·', 'ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œ', 'æ€¥ãã®å¯¾å¿œ']
                };
            }
            
            // Handle thank you
            if (lowerMessage.match(/ã‚ã‚ŠãŒã¨|æ„Ÿè¬|åŠ©ã‹ã‚‹|ãŸã™ã‹ã‚‹/)) {
                return {
                    text: 'ã©ã†ã„ãŸã—ã¾ã—ã¦ã€œï¼ğŸ’•\n\nã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ã¯ã„ã¤ã§ã‚‚ã“ã“ã«ã„ã‚‹ã‹ã‚‰ã€ã¾ãŸä½•ã‹ã‚ã£ãŸã‚‰ç›¸è«‡ã—ã¦ã­âœ¨',
                    quickReplies: ['ä»–ã«ã‚‚ç›¸è«‡', 'è¦‹ç©ã‚‚ã‚Šã‚’ã‚‚ã‚‰ã†', 'æ³¨æ–‡ã™ã‚‹', 'ã¾ãŸä»Šåº¦']
                };
            }
            
            // Handle new consultation or reset
            if (lowerMessage.match(/æ–°ã—ã|åˆ¥ã®|é•ã†|ä»–ã®ç›¸è«‡|ãƒªã‚»ãƒƒãƒˆ|æœ€åˆã‹ã‚‰/)) {
                // Reset context for new consultation
                chatState.currentContext = {};
                chatState.lastQuestion = null;
                return {
                    text: 'ã‚ªãƒƒã‚±ãƒ¼ï¼æ–°ã—ã„ç›¸è«‡ã­ã€œâœ¨\n\nä½•ä½œã‚ŠãŸã„ï¼Ÿ',
                    quickReplies: ['å°åˆ·ç‰©', 'Webã‚µã‚¤ãƒˆ', 'ãƒ‡ã‚¶ã‚¤ãƒ³', 'ã¾ã æ±ºã‚ã¦ãªã„']
                };
            }
            
            // Handle goodbye
            if (lowerMessage.match(/ã•ã‚ˆãªã‚‰|ã˜ã‚ƒã‚ã­|ã¾ãŸã­|ã°ã„ã°ã„|å¤±ç¤¼/)) {
                // Reset context when saying goodbye
                chatState.currentContext = {};
                chatState.lastQuestion = null;
                return {
                    text: 'ã°ã„ã°ã€œã„ï¼ğŸ‘‹\n\nã¾ãŸå°åˆ·ã®ã“ã¨ç›¸è«‡ã—ã¦ã­ã€œğŸ’•',
                    quickReplies: ['ã‚„ã£ã±ã‚Šã‚‚ã†ä¸€ã¤', 'è¦‹ç©ã‚‚ã‚Šä¿å­˜', 'ã¾ãŸæ¥ã‚‹', 'é–‰ã˜ã‚‹']
                };
            }
            
            // Handle handoff requests
            if (lowerMessage.includes('æ‹…å½“') || lowerMessage.includes('å¼•ãç¶™') || lowerMessage.includes('äººé–“')) {
                // Set context that we're waiting for handoff confirmation
                chatState.currentContext.waitingForHandoff = true;
                return {
                    text: 'æ€¥ããªã‚‰æ‹…å½“ã®äººã«ç¹‹ãã‘ã©ã€ã©ã†ã™ã‚‹ï¼ŸğŸ¤”',
                    quickReplies: ['ãŠé¡˜ã„', 'ã‚‚ã†å°‘ã—ç›¸è«‡', 'è‡ªåˆ†ã§æ±ºã‚ã‚‹', 'è€ƒãˆã•ã›ã¦']
                };
            }
            
            // Handle any remaining printing/work related keywords
            if (lowerMessage.match(/ä½œã‚‹|ã¤ãã‚‹|åˆ¶ä½œ|è£½ä½œ|ç™ºæ³¨|æ³¨æ–‡|ä¾é ¼/)) {
                return {
                    text: 'ãªã«ã‹ä½œã‚ŠãŸã„ã‚“ã ã­ï¼ã„ã„ã‚ˆã€œğŸ’•\n\nã©ã‚“ãªã‚‚ã®ã‚’ä½œã‚‹äºˆå®šï¼Ÿ',
                    quickReplies: ['å°åˆ·ç‰©', 'Webã‚µã‚¤ãƒˆ', 'ãƒ‡ã‚¶ã‚¤ãƒ³', 'ã¾ã æ±ºã‚ã¦ãªã„']
                };
            }
            
            // Handle color/material questions
            if (lowerMessage.match(/è‰²|ã‚«ãƒ©ãƒ¼|ç™½é»’|ãƒ¢ãƒã‚¯ãƒ­/)) {
                return {
                    text: 'è‰²ã®ã“ã¨æ°—ã«ãªã‚‹ï¼Ÿã‚«ãƒ©ãƒ¼ã§ã‚‚ç™½é»’ã§ã‚‚ã‚­ãƒ¬ã‚¤ã«å°åˆ·ã§ãã‚‹ã‚ˆã€œâœ¨',
                    quickReplies: ['ã‚«ãƒ©ãƒ¼å°åˆ·', 'ãƒ¢ãƒã‚¯ãƒ­å°åˆ·', 'è‰²ã«ã¤ã„ã¦ç›¸è«‡', 'ã‚µãƒ³ãƒ—ãƒ«è¦‹ãŸã„']
                };
            }
            
            // Handle size questions
            if (lowerMessage.match(/ã‚µã‚¤ã‚º|å¤§ãã•|å¯¸æ³•|[aAbB][0-9]/)) {
                return {
                    text: 'ã‚µã‚¤ã‚ºã®ç›¸è«‡ã­ï¼ã©ã‚Œãã‚‰ã„ã®å¤§ãã•ãŒã„ã„ï¼Ÿ',
                    quickReplies: ['ååˆºã‚µã‚¤ã‚º', 'A4ã‚µã‚¤ã‚º', 'ãƒã‚¹ã‚¿ãƒ¼ã‚µã‚¤ã‚º', 'ã‚µã‚¤ã‚ºç›¸è«‡']
                };
            }
            
            // Knowledge base search for company information
            if (window.searchKnowledge) {
                const knowledgeResults = searchKnowledge(userMessage);
                
                // Handle company information questions
                if (lowerMessage.match(/ä¼šç¤¾|ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢|ä½æ‰€|å ´æ‰€|å–¶æ¥­æ™‚é–“|é›»è©±|é€£çµ¡å…ˆ|å®šä¼‘æ—¥/)) {
                    const companyInfo = window.companyKnowledge.companyInfo;
                    
                    if (lowerMessage.match(/ä½æ‰€|å ´æ‰€|ã©ã“/)) {
                        return {
                            text: `ã‚¹ãƒã‚¤ãƒ‡ã‚£ã‚¢ã®å ´æ‰€ï¼Ÿ\n\næœ¬ç¤¾ã¯${companyInfo.headquarters}ã ã‚ˆã€œ\n${companyInfo.businessHours}ã«ã‚„ã£ã¦ã‚‹ã‚ˆğŸ’•`,
                            quickReplies: ['ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•', 'ä»–ã®å–¶æ¥­æ‰€', 'å–¶æ¥­æ™‚é–“', 'åœ°å›³ã‚’è¦‹ã‚‹']
                        };
                    }
                    
                    if (lowerMessage.match(/å–¶æ¥­æ™‚é–“|ä½•æ™‚|ã„ã¤/)) {
                        return {
                            text: `å–¶æ¥­æ™‚é–“ã¯${companyInfo.businessHours}ã ã‚ˆã€œ\n\n${companyInfo.holidays}ã¯ãŠä¼‘ã¿ãªã®ğŸ’¤`,
                            quickReplies: ['ä»Šæ—¥ã¯å–¶æ¥­ï¼Ÿ', 'é€£çµ¡å…ˆæ•™ãˆã¦', 'å ´æ‰€ã¯ã©ã“ï¼Ÿ', 'æ€¥ãã®ç›¸è«‡']
                        };
                    }
                    
                    if (lowerMessage.match(/é›»è©±|é€£çµ¡/)) {
                        return {
                            text: `é›»è©±ç•ªå·ã¯${companyInfo.phone}ã ã‚ˆã€œğŸ“\n\nãƒ¡ãƒ¼ãƒ«ãªã‚‰${companyInfo.email}ã«é€ã£ã¦ğŸ’Œ`,
                            quickReplies: ['å–¶æ¥­æ™‚é–“ã¯ï¼Ÿ', 'LINEé€£çµ¡ã§ãã‚‹ï¼Ÿ', 'å ´æ‰€æ•™ãˆã¦', 'Webå•ã„åˆã‚ã›']
                        };
                    }
                }
                
                // Handle location/access questions
                if (lowerMessage.match(/ã‚¢ã‚¯ã‚»ã‚¹|è¡Œãæ–¹|é§è»Šå ´|æœ€å¯„ã‚Šé§…/)) {
                    const locations = window.companyKnowledge.locations;
                    return {
                        text: `æœ¬ç¤¾ã¯${locations.headquarters.access}ã«ã‚ã‚‹ã‚ˆã€œ\n\n${locations.headquarters.landmark}ãŒç›®å°ï¼é§è»Šå ´ã‚‚ã‚ã‚‹ã‚ˆğŸš—`,
                        quickReplies: ['åœ°å›³ã‚’è¦‹ã‚‹', 'æ±äº¬ã‚ªãƒ•ã‚£ã‚¹ã¯ï¼Ÿ', 'ä»–ã®å–¶æ¥­æ‰€', 'å–¶æ¥­æ™‚é–“']
                    };
                }
                
                // Handle service-specific questions with knowledge base
                if (knowledgeResults.length > 0) {
                    // Business cards
                    if (lowerMessage.includes('ååˆº') && knowledgeResults.find(r => r.name === 'ååˆºå°åˆ·')) {
                        const service = knowledgeResults.find(r => r.name === 'ååˆºå°åˆ·');
                        return {
                            text: `ååˆºã®ã“ã¨ã­ï¼âœ¨\n\n${service.sizes.join('ã€')}ã«å¯¾å¿œã—ã¦ã‚‹ã‚ˆã€œ\n${service.options.join('ã€')}ã‚‚ã§ãã‚‹ã‹ã‚‰ç›¸è«‡ã—ã¦ğŸ’•`,
                            quickReplies: ['æ–™é‡‘çŸ¥ã‚ŠãŸã„', 'ç´æœŸã¯ï¼Ÿ', 'ãƒ‡ã‚¶ã‚¤ãƒ³ç›¸è«‡', 'ã‚µãƒ³ãƒ—ãƒ«è¦‹ãŸã„']
                        };
                    }
                    
                    // Web services
                    if (lowerMessage.match(/web|ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸|ã‚µã‚¤ãƒˆ/) && knowledgeResults.find(r => r.name === 'Webã‚µã‚¤ãƒˆåˆ¶ä½œ')) {
                        const service = knowledgeResults.find(r => r.name === 'Webã‚µã‚¤ãƒˆåˆ¶ä½œ');
                        // Set context type to website
                        chatState.currentContext.type = 'website';
                        return {
                            text: `Webã‚µã‚¤ãƒˆåˆ¶ä½œã‚‚ã‚„ã£ã¦ã‚‹ã‚ˆã€œï¼ğŸ’»\n\n${service.description}\n${service.cms}ã‚‚å¯¾å¿œã—ã¦ã‚‹ã‚ˆâœ¨`,
                            quickReplies: ['åˆ¶ä½œè²»ç”¨ã¯ï¼Ÿ', 'ECã‚µã‚¤ãƒˆã‚‚ï¼Ÿ', 'LPåˆ¶ä½œã¯ï¼Ÿ', 'åˆ¶ä½œæœŸé–“ã¯ï¼Ÿ']
                        };
                    }
                }
                
                // Handle glossary terms
                const glossaryTerms = Object.keys(window.companyKnowledge.glossary);
                for (const term of glossaryTerms) {
                    if (lowerMessage.includes(term.toLowerCase())) {
                        return {
                            text: `${term}ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã®ï¼Ÿ\n\n${window.companyKnowledge.glossary[term]}ã ã‚ˆã€œï¼ã‚ã‹ã‚Šã‚„ã™ã„ã§ã—ã‚‡ï¼ŸğŸ’•`,
                            quickReplies: ['ä»–ã®ç”¨èªã‚‚æ•™ãˆã¦', 'è¦‹ç©ã‚‚ã‚Šã»ã—ã„', 'ã‚‚ã£ã¨è©³ã—ã', 'ã‚ã‚ŠãŒã¨ã†']
                        };
                    }
                }
            }
            
            // Default response if nothing else matches
            return {
                text: 'ã”ã‚ã‚“ã­ã€œï¼ã¡ã‚‡ã£ã¨ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸğŸ’¦\n\nå°åˆ·ã®ã“ã¨ã¨ã‹èã„ã¦ãã‚ŒãŸã‚‰ç­”ãˆã‚‰ã‚Œã‚‹ã‚ˆï¼',
                quickReplies: ['å°åˆ·ã®ç›¸è«‡', 'æ–™é‡‘ã‚’çŸ¥ã‚ŠãŸã„', 'ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§', 'æ‹…å½“è€…ã¨è©±ã™']
            };
        };

        // UI Functions
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} ${isUser ? 'user-message-slide-in' : 'message-slide-in'}`;
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="max-w-xs px-4 py-2 rounded-lg bg-gray-700 text-white">
                        ${content}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden bg-white border border-gray-300 flex-shrink-0">
                            <div class="w-full h-full smaichan-avatar smaichan-avatar-normal"></div>
                        </div>
                        <div class="max-w-xs px-4 py-2 rounded-lg bg-white border border-gray-200">
                            ${content}
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addEstimate(estimate) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start message-slide-in';
            
            let estimateHTML = '<div class="price-card rounded-lg p-4 mt-2"><div class="font-bold text-gray-800 mb-2">ğŸ“‹ æ¦‚ç®—ãŠè¦‹ç©ã‚‚ã‚Š</div>';
            
            estimate.items.forEach(item => {
                estimateHTML += `
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">${item.label}:</span>
                        <span class="text-gray-800">${item.value}</span>
                    </div>
                `;
            });
            
            if (estimate.note) {
                estimateHTML += `<div class="mt-2 text-xs text-gray-500">${estimate.note}</div>`;
            }
            
            estimateHTML += '</div>';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 rounded-full overflow-hidden bg-white border border-gray-300 flex-shrink-0">
                        <div class="w-full h-full smaichan-avatar"></div>
                    </div>
                    <div class="max-w-xs">
                        ${estimateHTML}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateQuickReplies(replies) {
            const container = document.getElementById('quickReplies');
            container.innerHTML = '';
            
            if (replies && replies.length > 0) {
                replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors';
                    button.textContent = reply;
                    button.onclick = () => {
                        document.getElementById('messageInput').value = reply;
                        sendMessage();
                    };
                    container.appendChild(button);
                });
            }
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.remove('hidden');
            changeAvatarExpression('thinking');
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || chatState.isTyping) return;
            
            // Add user message
            addMessage(message, true);
            chatState.conversationHistory.push({ role: 'user', content: message });
            
            // Clear input and quick replies
            input.value = '';
            updateQuickReplies([]);
            
            // Disable input while processing
            chatState.isTyping = true;
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Show typing indicator
            showTyping();
            
            // Simulate processing delay
            await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
            
            // Generate response
            const response = generateResponse(message);
            
            // Change avatar expression based on response emotion
            if (response.emotion) {
                changeAvatarExpression(response.emotion);
            }
            
            // Hide typing
            hideTyping();
            
            // Add bot response
            addMessage(response.text);
            chatState.conversationHistory.push({ role: 'bot', content: response.text });
            
            // Store the bot's question for context
            chatState.lastQuestion = response.text;
            
            // Add estimate if present
            if (response.estimate) {
                await new Promise(resolve => setTimeout(resolve, 500));
                addEstimate(response.estimate);
            }
            
            // Add follow-up if present
            if (response.followUp) {
                await new Promise(resolve => setTimeout(resolve, 500));
                addMessage(response.followUp);
            }
            
            // Handle handoff
            if (response.handoff) {
                await new Promise(resolve => setTimeout(resolve, 500));
                addMessage('30åˆ†ä»¥å†…ã«æ‹…å½“è€…ã‹ã‚‰é€£çµ¡ã™ã‚‹ã‹ã‚‰ã€ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã¦ã­ã€œï¼ğŸ“');
                
                // Save lead data
                const leadData = {
                    timestamp: new Date().toISOString(),
                    context: chatState.currentContext,
                    conversation: chatState.conversationHistory
                };
                
                const leads = JSON.parse(localStorage.getItem('smaichan_leads') || '[]');
                leads.push(leadData);
                localStorage.setItem('smaichan_leads', JSON.stringify(leads));
            }
            
            // Update quick replies
            updateQuickReplies(response.quickReplies);
            
            // Re-enable input
            chatState.isTyping = false;
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            input.focus();
        }

        // Event listeners
        document.getElementById('chatBubble').addEventListener('click', function() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('hidden');
            chatWindow.classList.toggle('flex');
            document.getElementById('notificationBadge').classList.add('hidden');
            
            if (!chatState.isOpen) {
                chatState.isOpen = true;
                addMessage('ã‚„ã£ã»ãƒ¼ï¼ã‚¹ãƒã‚¤ã¡ã‚ƒã‚“ã ã‚ˆã€œâœ¨<br><br>å°åˆ·ã®ã“ã¨ãªã‚‰ä½•ã§ã‚‚èã„ã¦ï¼<br>ååˆºã€ãƒãƒ©ã‚·ã€ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆã€Webã‚µã‚¤ãƒˆåˆ¶ä½œã¾ã§å¯¾å¿œã—ã¦ã‚‹ã‚ˆğŸ’•<br><br>ä»Šæ—¥ã¯ã©ã‚“ãªã®ä½œã‚ŠãŸã„æ„Ÿã˜ï¼Ÿ');
                updateQuickReplies(['ååˆºã‚’ä½œã‚ŠãŸã„', 'ãƒãƒ©ã‚·ã®è¦‹ç©ã‚‚ã‚Š', 'æ€¥ãã§å°åˆ·ã—ãŸã„', 'ç›¸è«‡ã—ãŸã„']);
            }
            
            document.getElementById('messageInput').focus();
        });

        document.getElementById('closeChat').addEventListener('click', function() {
            document.getElementById('chatWindow').classList.add('hidden');
            document.getElementById('chatWindow').classList.remove('flex');
        });

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('sendButton').addEventListener('click', sendMessage);

        // Three.js setup
        let scene, camera, renderer, logoGroup;
        let layers = [];
        let mouseX = 0, mouseY = 0;
        let targetX = 0, targetY = 0;

        function init3DLogo() {
            console.log('Initializing 3D logo...');
            
            // Scene setup
            scene = new THREE.Scene();
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            camera.position.z = 5;

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true 
            });
            renderer.setSize(800, 800);
            renderer.setClearColor(0x000000, 0);
            
            const container = document.getElementById('canvas-container');
            if (!container) {
                console.error('Canvas container not found!');
                return;
            }
            container.appendChild(renderer.domElement);
            console.log('Canvas added to container');

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // Create logo group
            logoGroup = new THREE.Group();
            scene.add(logoGroup);

            // Define colors for each layer (SUMAIDIA orange colors)
            const colors = [
                0xFF6B00,  // Deep Orange
                0xFF8C42,  // Medium Orange
                0xFFAA66,  // Light Orange
                0xFFCC99   // Lightest Orange
            ];

            // Create 4 layers with different shapes
            for (let i = 0; i < 4; i++) {
                const geometry = createLayerGeometry(i);
                const material = new THREE.MeshPhongMaterial({
                    color: colors[i],
                    shininess: 100,
                    specular: 0x222222,
                    transparent: true,
                    opacity: 1.0
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.z = (i - 1.5) * 0.4;
                
                layers.push(mesh);
                logoGroup.add(mesh);
            }

            // Mouse move event
            document.addEventListener('mousemove', onMouseMove);

            // Start animation
            animate();
        }

        function createLayerGeometry(index) {
            // Create different shapes for each layer
            switch(index) {
                case 0:
                    // Front layer - S shape approximation
                    const shape0 = new THREE.Shape();
                    shape0.moveTo(-0.8, 0.5);
                    shape0.quadraticCurveTo(-0.8, 0.8, -0.5, 0.8);
                    shape0.quadraticCurveTo(0.2, 0.8, 0.2, 0.3);
                    shape0.quadraticCurveTo(0.2, 0, -0.2, 0);
                    shape0.quadraticCurveTo(-0.5, 0, -0.5, -0.3);
                    shape0.quadraticCurveTo(-0.5, -0.8, 0.2, -0.8);
                    shape0.quadraticCurveTo(0.8, -0.8, 0.8, -0.5);
                    shape0.lineTo(0.5, -0.5);
                    shape0.quadraticCurveTo(0.5, -0.6, 0.2, -0.6);
                    shape0.quadraticCurveTo(-0.2, -0.6, -0.2, -0.3);
                    shape0.quadraticCurveTo(-0.2, 0.2, 0.2, 0.2);
                    shape0.quadraticCurveTo(0.5, 0.2, 0.5, 0.5);
                    shape0.quadraticCurveTo(0.5, 0.6, 0.2, 0.6);
                    shape0.lineTo(-0.5, 0.6);
                    shape0.quadraticCurveTo(-0.6, 0.6, -0.6, 0.5);
                    shape0.closePath();
                    return new THREE.ExtrudeGeometry(shape0, {
                        depth: 0.2,
                        bevelEnabled: true,
                        bevelThickness: 0.05,
                        bevelSize: 0.05,
                        bevelSegments: 2
                    });
                    
                case 1:
                    // Circle for second layer
                    return new THREE.CylinderGeometry(0.8, 0.8, 0.2, 32);
                    
                case 2:
                    // Square for third layer
                    return new THREE.BoxGeometry(1.4, 1.4, 0.2);
                    
                case 3:
                    // Larger circle for back layer
                    return new THREE.CylinderGeometry(1, 1, 0.2, 32);
                    
                default:
                    return new THREE.BoxGeometry(1, 1, 0.2);
            }
        }

        function onMouseMove(event) {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function animate() {
            requestAnimationFrame(animate);

            // Smooth mouse following
            targetX += (mouseX - targetX) * 0.05;
            targetY += (mouseY - targetY) * 0.05;

            // Rotate logo group based on mouse
            logoGroup.rotation.y = targetX * 0.5;
            logoGroup.rotation.x = targetY * 0.3;

            // Individual layer animations
            layers.forEach((layer, index) => {
                // Rotation animation
                layer.rotation.z += (0.005 + index * 0.002) * (index % 2 === 0 ? 1 : -1);
                
                // Floating animation
                layer.position.y = Math.sin(Date.now() * 0.001 + index) * 0.05;
                layer.position.x = Math.cos(Date.now() * 0.0008 + index) * 0.03;
                
                // Scale pulsing
                const scale = 1 + Math.sin(Date.now() * 0.001 + index * 0.5) * 0.03;
                layer.scale.set(scale, scale, 1);
            });

            renderer.render(scene, camera);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Three.js logo
            init3DLogo();
            
            // Show notification badge after 3 seconds
            setTimeout(() => {
                document.getElementById('notificationBadge').classList.remove('hidden');
            }, 3000);
        });
    </script>
</body>
</html>